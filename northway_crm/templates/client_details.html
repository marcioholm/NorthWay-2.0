{% extends "base.html" %}
{% from "macros.html" import user_avatar %}

{% block content %}
<div class="flex-1 h-screen overflow-y-auto bg-gray-100 p-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('main.clients') }}"
                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-500 hover:text-northway-red hover:bg-red-50 transition-colors shadow-sm">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-3xl font-bold text-gray-900">{{ client.name }}</h1>
                        <span class="px-3 py-1 rounded-full text-sm font-medium
                            {% if client.status == 'ativo' %} bg-green-100 text-green-800
                            {% elif client.status == 'onboarding' %} bg-blue-100 text-blue-800
                            {% elif client.status == 'cancelado' %} bg-red-100 text-red-800
                            {% else %} bg-gray-100 text-gray-800
                            {% endif %}">
                            {{ client.status|upper }}
                        </span>

                        <!-- Health Status -->
                        {% if client.health_status == 'verde' %}
                        <span title="Saúde: Bom" class="w-3 h-3 rounded-full bg-green-500 ring-2 ring-green-100"></span>
                        {% elif client.health_status == 'amarelo' %}
                        <span title="Saúde: Atenção"
                            class="w-3 h-3 rounded-full bg-yellow-500 ring-2 ring-yellow-100"></span>
                        {% elif client.health_status == 'vermelho' %}
                        <span title="Saúde: Crítico" class="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-100"></span>
                        {% endif %}
                    </div>
                    <p class="text-gray-500 mt-1">Clientes > {{ client.name }}</p>
                </div>
            </div>

            {% if current_user.role in ['admin', 'manager'] %}
            <!-- Renewal Alert -->
            {% if client.renewal_date %}
            {% set days_left = (client.renewal_date - today).days %}
            {% if days_left <= 30 %} <div
                class="mb-6 p-4 rounded-lg flex items-center justify-between shadow-sm border {{ 'bg-red-50 border-red-200' if days_left < 0 else 'bg-orange-50 border-orange-200' }}">
                <div class="flex items-center gap-3">
                    <div
                        class="p-2 rounded-full {{ 'bg-red-100 text-red-600' if days_left < 0 else 'bg-orange-100 text-orange-600' }}">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-bold {{ 'text-red-900' if days_left < 0 else 'text-orange-900' }}">
                            {% if days_left < 0 %} Renovação Vencida! {% else %} Renovação Próxima {% endif %} </h3>
                                <p class="{{ 'text-red-700' if days_left < 0 else 'text-orange-700' }}">
                                    O contrato vence em <strong>{{ client.renewal_date.strftime('%d/%m/%Y') }}</strong>.
                                    {% if days_left < 0 %} (Atrasado há {{ days_left|abs }} dias) {% else %} (Faltam {{
                                        days_left }} dias) {% endif %} </p>
                    </div>
                </div>
                <button onclick="toggleModal('taskModal')"
                    class="px-4 py-2 rounded-lg font-bold shadow-sm transition-colors {{ 'bg-northway-red text-white hover:bg-red-700' if days_left < 0 else 'bg-orange-500 text-white hover:bg-orange-600' }}">
                    Agendar Contato
                </button>
        </div>
        {% endif %}
        {% endif %}

        <a href="{{ url_for('main.new_contract', id=client.id) }}"
            class="bg-[#fa0102] text-white border border-[#fa0102] px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
            <i data-lucide="file-signature" class="w-4 h-4"></i>
            <span>Emitir Contrato</span>
        </a>
        <div id="topEditActions">
            <button onclick="startEditMode()" id="topEditBtn"
                class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="pencil" class="w-4 h-4"></i>
                <span>Editar Dados</span>
            </button>
            <div id="saveCancelBtns" class="hidden flex items-center gap-2">
                <button onclick="cancelEditMode()"
                    class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    <span>Cancelar</span>
                </button>
                <button onclick="saveClientForm()"
                    class="bg-[#fa0102] text-white border border-[#fa0102] px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span>Salvar Alterações</span>
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <form action="{{ url_for('main.update_client', id=client.id) }}" method="POST" id="clientForm">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Info Column -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Registration Data Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <!-- Tabs -->
                    <!-- Modern Tabs -->
                    <div class="px-6 pt-6 pb-2 border-b border-gray-100 bg-white">
                        <div class="inline-flex bg-gray-100/80 p-1 rounded-xl gap-1">
                            <button type="button" onclick="switchClientTab('details')" id="tab-client-details"
                                class="px-4 py-2 text-sm font-bold text-gray-700 bg-white shadow-sm rounded-lg transition-all flex items-center gap-2">
                                <i data-lucide="building-2" class="w-4 h-4"></i> Dados Cadastrais
                            </button>
                            <button type="button" onclick="switchClientTab('whatsapp')" id="tab-client-whatsapp"
                                class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 rounded-lg transition-all flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                            </button>
                            <button type="button" onclick="switchClientTab('financial')" id="tab-client-financial"
                                class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 rounded-lg transition-all flex items-center gap-2">
                                <i data-lucide="wallet" class="w-4 h-4"></i> Financeiro
                            </button>
                        </div>
                    </div>

                    <!-- Details Content -->
                    <div id="content-client-details" class="p-8">
                        <h3 class="hidden text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                            Dados Cadastrais
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">CNPJ
                                    /
                                    CPF</label>
                                <input type="text" name="document" value="{{ client.document or '' }}" disabled
                                    class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Email
                                    de
                                    Contato</label>
                                <input type="email" name="email_contact" value="{{ client.email_contact or '' }}"
                                    disabled
                                    class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Representante
                                    Legal</label>
                                <input type="text" name="representative" value="{{ client.representative or '' }}"
                                    disabled
                                    class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">CPF
                                    do
                                    Rep.</label>
                                <input type="text" name="representative_cpf"
                                    value="{{ client.representative_cpf or '' }}" disabled
                                    class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                            </div>
                        </div>

                        <!-- Address Split -->
                        <div class="space-y-4 pt-4 border-t border-gray-100">
                            <p class="text-xs font-bold text-gray-400 uppercase">Endereço</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">Rua</label>
                                    <input type="text" name="address_street" value="{{ client.address_street or '' }}"
                                        disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">Número</label>
                                    <input type="text" name="address_number" value="{{ client.address_number or '' }}"
                                        disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">Bairro</label>
                                    <input type="text" name="address_neighborhood"
                                        value="{{ client.address_neighborhood or '' }}" disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                                <div>
                                    <label
                                        class="block text-[10px] text-gray-400 font-medium mb-0.5">Complemento</label>
                                    <input type="text" placeholder="" disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">CEP</label>
                                    <input type="text" name="address_zip" value="{{ client.address_zip or '' }}"
                                        disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">Cidade</label>
                                    <input type="text" name="address_city" value="{{ client.address_city or '' }}"
                                        disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-400 font-medium mb-0.5">Estado</label>
                                    <input type="text" name="address_state" value="{{ client.address_state or '' }}"
                                        disabled
                                        class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-sm text-gray-900 focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600"
                                        maxlength="2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Details Content -->

                <!-- Financial Content -->
                <div id="content-client-financial" class="hidden p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            Extrato Financeiro
                        </h3>
                        <button onclick="toggleModal('manualChargeModal')"
                            class="bg-[#fa0102] text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Nova Cobrança
                        </button>
                    </div>

                    <!-- LTV Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div
                            class="bg-gray-50 rounded-lg p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-colors">
                            <div
                                class="absolute top-0 right-0 w-16 h-16 bg-green-100 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:bg-green-200 transition-colors">
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase relative z-10">Total Pago (LTV)</p>
                            <p class="text-2xl font-bold text-green-600 relative z-10">R$ {{
                                "%.2f"|format(total_paid)|replace('.', ',') }}</p>
                        </div>
                        <div
                            class="bg-gray-50 rounded-lg p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-colors">
                            <div
                                class="absolute top-0 right-0 w-16 h-16 bg-gray-200 rounded-bl-full -mr-8 -mt-8 opacity-50">
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase relative z-10">A Receber</p>
                            <p class="text-2xl font-bold text-gray-700 relative z-10">R$ {{
                                "%.2f"|format(total_pending)|replace('.', ',') }}</p>
                        </div>
                        <div
                            class="bg-gray-50 rounded-lg p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-colors">
                            <div
                                class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:bg-red-200 transition-colors">
                            </div>
                            <p class="text-xs font-bold text-gray-400 uppercase relative z-10">Vencido</p>
                            <p class="text-2xl font-bold text-red-600 relative z-10">R$ {{
                                "%.2f"|format(total_overdue)|replace('.', ',') }}</p>
                        </div>
                    </div>

                    <!-- Transaction List -->
                    <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Histórico de Cobranças</h4>
                    <div class="space-y-3">
                        {% if client_txs %}
                        {% for tx in client_txs %}
                        <div
                            class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:shadow-sm transition-all">
                            <div class="flex items-center gap-3">
                                <div class="bg-gray-50 p-2 rounded text-gray-500">
                                    <i data-lucide="{{ 'check-circle' if tx.status=='paid' else 'clock' }}"
                                        class="w-5 h-5 {{ 'text-green-500' if tx.status=='paid' else 'text-yellow-500' }}"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900 text-sm">{{ tx.description }}</p>
                                    <div class="flex gap-3 text-xs text-gray-500">
                                        <span>Vencimento: {{ tx.due_date.strftime('%d/%m/%Y') }}</span>
                                        {% if tx.created_at %}
                                        <span class="text-gray-400">• Gerada: {{ tx.created_at.strftime('%d/%m')
                                            }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-gray-900 text-sm">R$ {{ "%.2f"|format(tx.amount)|replace('.',
                                    ',') }}</p>
                                <span
                                    class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full 
                                    {{ 'bg-green-100 text-green-700' if tx.status == 'paid' else 
                                       ('bg-red-100 text-red-700' if tx.status == 'overdue' else 
                                       ('bg-gray-100 text-gray-600' if tx.status == 'cancelled' else 'bg-yellow-100 text-yellow-700')) }}">
                                    {{ 'PAGO' if tx.status == 'paid' else
                                    ('VENCIDO' if tx.status == 'overdue' else
                                    ('CANCELADO' if tx.status == 'cancelled' else 'PENDENTE')) }}
                                </span>
                            </div>
                            <div class="ml-4">
                                {% if tx.asaas_invoice_url %}
                                <a href="{{ tx.asaas_invoice_url }}" target="_blank"
                                    class="text-gray-400 hover:text-northway-red" title="Ver Boleto">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-gray-400 text-sm italic">Nenhuma cobrança registrada.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- WhatsApp Content -->
                <div id="content-client-whatsapp" class="hidden h-[500px] flex flex-col p-6">
                    <!-- Helper to know this client has a lead attached? Or direct link? -->
                    <!-- Ideally clients should have a phone. We use client.phone -->

                    <!-- Chat Area -->
                    <div id="client-chat-messages"
                        class="flex-1 overflow-y-auto space-y-4 p-4 bg-[#e5ddd5] rounded-t-lg border border-gray-200 border-b-0 bg-opacity-30">
                        <div class="flex justify-center">
                            <span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded-full">Carregando
                                histórico...</span>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <!-- Input Area (Standardized) -->
                    <div
                        class="bg-gray-50 p-3 border border-gray-200 border-t-0 rounded-b-lg flex flex-col gap-2 relative">
                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">

                        <!-- Attachment Menu (Absolute) -->
                        <div id="attach-menu"
                            class="hidden absolute bottom-20 left-4 bg-white shadow-xl rounded-lg flex flex-col w-40 overflow-hidden z-20 border border-gray-100">
                            <button onclick="triggerFile('image/*')"
                                class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700 border-b border-gray-50">
                                <i data-lucide="image" class="w-4 h-4 text-purple-500"></i> Fotos
                            </button>
                            <button onclick="triggerFile('*/*')"
                                class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700">
                                <i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i> Documento
                            </button>
                        </div>

                        <div class="flex items-end gap-2">
                            <!-- Default Toolbar -->
                            <div id="toolbar-default" class="flex-1 flex items-center gap-2">
                                <button id="btn-attach" onclick="toggleAttachMenu()"
                                    class="p-2 text-gray-500 hover:text-gray-700 transition-colors rounded-full hover:bg-gray-200">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>

                                <!-- Rich Text Toolbar (Mini) -->
                                <div class="hidden md:flex items-center gap-0.5 border-r border-gray-300 pr-2 mr-1">
                                    <button onclick="insertFormat('*')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="bold" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="insertFormat('_')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="italic" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="insertFormat('- ')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="list" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <div
                                    class="flex-1 bg-white rounded-lg border border-gray-300 focus-within:border-northway-red focus-within:ring-1 focus-within:ring-northway-red/20 transition-all overflow-hidden flex items-center px-4 py-2">
                                    <input type="text" id="message-input" placeholder="Mensagem"
                                        class="w-full bg-transparent border-none focus:outline-none text-sm text-gray-800 placeholder-gray-400"
                                        autocomplete="off">
                                </div>

                                <!-- Mic / Send Toggle -->
                                <button id="btn-mic" onclick="toggleRecording()"
                                    class="p-3 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors shadow-sm">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                                <button id="btn-send" onclick="sendMessage()"
                                    class="hidden p-3 bg-northway-red text-white rounded-full hover:bg-red-700 transition-colors shadow-sm">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- Recording UI -->
                            <div id="toolbar-recording"
                                class="flex-1 items-center gap-4 hidden px-4 py-2 bg-white rounded-lg border border-red-100">
                                <button onclick="cancelRecording()" class="text-gray-500 hover:text-red-500 p-2">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                                <div class="flex-1 flex items-center gap-3 justify-center">
                                    <span class="animate-pulse w-3 h-3 bg-red-500 rounded-full"></span>
                                    <span id="recording-time"
                                        class="text-gray-700 font-mono text-sm font-bold">0:00</span>
                                </div>
                                <button onclick="stopAndSendRecording()"
                                    class="text-green-500 hover:text-green-600 p-2">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- File Preview UI -->
                            <div id="toolbar-file"
                                class="flex-1 items-center gap-4 hidden bg-white rounded-lg px-4 py-2 border border-green-200">
                                <span class="text-gray-500"><i data-lucide="file" class="w-5 h-5 inline"></i></span>
                                <span id="file-name"
                                    class="flex-1 text-sm text-gray-700 truncate font-medium">arquivo.pdf</span>
                                <button onclick="cancelFile()" class="text-gray-400 hover:text-red-500 p-2">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                                <button onclick="sendFile()"
                                    class="text-green-600 hover:text-green-700 font-bold text-sm px-3">
                                    Enviar
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1 justify-center">
                            <i data-lucide="lock" class="w-3 h-3"></i> Mensagens protegidas e criptografadas de ponta a
                            ponta.
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-lucide="briefcase" class="w-5 h-5 text-northway-red"></i>
                    Detalhes do Contrato
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Serviço
                            Contratado</label>
                        <input type="text" name="service" value="{{ client.service }}" disabled
                            class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Nicho
                            de
                            Atuação</label>
                        <input type="text" name="niche" value="{{ client.niche or '' }}" disabled
                            placeholder="Ex: Escritório de Advocacia"
                            class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Tipo
                            de Contrato</label>
                        <select name="contract_type" disabled
                            class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:appearance-none disabled:bg-none">
                            <option value="mensal" {% if client.contract_type=='mensal' %}selected{% endif %}>
                                Mensal</option>
                            <option value="trimestral" {% if client.contract_type=='trimestral' %}selected{% endif %}>
                                Trimestral</option>
                            <option value="semestral" {% if client.contract_type=='semestral' %}selected{% endif %}>
                                Semestral</option>
                            <option value="anual" {% if client.contract_type=='anual' %}selected{% endif %}>
                                Anual</option>
                            <option value="pontual" {% if client.contract_type=='pontual' %}selected{% endif %}>
                                Pontual</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Valor
                            Mensal</label>
                        <div class="flex items-center">
                            <span class="text-gray-500 mr-1">R$</span>
                            <input type="number" step="0.01" name="monthly_value" value="{{ client.monthly_value }}"
                                disabled
                                class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:text-gray-600">
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Status</label>
                        <select name="status" disabled
                            class="w-full bg-transparent border-b border-dashed border-gray-300 py-1 text-gray-900 font-medium focus:outline-none focus:border-northway-red disabled:border-none disabled:appearance-none disabled:bg-none">
                            <option value="onboarding" {% if client.status=='onboarding' %}selected{% endif %}>
                                Onboarding</option>
                            <option value="ativo" {% if client.status=='ativo' %}selected{% endif %}>Ativo
                            </option>
                            <option value="pausado" {% if client.status=='pausado' %}selected{% endif %}>Pausado
                            </option>
                            <option value="cancelado" {% if client.status=='cancelado' %}selected{% endif %}>
                                Cancelado</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Saúde
                            do Cliente <span
                                class="text-[9px] text-gray-400 font-normal ml-1">(Automático)</span></label>
                        <div
                            class="py-1 text-gray-900 font-medium flex items-center gap-2 border-b border-gray-300 border-dashed">
                            {% if client.health_status == 'verde' %}
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span>Bom (< 3 dias)</span>
                                    {% elif client.health_status == 'amarelo' %}
                                    <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                    <span>Atenção (4-7 dias)</span>
                                    {% else %}
                                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                    <span>Crítico (> 7 dias)</span>
                                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Issued Contracts List -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-lucide="scroll-text" class="w-5 h-5 text-gray-400"></i>
                    Contratos Emitidos
                </h3>
                <div class="space-y-3">
                    {% if client.contracts %}
                    {% for contract in client.contracts|sort(attribute='created_at', reverse=True) %}
                    <div
                        class="flex items-center justify-between p-3 bg-gray-50 rounded-lg group hover:bg-white border border-transparent hover:border-gray-200 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded shadow-sm">
                                <i data-lucide="{{ 'file-edit' if contract.status == 'draft' else ('ban' if contract.status == 'terminated' else 'file-check') }}"
                                    class="w-5 h-5 {{ 'text-yellow-500' if contract.status == 'draft' else ('text-red-500' if contract.status == 'terminated' else 'text-green-600') }}"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ contract.template.name }}</p>
                                <p class="text-xs text-gray-500 flex items-center gap-1">
                                    {% if contract.code %}
                                    <span class="font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{
                                        contract.code }}</span>
                                    {% else %}
                                    <span class="font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">#{{
                                        contract.id }}</span>
                                    {% endif %}
                                    <span>•</span>
                                    {{ contract.created_at.strftime('%d/%m/%Y') }}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span
                                class="px-2 py-1 {{ 'bg-yellow-100 text-yellow-700' if contract.status == 'draft' else ('bg-blue-100 text-blue-700' if contract.status == 'issued' else ('bg-red-100 text-red-700' if contract.status == 'terminated' else 'bg-green-100 text-green-700')) }} rounded text-xs font-medium uppercase">
                                {{ 'Rascunho' if contract.status == 'draft' else ('Emitido' if contract.status
                                ==
                                'issued' else ('Rescindido' if contract.status == 'terminated' else 'Assinado'))
                                }}
                                <!-- UPDATED BADGE -->
                            </span>

                            {% if contract.status == 'draft' %}
                            <a href="{{ url_for('main.resume_contract', id=contract.id) }}"
                                class="p-2 text-gray-400 hover:text-northway-red transition-colors"
                                title="Retomar Edição">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </a>
                            {% else %}
                            <div class="flex items-center">
                                {% if contract.status == 'issued' %}
                                <button type="button" onclick="signContract('{{ contract.id }}')"
                                    class="p-2 text-green-600 hover:text-green-800 transition-colors"
                                    title="Confirmar Assinatura (Gerar Financeiro)">
                                    <i data-lucide="pen-tool" class="w-4 h-4"></i>
                                </button>
                                {% endif %}

                                <!-- TERMINATION BUTTON ADDED -->
                                {% if contract.status == 'signed' %}
                                <button type="button" data-id="{{ contract.id }}"
                                    data-name="{{ contract.template.name }}"
                                    onclick="openTerminationModal(this.dataset.id, this.dataset.name)"
                                    class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                    title="Rescindir Contrato">
                                    <i data-lucide="ban" class="w-4 h-4"></i>
                                </button>
                                {% endif %}

                                <a href="{{ url_for('main.view_contract', id=contract.id) }}" target="_blank"
                                    class="p-2 text-gray-400 hover:text-northway-red transition-colors"
                                    title="Visualizar">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </a>
                                <a href="{{ url_for('main.view_contract', id=contract.id) }}?print=true" target="_blank"
                                    class="p-2 text-gray-400 hover:text-northway-red transition-colors"
                                    title="Baixar PDF">
                                    <i data-lucide="file-down" class="w-4 h-4"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-sm text-gray-400 italic">Nenhum contrato emitido.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Notes Card -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-gray-400"></i>
                    Observações
                </h3>
                <textarea name="notes" rows="4" disabled
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red disabled:bg-gray-50 disabled:border-gray-100 disabled:resize-none">{{ client.notes or '' }}</textarea>
            </div>

            <!-- Tasks Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="check-square" class="w-5 h-5 text-gray-400"></i>
                        Tarefas
                    </h3>
                    <button type="button" onclick="toggleModal('taskModal')"
                        class="text-[#fa0102] hover:bg-red-50 p-2 rounded-full transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="space-y-2">
                    {% for task in client.tasks|sort(attribute='status', reverse=True) %}
                    <div
                        class="flex items-start gap-3 p-3 rounded-lg border {{ 'border-green-100 bg-green-50' if task.status == 'concluida' else 'border-gray-100 bg-gray-50' }} group hover:border-gray-200 transition-colors">
                        <form action="{{ url_for('main.toggle_task', id=task.id) }}" method="POST">
                            <button type="submit"
                                class="mt-0.5 {{ 'text-green-500' if task.status == 'concluida' else 'text-gray-300 hover:text-green-500' }} transition-colors">
                                <i data-lucide="{{ 'check-circle' if task.status == 'concluida' else 'circle' }}"
                                    class="w-5 h-5"></i>
                            </button>
                        </form>
                        <div class="flex-1 min-w-0">
                            <div
                                class="text-sm font-medium {{ 'text-gray-500 line-through' if task.status == 'concluida' else 'text-gray-900' }} truncate">
                                {{ task.title }}</div>
                            <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                {% if task.due_date %}
                                <span
                                    class="flex items-center gap-1 {{ 'text-red-500 font-bold' if task.due_date < now and task.status != 'concluida' else '' }}">
                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                    {{ task.due_date.strftime('%d/%m %H:%M') }}
                                </span>
                                {% endif %}
                                {% if task.responsible %}
                                <div class="flex items-center gap-1 ml-2">
                                    {{ user_avatar(task.responsible, size='sm', show_name=True) }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-400 italic">Nenhuma tarefa encontrada.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Processes / Checklists Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-5 h-5 text-gray-400"></i>
                    Processos & Serviços
                </h3>
                <button type="button" onclick="toggleModal('addProcessModal')"
                    class="text-northway-red hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors font-bold text-sm flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Adicionar Processo
                </button>
            </div>

            <div class="space-y-4">
                {% for checklist in client.checklists|sort(attribute='created_at', reverse=True) %}
                <div class="border border-gray-200 rounded-xl overflow-hidden process-card">
                    <!-- Header / Summary -->
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors"
                        onclick="toggleProcess('{{ checklist.id }}')">
                        <div class="flex items-center gap-3">
                            <div class="circular-chart-xs" data-percent="{{ checklist.percent or 0 }}">
                                <!-- Computed in JS or Backend. For MVP, we calculate on toggle -->
                                <svg viewBox="0 0 36 36" class="w-8 h-8 transform -rotate-90">
                                    <path class="text-gray-200"
                                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none" stroke="currentColor" stroke-width="4" />
                                    <path class="text-northway-red progress-ring" stroke-dasharray="0, 100"
                                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none" stroke="currentColor" stroke-width="4"
                                        id="ring-{{ checklist.id }}" />
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900">{{ checklist.name }}</h4>
                                <p class="text-xs text-gray-500">Iniciado em {{
                                    checklist.created_at.strftime('%d/%m/%Y') }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"
                                id="arrow-{{ checklist.id }}"></i>
                        </div>
                    </div>

                    <!-- Expanded Content -->
                    <div id="process-content-{{ checklist.id }}"
                        class="hidden border-t border-gray-200 bg-white p-4 space-y-6">
                        {% for step in checklist.progress %}
                        {% set step_index = loop.index0 %}
                        <div class="step-group">
                            <h5
                                class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 pl-1 border-l-4 border-northway-red/20 py-0.5">
                                {{ step.title }}</h5>
                            <div class="space-y-2 pl-2">
                                {% for item in step['items'] %}
                                <label
                                    class="flex items-start gap-3 group cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                    <input type="checkbox"
                                        onchange="toggleChecklistItem('{{ checklist.id }}', '{{ loop.index0 }}', '{{ step_index }}', this)"
                                        {% if item.done %}checked{% endif %}
                                        class="mt-1 w-4 h-4 text-northway-red border-gray-300 rounded focus:ring-northway-red cursor-pointer">
                                    <span
                                        class="text-sm text-gray-700 group-hover:text-gray-900 {{ 'line-through text-gray-400' if item.done else '' }} item-text">{{
                                        item.text }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        <div class="pt-4 border-t border-gray-100 flex justify-end">
                            <button type="button" onclick="deleteChecklist('{{ checklist.id }}')"
                                class="text-xs text-red-500 hover:text-red-700 underline">Excluir
                                Processo</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-sm text-gray-400 italic text-center py-4">Nenhum processo ativo para este
                    cliente.
                </p>
                {% endfor %}
            </div>
        </div>
        <div class="pt-6 border-t border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">Histórico</h3>
                <button type="button" onclick="toggleModal('interactionModal')"
                    class="text-[#fa0102] hover:bg-red-50 p-2 rounded-full transition-colors">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                </button>
            </div>

            <div
                class="space-y-6 relative before:absolute before:inset-0 before:ml-5 before:h-full before:w-0.5 before:bg-gray-200">
                {% for interaction in client.interactions|sort(attribute='created_at', reverse=True) %}
                <div class="relative flex gap-6 group is-active">
                    <!-- Icon -->
                    <div
                        class="absolute left-0 mt-1 flex items-center justify-center w-10 h-10 rounded-full border-4 border-white bg-gray-50 shadow-sm shrink-0 z-10 transition-transform group-hover:scale-110">
                        {% if interaction.type == 'reuniao' %}
                        <i data-lucide="users" class="w-4 h-4 text-blue-500"></i>
                        {% elif interaction.type == 'ajuste' %}
                        <i data-lucide="settings" class="w-4 h-4 text-orange-500"></i>
                        {% elif interaction.type == 'feedback' %}
                        <i data-lucide="message-circle" class="w-4 h-4 text-green-500"></i>
                        {% elif interaction.type == 'tarefa_criada' %}
                        <i data-lucide="plus-square" class="w-4 h-4 text-purple-500"></i>
                        {% elif interaction.type == 'tarefa_concluida' %}
                        <i data-lucide="check-square" class="w-4 h-4 text-green-600"></i>
                        {% else %}
                        <i data-lucide="sticky-note" class="w-4 h-4 text-gray-500"></i>
                        {% endif %}
                    </div>

                    <!-- Content -->
                    <div
                        class="ml-12 flex-1 bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-gray-900 text-sm flex items-center gap-2">
                                {% if interaction.user %}
                                {{ interaction.user.name }}
                                {% else %}
                                <span
                                    class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] uppercase">Sistema</span>
                                {% endif %}
                            </span>
                            <time class="font-mono text-xs text-gray-400">{{ interaction.created_at.strftime('%d/%m/%Y
                                %H:%M') }}</time>
                        </div>
                        <div
                            class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 border-b border-gray-50 pb-1">
                            {{ interaction.type|replace('_', ' ') }}</div>
                        <p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line">{{ interaction.content }}
                        </p>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-gray-400 text-sm py-4 ml-10">
                    Nenhuma interação registrada.
                </div>
                {% endfor %}
            </div>
        </div>

</div>

<!-- Sidebar Info Column -->
<div class="space-y-6">

    <!-- Management Card -->
    <!-- Management Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">Gestão da Conta</h3>
            <i data-lucide="briefcase" class="w-4 h-4 text-gray-400"></i>
        </div>

        <div class="p-6 space-y-6">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Gerente
                    de Conta</label>
                {% if client.account_manager %}
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div
                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-xs font-bold text-gray-600 overflow-hidden ring-1 ring-gray-200 shadow-sm">
                        {% if client.account_manager.profile_image %}
                        <img src="{{ url_for('static', filename='uploads/profiles/' + client.account_manager.profile_image) }}"
                            alt="{{ client.account_manager.name }}" class="w-full h-full object-cover">
                        {% else %}
                        {{ client.account_manager.name[:2].upper() }}
                        {% endif %}
                    </div>
                    <div>
                        <p class="font-bold text-gray-900 text-sm">{{ client.account_manager.name }}</p>
                        <p class="text-xs text-gray-500">{{ client.account_manager.status_message or
                            'Gerente' }}</p>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm italic">Não atribuído</p>
                {% endif %}
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Início</label>
                    <div
                        class="text-sm font-medium text-gray-900 bg-gray-50 px-3 py-2 rounded-lg border border-gray-100">
                        {{ client.start_date.strftime('%d/%m/%Y') if client.start_date else '-' }}
                    </div>
                </div>
                <div>
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 text-[#fa0102]">Renovação</label>
                    <div class="text-sm font-medium text-gray-900 bg-red-50 px-3 py-2 rounded-lg border border-red-100">
                        {{ client.renewal_date.strftime('%d/%m/%Y') if client.renewal_date else '-' }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Info -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Contato</h3>
        <div class="space-y-3">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                </div>
                <div class="text-sm truncate" title="{{ client.email }}">{{ client.email }}</div>
            </div>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                    <i data-lucide="phone" class="w-4 h-4"></i>
                </div>
                <div class="text-sm">{{ client.phone or '-' }}</div>
            </div>
        </div>
    </div>

    <!-- Save Actions (Hidden by default) -->
    <div id="editActions" class="hidden">
        <button type="submit"
            class="w-full bg-[#fa0102] text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg">
            Salvar Alterações
        </button>
        <button type="button" onclick="toggleEditMode()"
            class="w-full mt-2 bg-transparent text-gray-500 py-2 rounded-lg font-medium hover:text-gray-700">
            Cancelar
        </button>
    </div>

</div>
</div>
</form>
</div>




<!-- Manual Charge Modal -->
<div id="manualChargeModal"
    class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                <i data-lucide="wallet" class="w-5 h-5 text-northway-red"></i> Nova Cobrança Avulsa
            </h3>
            <button onclick="toggleModal('manualChargeModal')" class="text-gray-400 hover:text-gray-600"><i
                    data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <form onsubmit="handleManualCharge(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                    <input type="text" name="description" placeholder="Ex: Consultoria Extra" required
                        class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor</label>
                        <input type="text" name="amount" placeholder="R$ 0,00" required
                            class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Vencimento</label>
                        <input type="date" name="due_date" required
                            class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('manualChargeModal')"
                        class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg text-sm font-bold">Cancelar</button>
                    <button type="submit"
                        class="px-4 py-2 bg-northway-red text-white rounded-lg text-sm font-bold shadow-md hover:bg-red-700">Gerar
                        Cobrança</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    async function handleManualCharge(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const btn = form.querySelector('button[type="submit"]');

        try {
            btn.disabled = true;
            btn.innerHTML = 'Gerando...';

            const res = await fetch(`/clients/{{ client.id }}/charges/new`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (err) {
            alert('Erro ao conectar com servidor.');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Gerar Cobrança';
        }
    }
</script>
</div>

<!-- Termination Modal -->
<!-- Termination Modal -->
<div id="termination-modal"
    class="hidden fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                <h3 class="text-lg font-bold text-gray-900">Rescindir Contrato</h3>
            </div>
            <button type="button" onclick="closeTerminationModal()"
                class="text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form onsubmit="submitTermination(event)" class="space-y-4">
            <input type="hidden" id="term-contract-id">

            <div class="bg-red-50 p-3 rounded-lg border border-red-100 mb-4">
                <p class="text-sm text-red-800">
                    Você está prestes a rescindir o contrato de <strong id="term-contract-title"></strong>.
                    <br>
                    <span class="text-xs opacity-75">Cobranças futuras e agendamentos serão cancelados.</span>
                </p>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Motivo da Rescisão <span
                        class="text-red-500">*</span></label>
                <textarea id="term-reason" rows="3"
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                    placeholder="Descreva o motivo do cancelamento..." required></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Multa (Opcional)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500 text-sm">R$</span>
                        <input type="text" id="term-penalty" oninput="formatCurrency(this)"
                            class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent font-bold text-gray-900"
                            placeholder="0,00">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Vencimento</label>
                    <input type="date" id="term-due-date"
                        class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm font-medium text-gray-700">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeTerminationModal()"
                    class="flex-1 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">Cancelar</button>
                <button type="submit"
                    class="flex-1 py-2.5 bg-northway-red text-white font-bold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="ban" class="w-4 h-4"></i>
                    Confirmar Rescisão
                </button>
            </div>
        </form>
    </div>
</div>
</div>
</div>
</div>

<!-- Add Process Modal -->
<div id="addProcessModal" class="hidden fixed inset-0 bg-gray-900/50 z-50 items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900">Iniciar Novo Processo</h3>
            <button onclick="toggleModal('addProcessModal')" class="text-gray-400 hover:text-gray-600"><i
                    data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <form action="{{ url_for('main.add_client_process', client_id=client.id) }}" method="POST">
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Selecione o
                    Modelo</label>
                <select name="template_id" required
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                    <option value="">Escolha um fluxo...</option>
                    {% for tpl in process_templates %}
                    <option value="{{ tpl.id }}">{{ tpl.name }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-2">Você pode criar novos modelos em Configurações.</p>
            </div>

            <button type="submit"
                class="w-full bg-northway-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-500/20">
                Iniciar Processo
            </button>
        </form>
    </div>
</div>

<script>
    function startEditMode() {
        const form = document.getElementById('clientForm');
        const inputs = form.querySelectorAll('input, select, textarea');

        // Buttons
        const topEditBtn = document.getElementById('topEditBtn');
        const saveCancelBtns = document.getElementById('saveCancelBtns');

        // Enable inputs
        inputs.forEach(input => {
            input.disabled = false;
            input.classList.remove('disabled:border-none');
            input.classList.add('border-gray-300');
        });

        // Toggle Buttons
        topEditBtn.classList.add('hidden');
        saveCancelBtns.classList.remove('hidden');
    }

    function cancelEditMode() {
        // Simple reload to discard changes or just disable? 
        // Reload is safer to revert data.
        if (confirm("Deseja cancelar a edição? As alterações não salvas serão perdidas.")) {
            location.reload();
        }
    }

    function saveClientForm() {
        document.getElementById('clientForm').submit();
    }

    // Termination Functions
    function openTerminationModal(id, title) {
        document.getElementById('term-contract-id').value = id;
        document.getElementById('term-contract-title').textContent = title;
        document.getElementById('term-due-date').valueAsDate = new Date(); // Default to today
        document.getElementById('termination-modal').classList.remove('hidden');
        document.getElementById('termination-modal').classList.add('flex');
    }

    function closeTerminationModal() {
        document.getElementById('termination-modal').classList.add('hidden');
        document.getElementById('termination-modal').classList.remove('flex');
    }

    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2) + '';
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        input.value = "R$ " + value;
    }

    async function submitTermination(e) {
        e.preventDefault();
        if (!confirm("Tem certeza que deseja rescindir este contrato? Esta ação não pode ser desfeita.")) return;

        const id = document.getElementById('term-contract-id').value;
        const reason = document.getElementById('term-reason').value;
        // Parse currency string: "R$ 1.234,56" -> 1234.56
        const penaltyStr = document.getElementById('term-penalty').value;
        const penalty = penaltyStr ? parseFloat(penaltyStr.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
        const dueDate = document.getElementById('term-due-date').value;

        try {
            const res = await fetch(`/contracts/${id}/terminate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason, penalty, due_date: dueDate })
            });
            const data = await res.json();

            if (res.ok) {
                window.location.reload();
            } else {
                alert("Erro: " + (data.message || "Erro desconhecido"));
            }
        } catch (e) {
            console.error(e);
            alert("Erro de conexão.");
        }
    }

    // Process Checklist Logic
    function toggleProcess(id) {
        const content = document.getElementById(`process-content-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            arrow.classList.add('rotate-180');
            // Re-calculate progress visual on open
            updateProgressVisual(id);
        } else {
            content.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    async function toggleChecklistItem(checklistId, itemIndex, stepIndex, checkbox) {
        const textSpan = checkbox.nextElementSibling;

        // Optimistic UI
        if (checkbox.checked) {
            textSpan.classList.add('line-through', 'text-gray-400');
        } else {
            textSpan.classList.remove('line-through', 'text-gray-400');
        }

        try {
            const res = await fetch(`/api/checklists/${checklistId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step_index: stepIndex,
                    item_index: itemIndex,
                    done: checkbox.checked
                })
            });
            const data = await res.json();
            if (data.success) {
                // Update specific ring
                const ring = document.getElementById(`ring-${checklistId}`);
                ring.setAttribute('stroke-dasharray', `${data.percent}, 100`);
            } else {
                throw new Error(data.error || "Erro no servidor ao salvar.");
            }
        } catch (e) {
            console.error(e);
            alert("Erro ao salvar progresso: " + e.message);
            checkbox.checked = !checkbox.checked; // Revert
        }
    }

    // Initial load progress bars
    document.addEventListener("DOMContentLoaded", () => {
        // Loop through all checklists and set initial progress if needed
        // But actually the backend sends the full object, I just need to compute percentages initialy if I want
        // Simpler: Just rely on toggle updates or pre-calculate in Jinja loop if possible. 
        // For now, let's just calc on load.
        document.querySelectorAll('.process-card').forEach(card => {
            const checkboxes = card.querySelectorAll('input[type="checkbox"]');
            const total = checkboxes.length;
            const checked = Array.from(checkboxes).filter(c => c.checked).length;
            const percent = total === 0 ? 0 : (checked / total * 100);
            const ring = card.querySelector('.progress-ring');
            if (ring) ring.setAttribute('stroke-dasharray', `${percent}, 100`);
        });
    });

    function deleteChecklist(id) {
        if (confirm("Tem certeza que deseja remover este processo? Todo o histórico será perdido.")) {
            fetch(`/api/checklists/${id}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) window.location.reload();
                });
        }
    }
</script>

<!-- New Interaction Modal and Task Modal -->
{% include "macros_modals.html" ignore missing %}
<!-- Fallback if macros not split, keeping original modals inline if needed. 
     Since I cannot check macros_modals, I will paste the original modals back to be safe. 
-->

<!-- New Interaction Modal (Original) -->
<div id="interactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Interação</h3>
            <button onclick="toggleModal('interactionModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('main.add_client_interaction', id=client.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select name="type"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                    <option value="nota">Nota</option>
                    <option value="reuniao">Reunião</option>
                    <option value="ajuste">Ajuste / Suporte</option>
                    <option value="feedback">Feedback</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Conteúdo</label>
                <textarea name="content" rows="4" placeholder="Descreva o que houve..." required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red"></textarea>
            </div>

            <div class="pt-2 flex gap-3">
                <button type="button" onclick="toggleModal('interactionModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Registrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Task Modal (Original) -->
<div id="taskModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Tarefa</h3>
            <button onclick="toggleModal('taskModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('main.add_client_task', id=client.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                <input type="text" name="title" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data/Hora</label>
                    <input type="datetime-local" name="due_date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                    <select name="responsible_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if current_user.id==user.id %}selected{% endif %}>{{ user.name
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" name="is_recurring" id="is_recurring" value="1"
                    class="w-4 h-4 text-northway-red border-gray-300 rounded focus:ring-northway-red">
                <label for="is_recurring" class="text-sm text-gray-700 flex items-center gap-1">
                    <i data-lucide="repeat" class="w-4 h-4 text-gray-500"></i>
                    Repetir mensalmente
                </label>
            </div>

            <div class="pt-2 flex gap-3">
                <button type="button" onclick="toggleModal('taskModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Criar Tarefa
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleModal(id) {
        const modal = document.getElementById(id);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    async function signContract(id) {
        if (!confirm("Confirmar que o contrato foi assinado? Isso irá gerar as parcelas financeiras automaticamente.")) return;

        try {
            const res = await fetch(`/contracts/${id}/sign`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert("Erro: " + (data.error || "Desconhecido"));
            }
        } catch (e) {
            alert("Erro de conexão ao servidor.");
            console.error(e);
        }
    }

    // --- WhatsApp Logic (Client) ---
    const pageClientId = parseInt("{{ client.id }}");

    function switchClientTab(tabName) {
        try {
            const tabs = ['details', 'whatsapp', 'financial'];

            // Hide all contents
            tabs.forEach(t => {
                const content = document.getElementById(`content-client-${t}`);
                if (content) {
                    content.classList.add('hidden');
                    if (t === 'whatsapp') content.classList.remove('flex'); // Specific fix for whatsapp flex container
                }
            });

            // Show selected content
            const selectedContent = document.getElementById(`content-client-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                if (tabName === 'whatsapp') selectedContent.classList.add('flex');
            }

            // Update Tab Styles
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-client-${t}`);
                if (btn) {
                    if (t === tabName) {
                        // Active Pill
                        btn.className = "px-4 py-2 text-sm font-bold text-gray-900 bg-white shadow-sm rounded-lg transition-all flex items-center gap-2 transform scale-105 ring-1 ring-black/5";
                    } else {
                        // Inactive
                        btn.className = "px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 rounded-lg transition-all flex items-center gap-2 hover:bg-white/60";
                    }
                }
            });

            // Load logic
            if (tabName === 'whatsapp') {
                loadClientWhatsAppMessages();
            }

        } catch (e) {
            console.error("Error switching tab:", e);
        }
    }

    async function loadClientWhatsAppMessages(silent = false) {
        const container = document.getElementById('client-chat-messages');
        if (!silent) {
            container.innerHTML = `<div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div></div>`;
        }

        try {
            const response = await fetch(`/api/whatsapp/client/${pageClientId}/messages`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            if (data.messages.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <i data-lucide="message-square" class="w-10 h-10 mb-2 opacity-50"></i>
                        <p class="text-sm">Nenhuma mensagem ainda.</p>
                        <p class="text-xs">Inicie a conversa abaixo.</p>
                    </div>
                 `;
            } else {
                let lastDate = null;
                const messagesHtml = data.messages.map(msg => {
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = msgDate.toLocaleDateString('pt-BR');
                    let dateHeader = '';

                    if (dateStr !== lastDate) {
                        lastDate = dateStr;
                        dateHeader = `
                            <div class="flex justify-center my-4">
                                <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded shadow-sm font-medium">
                                    ${dateStr}
                                </span>
                            </div>`;
                    }

                    return `
                    ${dateHeader}
                    <div class="flex ${msg.direction === 'out' ? 'justify-end' : 'justify-start'} mb-1 group">
                        <div class="max-w-[75%] rounded-lg px-3 py-1.5 text-sm shadow-sm relative leading-relaxed ${msg.direction === 'out'
                            ? 'bg-northway-red text-white rounded-tr-none shadow-md'
                            : 'bg-white text-gray-900 rounded-tl-none'
                        }">
                            <p>${msg.content}</p>
                            <div class="flex justify-end items-center gap-1 -mt-0.5">
                                <span class="text-[10px] text-gray-500">${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                ${msg.direction === 'out' ?
                            (msg.status === 'read' ? '<i data-lucide="check-check" class="w-3 h-3 text-[#53bdeb]"></i>' :
                                msg.status === 'delivered' ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>' :
                                    '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>')
                            : ''}
                            </div>
                            
                        </div>
                    </div>
                `}).join('');
                container.innerHTML = messagesHtml;
                container.scrollTop = container.scrollHeight;
            }
            if (window.lucide) lucide.createIcons();
        } catch (e) {
            container.innerHTML = `<p class="text-center text-red-500 text-xs">Erro ao carregar: ${e.message}</p>`;
        }
    }

    // --- MEDIA & PORTED LOGIC (Client) ---
    const activeChat = { type: 'client', id: pageClientId };

    function loadMessages(type, id) {
        // Wrapper for existing loader
        return loadClientWhatsAppMessages(true);
    }

    // Media Vars
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let selectedFile = null;

    // UI Toggles
    const inputArea = document.getElementById('message-input');
    const btnMic = document.getElementById('btn-mic');
    const btnSend = document.getElementById('btn-send');

    // Auto-switch Mic/Send icon
    if (inputArea) {
        inputArea.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                btnMic.classList.add('hidden');
                btnSend.classList.remove('hidden');
            } else {
                btnMic.classList.remove('hidden');
                btnSend.classList.add('hidden');
            }
        });

        // Handle Enter
        inputArea.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // Toggle Attach Menu
    function toggleAttachMenu() {
        const menu = document.getElementById('attach-menu');
        menu.classList.toggle('hidden');
    }

    // Recording Logic
    async function toggleRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert('Seu navegador não suporta gravação de áudio.');
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.start();

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex'); // Important for flex layout
            document.getElementById('toolbar-recording').classList.remove('hidden');
            document.getElementById('toolbar-recording').classList.add('flex');

            // Timer
            let seconds = 0;
            const timerEl = document.getElementById('recording-time');
            timerEl.textContent = "0:00";
            if (recordingTimer) clearInterval(recordingTimer);
            recordingTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);

        } catch (err) {
            console.error(err);
            alert('Permissão de microfone negada ou erro ao iniciar.');
        }
    }

    function cancelRecording() {
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
        clearInterval(recordingTimer);
        resetToolbar();
    }

    function stopAndSendRecording() {
        if (!mediaRecorder) return;

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await uploadMedia(audioBlob, 'audio.webm', 'audio');
            resetToolbar();
        };

        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        clearInterval(recordingTimer);
    }

    // File Logic
    function triggerFile(accept) {
        const input = document.getElementById('file-input');
        input.accept = accept;
        input.click();
        document.getElementById('attach-menu').classList.add('hidden');
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            selectedFile = input.files[0];

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex');
            document.getElementById('toolbar-file').classList.remove('hidden');
            document.getElementById('toolbar-file').classList.add('flex');
            document.getElementById('file-name').textContent = selectedFile.name;
        }
    }

    function cancelFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        resetToolbar();
    }

    async function sendFile() {
        if (!selectedFile) return;
        await uploadMedia(selectedFile, selectedFile.name, 'file');
        cancelFile();
    }

    function resetToolbar() {
        document.getElementById('toolbar-default').classList.remove('hidden');
        document.getElementById('toolbar-default').classList.add('flex');

        document.getElementById('toolbar-recording').classList.add('hidden');
        document.getElementById('toolbar-recording').classList.remove('flex');

        document.getElementById('toolbar-file').classList.add('hidden');
        document.getElementById('toolbar-file').classList.remove('flex');
    }

    async function uploadMedia(file, filename, type) {
        // Optimistic Loading? Maybe later.
        const btn = document.getElementById('btn-attach'); // just a visual anchor
        const originalHtml = btn.innerHTML;
        btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-gray-500 rounded-full border-t-transparent"></div>`;

        try {
            const formData = new FormData();
            formData.append('file', file, filename);
            formData.append('client_id', pageClientId); // Explicitly use pageClientId
            formData.append('type', type);

            const res = await fetch('/api/whatsapp/send-media', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            loadClientWhatsAppMessages();
        } catch (e) {
            alert('Erro ao enviar mídia: ' + e.message);
        } finally {
            btn.innerHTML = originalHtml;
        }
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;

        input.value = '';
        input.focus();

        // Reset toggle
        btnMic.classList.remove('hidden');
        btnSend.classList.add('hidden');

        try {
            const response = await fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_id: pageClientId, content: content })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            loadClientWhatsAppMessages();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    }

    // Rich Text Helper (Standardized)
    function insertFormat(char) {
        const input = document.getElementById('message-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const txt = input.value;

        if (start === end) {
            input.value = txt.substring(0, start) + char + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + char.length;
        } else {
            const wrapped = char + txt.substring(start, end) + char;
            input.value = txt.substring(0, start) + wrapped + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = end + (char.length * 2);
        }

        // Trigger input event to update mic/send
        input.dispatchEvent(new Event('input'));
    }
</script>
{% endblock %}