{% extends "base.html" %}
{% from "macros.html" import user_avatar %}

{% block content %}
<div class="flex-1 overflow-y-auto bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto pb-20">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('clients.clients') }}"
                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-500 hover:text-northway-red hover:bg-red-50 transition-colors shadow-sm">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">{{ client.name }}</h1>
                        <span class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider
                            {% if client.status == 'ativo' %} bg-green-100 text-green-700 border border-green-200
                            {% elif client.status == 'onboarding' %} bg-blue-100 text-blue-700 border border-blue-200
                            {% elif client.status == 'cancelado' %} bg-red-100 text-red-700 border border-red-200
                            {% else %} bg-gray-100 text-gray-700 border border-gray-200
                            {% endif %}">
                            {{ client.status }}
                        </span>

                        <!-- Health Status -->
                        <div class="flex items-center gap-1.5 ml-1">
                            {% if client.health_status == 'verde' %}
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]">
                            </div>
                            {% elif client.health_status == 'amarelo' %}
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.4)]">
                            </div>
                            {% elif client.health_status == 'vermelho' %}
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]"></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-gray-400 text-xs font-medium">
                        <a href="{{ url_for('dashboard.dashboard') }}"
                            class="hover:text-gray-600 transition-colors">CRM</a>
                        <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        <a href="{{ url_for('clients.clients') }}"
                            class="hover:text-gray-600 transition-colors">Clientes</a>
                        <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        <span class="text-gray-600">{{ client.name }}</span>
                    </div>
                </div>
            </div>

            {% if current_user.role in ['admin', 'manager'] %}
            <!-- Renewal Alert -->
            {% if client.renewal_date %}
            {% set days_left = (client.renewal_date - today).days %}
            {% if days_left <= 30 %} <div
                class="mb-6 p-4 rounded-lg flex items-center justify-between shadow-sm border {{ 'bg-red-50 border-red-200' if days_left < 0 else 'bg-orange-50 border-orange-200' }}">
                <div class="flex items-center gap-3">
                    <div
                        class="p-2 rounded-full {{ 'bg-red-100 text-red-600' if days_left < 0 else 'bg-orange-100 text-orange-600' }}">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-bold {{ 'text-red-900' if days_left < 0 else 'text-orange-900' }}">
                            {% if days_left < 0 %} Renovação Vencida! {% else %} Renovação Próxima {% endif %} </h3>
                                <p class="{{ 'text-red-700' if days_left < 0 else 'text-orange-700' }}">
                                    O contrato vence em <strong>{{ client.renewal_date.strftime('%d/%m/%Y') }}</strong>.
                                    {% if days_left < 0 %} (Atrasado há {{ days_left|abs }} dias) {% else %} (Faltam {{
                                        days_left }} dias) {% endif %} </p>
                    </div>
                </div>
                <button onclick="toggleModal('taskModal')"
                    class="px-4 py-2 rounded-lg font-bold shadow-sm transition-colors {{ 'bg-northway-red text-white hover:bg-red-700' if days_left < 0 else 'bg-orange-500 text-white hover:bg-orange-600' }}">
                    Agendar Contato
                </button>
        </div>
        {% endif %}
        {% endif %}

        <div class="flex items-center gap-3">
            <!-- Drive Button -->
            {% if client.drive_folder_url %}
            <a href="{{ client.drive_folder_url }}" target="_blank"
                class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2"
                title="Abrir Pasta no Drive">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg"
                    class="w-4 h-4">
                <span>Drive</span>
            </a>
            {% else %}
            <button onclick="switchClientTab('drive')"
                class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2"
                title="Configurar Drive">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg"
                    class="w-4 h-4 grayscale opacity-60">
                <span>Drive</span>
            </button>
            {% endif %}

            <a href="{{ url_for('contracts.new_contract', id=client.id) }}"
                class="bg-[#fa0102] text-white border border-[#fa0102] px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="file-signature" class="w-4 h-4"></i>
                <span>Emitir Contrato</span>
            </a>

            <div id="topEditActions">
                <button type="button" onclick="startEditMode()" id="topEditBtn"
                    class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                    <span>Editar Dados</span>
                </button>
                <div id="saveCancelBtns" class="hidden flex items-center gap-2">
                    <button onclick="cancelEditMode()"
                        class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        <span>Cancelar</span>
                    </button>
                    <button onclick="saveClientForm()"
                        class="bg-[#fa0102] text-white border border-[#fa0102] px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>Salvar Alterações</span>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <form action="{{ url_for('clients.update_client', id=client.id) }}" method="POST" id="clientForm">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Info Column -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Registration Data Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <!-- Tabs -->
                    <div class="px-6 pt-6 pb-2 border-b border-gray-100 bg-white">
                        <div class="inline-flex bg-gray-100/50 p-1.5 rounded-2xl gap-1">
                            <button type="button" onclick="switchClientTab('details')" id="tab-client-details"
                                class="px-5 py-2.5 text-xs font-bold text-gray-700 bg-white shadow-sm rounded-xl transition-all flex items-center gap-2 border border-gray-100/50 transform scale-105 shadow-md">
                                <i data-lucide="building-2" class="w-3.5 h-3.5"></i> Dados Cadastrais
                            </button>
                            <button type="button" onclick="switchClientTab('contracts')" id="tab-client-contracts"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="file-text" class="w-3.5 h-3.5"></i> Contratos
                            </button>
                            <button type="button" onclick="switchClientTab('tasks')" id="tab-client-tasks"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="check-square" class="w-3.5 h-3.5"></i> Tarefas
                            </button>
                            <button type="button" onclick="switchClientTab('whatsapp')" id="tab-client-whatsapp"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="message-circle" class="w-3.5 h-3.5"></i> WhatsApp
                            </button>
                            <button type="button" onclick="switchClientTab('financial')" id="tab-client-financial"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="wallet" class="w-3.5 h-3.5"></i> Financeiro
                            </button>
                            <button type="button" onclick="switchClientTab('service-orders')"
                                id="tab-client-service-orders"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="briefcase" class="w-3.5 h-3.5"></i> Ordens (OS)
                            </button>
                            {% if diag_instance %}
                            <button type="button" onclick="switchClientTab('diagnostic')" id="tab-client-diagnostic"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="line-chart" class="w-3.5 h-3.5"></i> Diagnóstico
                            </button>
                            {% endif %}
                            <button type="button" onclick="switchClientTab('drive')" id="tab-client-drive"
                                class="px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60">
                                <i data-lucide="hard-drive" class="w-3.5 h-3.5"></i> Arquivos
                                {% if client.drive_unread_files_count > 0 %}
                                <span class="bg-red-500 text-white text-[10px] px-1.5 rounded-full">{{
                                    client.drive_unread_files_count }}</span>
                                {% endif %}
                            </button>
                        </div>
                    </div>

                    <!-- Details Content -->
                    <div id="content-client-details" class="p-8">

                        <!-- GMB CARD -->
                        {% if client.gmb_rating > 0 or client.gmb_link %}
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                            <h3
                                class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Google_Maps_icon_%282020%29.svg/1200px-Google_Maps_icon_%282020%29.svg.png"
                                    class="w-4 h-4" alt="GMaps">
                                Dados do Google
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                                    <div class="text-2xl font-black text-gray-900">{{ client.gmb_rating }}</div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold">Nota Média</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                                    <div class="text-xl font-bold text-gray-900">{{ client.gmb_reviews }}</div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold">Avaliações</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-100 col-span-2">
                                    <div class="text-lg font-bold text-gray-900">{{ client.gmb_photos }}</div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold">Fotos Publicadas</div>
                                </div>
                            </div>
                            {% if client.gmb_link %}
                            <a href="{{ client.gmb_link }}" target="_blank"
                                class="block w-full text-center mt-3 bg-blue-50 text-blue-600 px-3 py-2 rounded text-xs font-bold hover:bg-blue-100 transition-colors">
                                Ver no Google Maps <i data-lucide="external-link" class="w-3 h-3 inline ml-1"></i>
                            </a>
                            {% endif %}
                            <div class="text-[10px] text-gray-400 text-center mt-2">
                                Sincronizado: {{ client.gmb_last_sync.strftime('%d/%m %H:%M') if client.gmb_last_sync
                                else 'N/A' }}
                            </div>
                        </div>
                        {% endif %}

                        <h3 class="hidden text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                            Dados Cadastrais
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                            <div class="relative">
                                <label
                                    class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                    <i data-lucide="hash" class="w-3 h-3"></i> CNPJ / CPF
                                </label>
                                <input type="text" name="document" value="{{ client.document or '' }}"
                                    placeholder="Não informado" disabled
                                    class="w-full bg-gray-50 px-4 py-3 rounded-xl border border-gray-100/80 text-gray-900 font-semibold text-sm transition-all focus:border-[#fa0102] focus:ring-1 focus:ring-[#fa0102] disabled:opacity-100 disabled:cursor-not-allowed">
                            </div>
                            <div class="relative">
                                <label
                                    class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                    <i data-lucide="mail" class="w-3 h-3"></i> Email de Contato
                                </label>
                                <input type="email" name="email_contact" value="{{ client.email_contact or '' }}"
                                    placeholder="Não informado" disabled
                                    class="w-full bg-gray-50 px-4 py-3 rounded-xl border border-gray-100/80 text-gray-900 font-semibold text-sm transition-all focus:border-[#fa0102] focus:ring-1 focus:ring-[#fa0102] disabled:opacity-100 disabled:cursor-not-allowed">
                            </div>
                            <div class="relative">
                                <label
                                    class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                    <i data-lucide="user" class="w-3 h-3"></i> Representante Legal
                                </label>
                                <input type="text" name="representative" value="{{ client.representative or '' }}"
                                    placeholder="Não informado" disabled
                                    class="w-full bg-gray-50 px-4 py-3 rounded-xl border border-gray-100/80 text-gray-900 font-semibold text-sm transition-all focus:border-[#fa0102] focus:ring-1 focus:ring-[#fa0102] disabled:opacity-100 disabled:cursor-not-allowed">
                            </div>
                            <div class="relative">
                                <label
                                    class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                    <i data-lucide="credit-card" class="w-3 h-3"></i> CPF do Rep.
                                </label>
                                <input type="text" name="representative_cpf"
                                    value="{{ client.representative_cpf or '' }}" placeholder="Não informado" disabled
                                    class="w-full bg-gray-50 px-4 py-3 rounded-xl border border-gray-100/80 text-gray-900 font-semibold text-sm transition-all focus:border-[#fa0102] focus:ring-1 focus:ring-[#fa0102] disabled:opacity-100 disabled:cursor-not-allowed">
                            </div>
                        </div>

                        <!-- Address Section -->
                        <div class="space-y-4 pt-6 mt-4 border-t border-gray-100">
                            <label
                                class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                <i data-lucide="map-pin" class="w-3 h-3"></i> Endereço
                            </label>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="md:col-span-3 overflow-hidden">
                                    <div
                                        class="bg-gray-50/50 px-4 py-3 rounded-xl border border-gray-100/80 transition-all focus-within:border-[#fa0102] focus-within:ring-1 focus-within:ring-[#fa0102]">
                                        <label
                                            class="text-[10px] block text-gray-400 font-bold uppercase mb-1">Logradouro
                                            e Número</label>
                                        <div class="flex gap-2">
                                            <input type="text" name="address_street"
                                                value="{{ client.address_street or '' }}"
                                                placeholder="Rua não informada" disabled
                                                class="flex-1 bg-transparent border-none p-0 text-sm text-gray-900 font-medium placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed">
                                            <span class="text-gray-400 font-light">,</span>
                                            <input type="text" name="address_number"
                                                value="{{ client.address_number or '' }}" placeholder="S/N" disabled
                                                class="w-20 bg-transparent border-none p-0 text-sm text-gray-900 font-medium placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed text-right block">
                                        </div>
                                    </div>
                                </div>
                                <div class="overflow-hidden">
                                    <div
                                        class="bg-gray-50/50 px-4 py-3 rounded-xl border border-gray-100/80 transition-all focus-within:border-[#fa0102] focus-within:ring-1 focus-within:ring-[#fa0102]">
                                        <label
                                            class="text-[10px] block text-gray-400 font-bold uppercase mb-1">CEP</label>
                                        <input type="text" name="address_zip" value="{{ client.address_zip or '' }}"
                                            placeholder="-" disabled
                                            class="w-full bg-transparent border-none p-0 text-sm text-gray-900 font-medium placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="overflow-hidden">
                                    <div
                                        class="bg-gray-50/50 px-4 py-3 rounded-xl border border-gray-100/80 transition-all focus-within:border-[#fa0102] focus-within:ring-1 focus-within:ring-[#fa0102]">
                                        <label
                                            class="text-[10px] block text-gray-400 font-bold uppercase mb-1">Bairro</label>
                                        <input type="text" name="address_neighborhood"
                                            value="{{ client.address_neighborhood or '' }}" placeholder="-" disabled
                                            class="w-full bg-transparent border-none p-0 text-sm text-gray-900 font-medium placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed">
                                    </div>
                                </div>
                                <div class="overflow-hidden">
                                    <div
                                        class="bg-gray-50/50 px-4 py-3 rounded-xl border border-gray-100/80 transition-all focus-within:border-[#fa0102] focus-within:ring-1 focus-within:ring-[#fa0102]">
                                        <label
                                            class="text-[10px] block text-gray-400 font-bold uppercase mb-1">Cidade</label>
                                        <input type="text" name="address_city" value="{{ client.address_city or '' }}"
                                            placeholder="-" disabled
                                            class="w-full bg-transparent border-none p-0 text-sm text-gray-900 font-medium placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed">
                                    </div>
                                </div>
                                <div class="overflow-hidden">
                                    <div
                                        class="bg-gray-50/50 px-4 py-3 rounded-xl border border-gray-100/80 transition-all focus-within:border-[#fa0102] focus-within:ring-1 focus-within:ring-[#fa0102]">
                                        <label
                                            class="text-[10px] block text-gray-400 font-bold uppercase mb-1">UF</label>
                                        <input type="text" name="address_state" value="{{ client.address_state or '' }}"
                                            placeholder="-" disabled
                                            class="w-full bg-transparent border-none p-0 text-sm text-gray-900 font-bold placeholder-gray-400 focus:ring-0 disabled:cursor-not-allowed text-center uppercase">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Notes Section (Restored) -->
                        <div class="pt-6 mt-4 border-t border-gray-100">
                            <label
                                class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                <i data-lucide="sticky-note" class="w-3 h-3"></i> Notas Internas
                            </label>
                            <textarea name="notes" rows="4" placeholder="Digite notas sobre o cliente..."
                                class="w-full bg-yellow-50/50 border border-gray-200 rounded-xl p-4 text-sm text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-yellow-400/20 focus:border-yellow-400 resize-none transition-all"
                                onblur="this.form.submit()">{{ client.notes or '' }}</textarea>
                        </div>
                    </div>

                    <!-- Contracts Content (New Tab) -->
                    <div id="content-client-contracts" class="hidden p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                Contratos Emitidos
                            </h3>
                            <a href="{{ url_for('contracts.new_contract', id=client.id) }}"
                                class="bg-northway-red text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Novo Contrato
                            </a>
                        </div>

                        <div class="space-y-3">
                            {% if client.contracts %}
                            {% for contract in client.contracts|sort(attribute='created_at', reverse=True) %}
                            <div
                                class="group flex items-center justify-between p-4 rounded-xl border border-gray-100 hover:border-red-100/30 hover:bg-red-50/10 transition-all bg-white shadow-sm relative">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-12 h-12 rounded-lg flex items-center justify-center shrink-0 {{ 'bg-yellow-50 text-yellow-600' if contract.status == 'draft' else ('bg-green-50 text-green-600' if contract.status == 'signed' else ('bg-red-50 text-red-600' if contract.status == 'terminated' else 'bg-blue-50 text-blue-600')) }}">
                                        <i data-lucide="{{ 'file-edit' if contract.status == 'draft' else ('ban' if contract.status == 'terminated' else 'file-text') }}"
                                            class="w-6 h-6"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <p class="text-[10px] font-mono text-gray-400 mb-0.5">{{ contract.code or '#' ~
                                            contract.id }}</p>
                                        <a href="{{ url_for('contracts.view_contract', id=contract.id) }}"
                                            class="text-base font-bold text-gray-900 leading-tight hover:text-northway-red hover:underline transition-colors block">
                                            {{ contract.template.name if contract.template else 'Contrato Avulso' }}
                                        </a>
                                        <p class="text-xs text-gray-500 mt-1">Criado em {{
                                            contract.created_at.strftime('%d/%m/%Y') if contract.created_at else 'N/A'
                                            }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-wider px-2.5 py-1 rounded-md {{ 'bg-yellow-100 text-yellow-700' if contract.status == 'draft' else ('bg-green-100 text-green-700' if contract.status == 'signed' else ('bg-red-100 text-red-700' if contract.status == 'terminated' else 'bg-blue-100 text-blue-700')) }}">
                                        {{ 'Rascunho' if contract.status == 'draft' else ('Emitido' if contract.status
                                        ==
                                        'issued' else ('Assinado' if contract.status == 'signed' else ('Rescindido' if
                                        contract.status == 'terminated' else contract.status))) }}
                                    </span>

                                    <div class="flex items-center gap-2">
                                        {% if contract.status == 'draft' %}
                                        <a href="{{ url_for('contracts.load_draft', contract_id=contract.id) }}"
                                            class="text-xs font-bold text-gray-500 hover:text-northway-red flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-lg border border-gray-200 hover:border-red-100">
                                            <i data-lucide="pencil" class="w-3 h-3"></i> Continuar
                                        </a>
                                        {% endif %}

                                        {% if contract.status == 'issued' %}
                                        <button type="button" onclick="signContract('{{ contract.id }}')"
                                            class="text-xs font-bold text-white bg-green-600 hover:bg-green-700 flex items-center gap-1 px-3 py-1.5 rounded-lg shadow-sm transition-colors cursor-pointer">
                                            <i data-lucide="pen-tool" class="w-3 h-3"></i> Assinar
                                        </button>
                                        <a href="{{ url_for('contracts.view_contract', id=contract.id) }}"
                                            target="_blank"
                                            class="text-xs font-bold text-gray-600 hover:text-gray-900 flex items-center gap-1 bg-gray-100 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition-colors">
                                            <i data-lucide="eye" class="w-3 h-3"></i> Ver
                                        </a>
                                        {% endif %}

                                        {% if contract.status == 'signed' %}
                                        <a href="{{ url_for('contracts.view_contract', id=contract.id) }}"
                                            target="_blank"
                                            class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors">
                                            <i data-lucide="check-circle" class="w-3 h-3"></i> Ver Assinado
                                        </a>
                                        {% set contract_display_name = contract.template.name if contract.template else
                                        'Contrato Avulso' %}
                                        <button type="button"
                                            onclick="openTerminationModal('{{ contract.id }}', '{{ contract_display_name }}')"
                                            class="text-xs text-red-400 hover:text-red-600 underline ml-2">Rescindir</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div
                                class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                <div class="bg-gray-100 p-3 rounded-full mb-3">
                                    <i data-lucide="file-x" class="w-8 h-8 opacity-40"></i>
                                </div>
                                <p class="text-sm italic font-medium">Nenhum contrato emitido.</p>
                                <p class="text-xs mt-1">Crie um novo contrato para começar.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tasks Content (New Tab) -->
                    <div id="content-client-tasks" class="hidden p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                Tarefas & Agendamentos
                            </h3>
                            <button type="button" onclick="toggleModal('taskModal')"
                                class="bg-northway-red text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Agendar Tarefa
                            </button>
                        </div>

                        <div class="space-y-2">
                            {% for task in client.tasks|sort(attribute='status', reverse=True) %}
                            <div
                                class="flex items-center gap-4 p-4 rounded-xl border {{ 'bg-gray-50 border-gray-100 opacity-60' if task.status == 'concluida' else 'bg-white border-gray-100 hover:border-red-100/30 shadow-sm' }} transition-all">
                                <form action="{{ url_for('tasks.toggle_task', id=task.id) }}" method="POST"
                                    class="shrink-0">
                                    <button type="submit"
                                        class="{{ 'text-green-500' if task.status == 'concluida' else 'text-gray-300 hover:text-red-500' }} transition-colors p-1">
                                        <i data-lucide="{{ 'check-circle' if task.status == 'concluida' else 'circle' }}"
                                            class="w-6 h-6"></i>
                                    </button>
                                </form>
                                <div class="flex-1 min-w-0">
                                    <p
                                        class="text-sm font-bold {{ 'text-gray-500 line-through' if task.status == 'concluida' else 'text-gray-900' }}">
                                        {{ task.title }}</p>
                                    <div class="flex items-center gap-3 mt-1">
                                        <p class="text-xs text-gray-500 flex items-center gap-1">
                                            <i data-lucide="calendar" class="w-3 h-3"></i>
                                            {{ task.due_date.strftime('%d/%m/%Y às %H:%M') if task.due_date else 'Sem
                                            data'
                                            }}
                                        </p>
                                        {% if task.responsible %}
                                        <p class="text-xs text-gray-400 flex items-center gap-1">
                                            <i data-lucide="user" class="w-3 h-3"></i>
                                            {{ task.responsible.name }}
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    {% if task.priority == 'urgente' %}
                                    <span
                                        class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">Urgente</span>
                                    {% endif %}
                                    {% if task.is_recurring %}
                                    <span
                                        class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase flex items-center gap-1"><i
                                            data-lucide="repeat" class="w-3 h-3"></i> Mensal</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div
                                class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                <div class="bg-gray-100 p-3 rounded-full mb-3">
                                    <i data-lucide="check-square" class="w-8 h-8 opacity-40"></i>
                                </div>
                                <p class="text-sm italic font-medium">Nenhuma tarefa pendente.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>



                    <!-- Financial Content -->
                    <div id="content-client-financial" class="hidden p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                Extrato Financeiro
                            </h3>
                            <button type="button" onclick="toggleModal('manualChargeModal')"
                                class="bg-[#fa0102] text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nova Cobrança
                            </button>
                        </div>

                        <!-- Financial Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <div
                                class="bg-gray-50 rounded-xl p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-all shadow-sm">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-blue-100 rounded-bl-full -mr-8 -mt-8 opacity-40 group-hover:bg-blue-200 transition-colors">
                                </div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider relative z-10">
                                    Faturamento Mensal (MRR)</p>
                                <p class="text-xl font-extrabold text-[#fa0102] relative z-10">R$ {{
                                    "%.2f"|format(mrr)|replace('.', ',') }}</p>
                                <p class="text-[9px] text-gray-400 relative z-10 mt-1">Soma de contratos assinados</p>
                            </div>
                            <div
                                class="bg-gray-50 rounded-xl p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-all shadow-sm">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-green-100 rounded-bl-full -mr-8 -mt-8 opacity-40 group-hover:bg-green-200 transition-colors">
                                </div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider relative z-10">
                                    Total
                                    Pago (LTV)</p>
                                <p class="text-xl font-extrabold text-green-600 relative z-10">R$ {{
                                    "%.2f"|format(total_paid)|replace('.', ',') }}</p>
                                <p class="text-[9px] text-gray-400 relative z-10 mt-1">Histórico acumulado</p>
                            </div>
                            <div
                                class="bg-gray-50 rounded-xl p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-all shadow-sm">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-gray-200 rounded-bl-full -mr-8 -mt-8 opacity-40">
                                </div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider relative z-10">A
                                    Receber</p>
                                <p class="text-xl font-extrabold text-gray-700 relative z-10">R$ {{
                                    "%.2f"|format(total_pending)|replace('.', ',') }}</p>
                                <p class="text-[9px] text-gray-400 relative z-10 mt-1">Cobranças pendentes</p>
                            </div>
                            <div
                                class="bg-gray-50 rounded-xl p-4 border border-gray-100 relative overflow-hidden group hover:border-[#fa0102]/20 transition-all shadow-sm">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 opacity-40 group-hover:bg-red-200 transition-colors">
                                </div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider relative z-10">
                                    Vencido</p>
                                <p class="text-xl font-extrabold text-red-600 relative z-10">R$ {{
                                    "%.2f"|format(total_overdue)|replace('.', ',') }}</p>
                                <p class="text-[9px] text-gray-400 relative z-10 mt-1">Cobranças atrasadas</p>
                            </div>
                        </div>

                        <!-- Transaction List -->
                        <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Histórico de Cobranças</h4>
                        <div class="space-y-3">
                            {% if client_txs %}
                            {% for tx in client_txs %}
                            <div
                                class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:shadow-sm transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="bg-gray-50 p-2 rounded text-gray-500">
                                        {% if tx.status == 'paid' %}
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
                                        {% elif tx.status == 'overdue' %}
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                                        {% elif tx.status == 'cancelled' %}
                                        <i data-lucide="x-circle" class="w-5 h-5 text-gray-400"></i>
                                        {% else %}
                                        <i data-lucide="clock" class="w-5 h-5 text-yellow-500"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <p class="font-bold text-gray-900 text-sm">{{ tx.description }}</p>
                                        <div class="flex gap-3 text-xs text-gray-500">
                                            <span>Vencimento: {{ tx.due_date.strftime('%d/%m/%Y') if tx.due_date else
                                                'N/A'
                                                }}</span>
                                            {% if tx.created_at %}
                                            <span class="text-gray-400">• Gerada: {{ tx.created_at.strftime('%d/%m')
                                                }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="text-right">
                                    <p class="font-bold text-gray-900 text-sm">R$ {{
                                        "%.2f"|format(tx.amount)|replace('.',
                                        ',') }}</p>
                                    <span
                                        class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full 
                                    {{ 'bg-green-100 text-green-700' if tx.status == 'paid' else 
                                       ('bg-red-100 text-red-700' if tx.status == 'overdue' else 
                                       ('bg-gray-100 text-gray-600' if tx.status == 'cancelled' else 'bg-yellow-100 text-yellow-700')) }}">
                                        {{ 'PAGO' if tx.status == 'paid' else
                                        ('VENCIDO' if tx.status == 'overdue' else
                                        ('CANCELADO' if tx.status == 'cancelled' else 'PENDENTE')) }}
                                    </span>
                                </div>
                                <div class="ml-4">
                                    {% if tx.asaas_invoice_url %}
                                    <a href="{{ tx.asaas_invoice_url }}" target="_blank"
                                        class="text-gray-400 hover:text-northway-red" title="Ver Boleto">
                                        <i data-lucide="external-link" class="w-4 h-4"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div
                                class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                <div class="bg-gray-100 p-3 rounded-full mb-3">
                                    <i data-lucide="file-x" class="w-8 h-8 opacity-40"></i>
                                </div>
                                <p class="text-sm italic font-medium">Nenhuma cobrança registrada.</p>
                                <p class="text-xs mt-1">Gere uma nova cobrança para começar.</p>
                            </div>
                            {% endif %}
                        </div> <!-- content-client-financial -->

                        <!-- Service Orders Content (New Tab) -->
                        <div id="content-client-service-orders" class="hidden p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                    Ordens de Serviço Extras
                                </h3>
                                <button type="button" onclick="toggleModal('serviceOrderModal')"
                                    class="bg-northway-red text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Nova Ordem de Serviço
                                </button>
                            </div>

                            <div class="space-y-4">
                                {% if client.service_orders %}
                                {% for os in client.service_orders|sort(attribute='created_at', reverse=True) %}
                                <div
                                    class="bg-white border border-gray-200 rounded-xl p-5 hover:border-red-100 transition-all shadow-sm">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 
                                                {{ 'bg-yellow-50 text-yellow-600' if os.status in ['SOLICITADA', 'AGUARDANDO_ACEITE'] else 
                                                ('bg-blue-50 text-blue-600' if os.status in ['EM_EXECUCAO', 'AUTORIZADA'] else 
                                                ('bg-green-50 text-green-600' if os.status == 'CONCLUIDA' else 
                                                ('bg-red-50 text-red-600' if os.status == 'CANCELADA' else 'bg-gray-50 text-gray-600'))) }}">
                                                <i data-lucide="briefcase" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2 mb-1">
                                                    <h4 class="text-base font-bold text-gray-900">{{ os.title }}</h4>
                                                    <span
                                                        class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-md 
                                                        {{ 'bg-yellow-100 text-yellow-700' if os.status in ['SOLICITADA', 'AGUARDANDO_ACEITE'] else 
                                                        ('bg-blue-100 text-blue-700' if os.status in ['EM_EXECUCAO', 'AUTORIZADA'] else 
                                                        ('bg-green-100 text-green-700' if os.status == 'CONCLUIDA' else 
                                                        ('bg-red-100 text-red-700' if os.status == 'CANCELADA' else 'bg-gray-100 text-gray-600'))) }}">
                                                        {{ os.status.replace('_', ' ') }}
                                                    </span>
                                                </div>
                                                <p class="text-xs text-gray-500 mb-2 max-w-xl">{{ os.description or 'Sem
                                                    descrição' }}</p>
                                                {% if os.asaas_payment_id %}
                                                <div class="flex items-center gap-2 text-xs text-gray-400">
                                                    <span
                                                        class="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">
                                                        <img src="https://ajuda.asaas.com/hc/article_attachments/360037805174/asaas-logo.png"
                                                            class="h-3 opacity-60">
                                                        Cobrança Gerada
                                                    </span>
                                                    {% if os.asaas_invoice_url %}
                                                    <a href="{{ os.asaas_invoice_url }}" target="_blank"
                                                        class="text-blue-500 hover:underline flex items-center gap-0.5">
                                                        Ver fatura <i data-lucide="external-link" class="w-3 h-3"></i>
                                                    </a>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-extrabold text-gray-900">R$ {{
                                                "%.2f"|format(os.value)|replace('.', ',') }}</p>
                                            <p class="text-[10px] text-gray-400 mb-3">{{
                                                os.created_at.strftime('%d/%m/%Y') }}</p>

                                            {% if os.status not in ['CONCLUIDA', 'CANCELADA'] %}
                                            <button
                                                onclick='openCancelOSModal("{{ os.id }}", {{ os.title|tojson|safe }})'
                                                class="text-xs font-bold text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition-colors">
                                                Cancelar OS
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if os.status == 'CANCELADA' %}
                                    <div
                                        class="mt-3 pt-3 border-t border-red-50 flex items-start gap-2 text-xs text-red-400 bg-red-50/20 p-2 rounded">
                                        <i data-lucide="alert-circle" class="w-4 h-4 mt-0.5"></i>
                                        <div>
                                            <span class="font-bold">Cancelada por {{ os.canceled_by.name if
                                                os.canceled_by else 'Sistema' }} em {{
                                                os.canceled_at.strftime('%d/%m/%Y') if os.canceled_at else '' }}</span>
                                            <p class="italic">"{{ os.cancel_reason }}"</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% else %}
                                <div
                                    class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                    <div class="bg-gray-100 p-3 rounded-full mb-3">
                                        <i data-lucide="briefcase" class="w-8 h-8 opacity-40"></i>
                                    </div>
                                    <p class="text-sm italic font-medium">Nenhuma ordem de serviço extra.</p>
                                    <p class="text-xs mt-1">Crie uma nova OS para serviços avulsos.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Diagnostic Content -->
                        <!-- Diagnostic Tab (Access Control) -->
                        {% if diag_instance %}
                        <div id="content-client-diagnostic" class="hidden p-8">
                            <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="line-chart" class="w-5 h-5 text-gray-400"></i>
                                Diagnóstico Estratégico
                            </h3>

                            {% if client.diagnostic_status == 'done' %}
                            <div class="space-y-8">
                                <!-- Results Summary -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div
                                        class="bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col items-center justify-center">
                                        <div class="text-3xl font-black text-gray-900">{{ client.diagnostic_stars or 0
                                            }}</div>
                                        <div class="text-[10px] text-gray-500 uppercase font-bold">Nota Final (0-5)
                                        </div>
                                    </div>
                                    <div
                                        class="bg-gray-50 p-4 rounded-xl border border-gray-100 flex flex-col items-center justify-center">
                                        <div class="text-xl font-bold text-northway-red">{{ client.diagnostic_score or 0
                                            }}</div>
                                        <div class="text-[10px] text-gray-500 uppercase font-bold">Score Total</div>
                                    </div>
                                    <div
                                        class="bg-red-50 p-4 rounded-xl border border-red-100 flex flex-col items-center justify-center text-center relative group">
                                        <div class="text-xs font-bold text-red-800 uppercase mb-1">Classificação</div>
                                        <div class="text-sm text-red-900 font-medium mb-2">{{
                                            client.diagnostic_classification or 'Indefinido' }}</div>

                                        {% if client.submissions %}
                                        <a href="{{ url_for('forms.get_report', submission_id=client.submissions|sort(attribute='created_at', reverse=True)|first|attr('id')) }}"
                                            target="_blank"
                                            class="text-[10px] font-bold text-red-600 hover:text-red-800 underline">
                                            Ver Relatório Completo
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Pillars Breakdown -->
                                {% if client.diagnostic_pillars %}
                                {% set pillars = client.diagnostic_pillars|from_json %}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {% for pillar, data in pillars.items() %}
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-end">
                                            <span class="text-sm font-bold text-gray-700">{{ pillar }}</span>
                                            <span class="text-xs font-bold text-northway-red">{{ data.score }}
                                                pts</span>
                                        </div>
                                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                            <div class="bg-northway-red h-full rounded-full transition-all duration-1000"
                                                style="width: {{ (data.score / data.max * 100)|round if data.max > 0 else 0 }}%">
                                            </div>
                                        </div>
                                        <div
                                            class="flex justify-between text-[10px] text-gray-400 font-medium uppercase">
                                            <span>Nível: {{ data.level }}</span>
                                            <span>Máx: {{ data.max }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div
                                class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                <div class="bg-gray-100 p-3 rounded-full mb-3">
                                    <i data-lucide="clipboard-list" class="w-8 h-8 opacity-40"></i>
                                </div>
                                <p class="text-sm italic font-medium">Nenhum diagnóstico realizado ainda.</p>
                                <p class="text-xs mt-1">Envie o link de participação para o cliente.</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Drive Content (New Tab) -->
                        <div id="content-client-drive" class="hidden p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <i data-lucide="hard-drive" class="w-5 h-5 text-gray-400"></i>
                                    Arquivos (Google Drive)
                                </h3>
                                <button type="button" onclick="toggleModal('createDriveFoldersModal')"
                                    class="text-northway-red hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors font-bold text-sm flex items-center gap-2">
                                    <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                    Criar Pastas
                                </button>
                            </div>

                            {% if client.drive_folder_url %}
                            <div
                                class="bg-blue-50 border border-blue-100 rounded-xl p-6 mb-8 flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-blue-900 text-lg mb-1">Pasta do Cliente Conectada</h4>
                                    <p class="text-blue-700 text-sm">Todos os arquivos sincronizados aparecerão aqui
                                        automaticamente.</p>
                                    <p class="text-blue-500 text-xs mt-2 flex items-center gap-1">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        Última sincronização: {{ client.drive_last_scan_at.strftime('%d/%m/%Y às %H:%M')
                                        if client.drive_last_scan_at else 'Aguardando...' }}
                                    </p>
                                </div>
                                <a href="{{ client.drive_folder_url }}" target="_blank"
                                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                    Abrir Pasta no Drive
                                </a>
                            </div>

                            <div class="space-y-3">
                                <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider mb-4">Arquivos
                                    Recentes</h4>
                                {% if client.drive_files_events %}
                                {% for event in client.drive_files_events|sort(attribute='detected_at', reverse=True) %}
                                <div
                                    class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:shadow-sm transition-all group">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-10 h-10 rounded-lg flex items-center justify-center bg-gray-50 text-gray-500 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                            {% if 'pdf' in event.mime_type %}
                                            <i data-lucide="file-text" class="w-5 h-5"></i>
                                            {% elif 'image' in event.mime_type %}
                                            <i data-lucide="image" class="w-5 h-5"></i>
                                            {% elif 'video' in event.mime_type %}
                                            <i data-lucide="video" class="w-5 h-5"></i>
                                            {% else %}
                                            <i data-lucide="file" class="w-5 h-5"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <a href="{{ event.web_view_link }}" target="_blank"
                                                class="font-bold text-gray-900 hover:text-blue-600 hover:underline transition-colors block">
                                                {{ event.file_name }}
                                            </a>
                                            <p class="text-xs text-gray-400 mt-0.5">Detectado em {{
                                                event.detected_at.strftime('%d/%m às %H:%M') }}</p>
                                        </div>
                                    </div>
                                    <a href="{{ event.web_view_link }}" target="_blank"
                                        class="text-gray-400 hover:text-blue-600 p-2 rounded-lg hover:bg-gray-50 transition-colors">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                    </a>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div
                                    class="flex flex-col items-center justify-center py-12 text-gray-400 text-center bg-gray-50/50 rounded-xl border border-dashed border-gray-200">
                                    <i data-lucide="folder-open" class="w-8 h-8 opacity-40 mb-2"></i>
                                    <p class="text-sm font-medium">Nenhum arquivo encontrado.</p>
                                    <p class="text-xs">Faça upload na pasta do Drive e aguarde a sincronização.</p>
                                </div>
                                {% endif %}
                            </div>

                            {% else %}
                            <div class="text-center py-16 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                                <div
                                    class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                    <i data-lucide="hard-drive" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 mb-2">Google Drive Não Conectado</h3>
                                <p class="text-gray-500 max-w-md mx-auto mb-6">Esta conta não possui uma pasta
                                    vinculada. Isso ocorre automaticamente na conversão do Lead, ou se a integração não
                                    estiver ativa.</p>
                                <a href="{{ url_for('integrations_bp.drive_settings_page') }}"
                                    class="text-blue-600 font-bold hover:underline text-sm">
                                    Ver Configurações de Integração
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- WhatsApp Content -->
                        <div id="content-client-whatsapp" class="hidden bg-white h-[600px] flex flex-col">
                            <!-- Helper to know this client has a lead attached? Or direct link? -->
                            <!-- Ideally clients should have a phone. We use client.phone -->

                            <!-- Chat Area -->
                            <div id="client-chat-messages"
                                class="flex-1 overflow-y-auto space-y-4 p-4 bg-[#e5ddd5] rounded-t-lg border border-gray-200 border-b-0 bg-opacity-30">
                                <div class="flex justify-center">
                                    <span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded-full">Carregando
                                        histórico...</span>
                                </div>
                            </div>

                            <!-- Input Area -->
                            <!-- Input Area (Standardized) -->
                            <div
                                class="bg-gray-50 p-3 border border-gray-200 border-t-0 rounded-b-lg flex flex-col gap-2 relative">
                                <!-- Hidden File Input -->
                                <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">

                                <!-- Attachment Menu (Absolute) -->
                                <div id="attach-menu"
                                    class="hidden absolute bottom-20 left-4 bg-white shadow-xl rounded-lg flex flex-col w-40 overflow-hidden z-20 border border-gray-100">
                                    <button onclick="triggerFile('image/*')"
                                        class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700 border-b border-gray-50">
                                        <i data-lucide="image" class="w-4 h-4 text-purple-500"></i> Fotos
                                    </button>
                                    <button onclick="triggerFile('*/*')"
                                        class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700">
                                        <i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i> Documento
                                    </button>
                                </div>

                                <div class="flex items-end gap-2">
                                    <!-- Default Toolbar -->
                                    <div id="toolbar-default" class="flex-1 flex items-center gap-2">
                                        <button type="button" id="btn-attach" onclick="toggleAttachMenu()"
                                            class="p-2 text-gray-500 hover:text-gray-700 transition-colors rounded-full hover:bg-gray-200">
                                            <i data-lucide="plus" class="w-6 h-6"></i>
                                        </button>

                                        <!-- Rich Text Toolbar (Mini) -->
                                        <div
                                            class="hidden md:flex items-center gap-0.5 border-r border-gray-300 pr-2 mr-1">
                                            <button onclick="insertFormat('*')"
                                                class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                                <i data-lucide="bold" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="insertFormat('_')"
                                                class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                                <i data-lucide="italic" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="insertFormat('- ')"
                                                class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                                <i data-lucide="list" class="w-4 h-4"></i>
                                            </button>
                                        </div>

                                        <div
                                            class="flex-1 bg-white rounded-lg border border-gray-300 focus-within:border-northway-red focus-within:ring-1 focus-within:ring-northway-red/20 transition-all overflow-hidden flex items-center px-4 py-2">
                                            <input type="text" id="message-input" placeholder="Mensagem"
                                                class="w-full bg-transparent border-none focus:outline-none text-sm text-gray-800 placeholder-gray-400"
                                                autocomplete="off">
                                        </div>

                                        <!-- Mic / Send Toggle -->
                                        <button type="button" id="btn-mic" onclick="toggleRecording()"
                                            class="p-3 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors shadow-sm">
                                            <i data-lucide="mic" class="w-5 h-5"></i>
                                        </button>
                                        <button type="button" id="btn-send" onclick="sendMessage()"
                                            class="hidden p-3 bg-northway-red text-white rounded-full hover:bg-red-700 transition-colors shadow-sm">
                                            <i data-lucide="send" class="w-5 h-5"></i>
                                        </button>
                                    </div>

                                    <!-- Recording UI -->
                                    <div id="toolbar-recording"
                                        class="flex-1 items-center gap-4 hidden px-4 py-2 bg-white rounded-lg border border-red-100">
                                        <button onclick="cancelRecording()"
                                            class="text-gray-500 hover:text-red-500 p-2">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                        <div class="flex-1 flex items-center gap-3 justify-center">
                                            <span class="animate-pulse w-3 h-3 bg-red-500 rounded-full"></span>
                                            <span id="recording-time"
                                                class="text-gray-700 font-mono text-sm font-bold">0:00</span>
                                        </div>
                                        <button onclick="stopAndSendRecording()"
                                            class="text-green-500 hover:text-green-600 p-2">
                                            <i data-lucide="send" class="w-5 h-5"></i>
                                        </button>
                                    </div>

                                    <!-- File Preview UI -->
                                    <div id="toolbar-file"
                                        class="flex-1 items-center gap-4 hidden bg-white rounded-lg px-4 py-2 border border-green-200">
                                        <span class="text-gray-500"><i data-lucide="file"
                                                class="w-5 h-5 inline"></i></span>
                                        <span id="file-name"
                                            class="flex-1 text-sm text-gray-700 truncate font-medium">arquivo.pdf</span>
                                        <button onclick="cancelFile()" class="text-gray-400 hover:text-red-500 p-2">
                                            <i data-lucide="x" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="sendFile()"
                                            class="text-green-600 hover:text-green-700 font-bold text-sm px-3">
                                            Enviar
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 flex items-center gap-1 justify-center">
                                    <i data-lucide="lock" class="w-3 h-3"></i> Mensagens protegidas e criptografadas de
                                    ponta a
                                    ponta.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Core Tracking Grid REMOVED - Moved to Tabs -->

                    <!-- Processes / Checklists Section -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5 text-gray-400"></i>
                                Processos & Serviços
                            </h3>
                            <button type="button" onclick="toggleModal('addProcessModal')"
                                class="text-northway-red hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors font-bold text-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Adicionar Processo
                            </button>
                        </div>

                        <!-- NEW: Assign Process to User in Modal -->
                        <!-- Need to update Add Process Modal (which is likely in base.html or lower down, need to check) -->
                        <!-- Assuming AddProcessModal is standard, we inject the select there or rely on default behavior -->
                        <!-- Wait, AddProcessModal is probably elsewhere. I should check if I missed it in view_file. -->
                        <!-- For safety, I will add the Delegate Button to existing processes first. -->

                        <div class="space-y-4">
                            {% for checklist in client.checklists|sort(attribute='created_at', reverse=True) %}
                            <div class="border border-gray-200 rounded-xl overflow-hidden process-card">
                                <!-- Header / Summary -->
                                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 transition-colors"
                                    onclick="toggleProcess('{{ checklist.id }}')">
                                    <div class="flex items-center gap-3">
                                        <div class="circular-chart-xs" data-percent="{{ checklist.percent or 0 }}">
                                            <!-- Computed in JS or Backend. For MVP, we calculate on toggle -->
                                            <svg viewBox="0 0 36 36" class="w-8 h-8 transform -rotate-90">
                                                <path class="text-gray-200"
                                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                    fill="none" stroke="currentColor" stroke-width="4" />
                                                <path class="text-northway-red progress-ring" stroke-dasharray="0, 100"
                                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                    fill="none" stroke="currentColor" stroke-width="4"
                                                    id="ring-{{ checklist.id }}" />
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-900">{{ checklist.name }}</h4>
                                            <p class="text-xs text-gray-500">Iniciado em {{
                                                checklist.created_at.strftime('%d/%m/%Y') }}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- Delegate Button -->
                                        <button
                                            onclick='openDelegateModal("{{ checklist.id }}", {{ checklist.name|tojson|safe }}, "{{ checklist.assigned_to_id or "" }}"); event.stopPropagation();'
                                            class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                            title="Delegar Processo">
                                            {% if checklist.assigned_to %}
                                            {{ user_avatar(checklist.assigned_to, size='xs', show_name=False) }}
                                            {% else %}
                                            <i data-lucide="user-plus" class="w-4 h-4"></i>
                                            {% endif %}
                                        </button>
                                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"
                                            id="arrow-{{ checklist.id }}"></i>
                                    </div>
                                </div>

                                <!-- Expanded Content -->
                                <div id="process-content-{{ checklist.id }}"
                                    class="hidden border-t border-gray-200 bg-white p-4 space-y-6">
                                    {% for step in checklist.progress %}
                                    {% set step_index = loop.index0 %}
                                    <div class="step-group">
                                        <h5
                                            class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 pl-1 border-l-4 border-northway-red/20 py-0.5">
                                            {{ step.title }}</h5>
                                        <div class="space-y-2 pl-2">
                                            {% for item in step['items'] %}
                                            <label
                                                class="flex items-start gap-3 group cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                                                <input type="checkbox"
                                                    onchange="toggleChecklistItem('{{ checklist.id }}', '{{ loop.index0 }}', '{{ step_index }}', this)"
                                                    {% if item.done %}checked{% endif %}
                                                    class="mt-1 w-4 h-4 text-northway-red border-gray-300 rounded focus:ring-northway-red cursor-pointer">
                                                <span
                                                    class="text-sm text-gray-700 group-hover:text-gray-900 {{ 'line-through text-gray-400' if item.done else '' }} item-text">{{
                                                    item.text }}</span>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}

                                    <div class="pt-4 border-t border-gray-100 flex justify-end">
                                        <button type="button" onclick="deleteChecklist('{{ checklist.id }}')"
                                            class="text-xs text-red-500 hover:text-red-700 underline">Excluir
                                            Processo</button>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-sm text-gray-400 italic text-center py-4">Nenhum processo ativo para este
                                cliente.
                            </p>
                            {% endfor %}
                        </div>
                    </div>


                </div> <!-- Close lg:col-span-2 -->

                <!-- Sidebar Info Column -->
                <div class="space-y-6">
                    <!-- Diagnostic Card (Access Control) -->
                    {% if diag_instance %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">Diagnóstico</h3>
                            <i data-lucide="line-chart"
                                class="w-4 h-4 {{ 'text-northway-red' if client.diagnostic_status == 'done' else 'text-gray-400' }}"></i>
                        </div>
                        <div class="p-6">
                            {% if client.diagnostic_status == 'done' %}
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="text-2xl font-black text-gray-900">{{ client.diagnostic_stars or 0 }}
                                        <span class="text-xs text-gray-400 font-normal">/ 5</span>
                                    </div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">Nota
                                        Final</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-northway-red">{{ client.diagnostic_score or 0 }}
                                    </div>
                                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">Score
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="switchClientTab('diagnostic')"
                                class="w-full text-center py-2 bg-gray-50 hover:bg-gray-100 text-gray-600 text-xs font-bold rounded-lg transition-colors border border-gray-100">
                                Ver Detalhes do Diagnóstico
                            </button>
                            {% else %}
                            <div class="text-center py-2">
                                <p class="text-xs text-gray-500 mb-4 italic">Ainda não realizado.</p>
                                <button type="button"
                                    onclick="copyDiagnosticLink('{{ url_for('forms.get_form_schema', slug=diag_instance.public_slug, _external=True) }}?client_id={{ client.id }}')"
                                    class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-3 py-2 rounded-lg text-xs font-bold transition-all shadow-sm">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                    Copiar Link do Formulário
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Management Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider">Gestão</h3>
                            <i data-lucide="briefcase" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="p-6">
                            {% if client.account_manager %}
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-xs font-bold text-northway-red">
                                    {{ client.account_manager.name[:2].upper() }}
                                </div>
                                <span class="text-sm font-bold">{{ client.account_manager.name }}</span>
                            </div>
                            {% else %}
                            <p class="text-xs text-gray-400 italic">Sem gerente</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Contact Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Contato</h4>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2 text-sm">
                                <i data-lucide="mail" class="w-4 h-4 text-gray-400"></i>
                                <span>{{ client.email }}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <i data-lucide="phone" class="w-4 h-4 text-gray-400"></i>
                                <span>{{ client.phone }}</span>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Sidebar Info Column -->
            </div> <!-- End Grid -->
    </form>
</div> <!-- End Main Content Scroll Area -->




<!-- Manual Charge Modal -->
<div id="manualChargeModal"
    class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                <i data-lucide="wallet" class="w-5 h-5 text-northway-red"></i> Nova Cobrança Avulsa
            </h3>
            <button onclick="toggleModal('manualChargeModal')" class="text-gray-400 hover:text-gray-600"><i
                    data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <form onsubmit="handleManualCharge(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                    <input type="text" name="description" placeholder="Ex: Consultoria Extra" required
                        class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor</label>
                        <input type="text" name="amount" placeholder="R$ 0,00" required
                            class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Vencimento</label>
                        <input type="date" name="due_date" required
                            class="w-full border-gray-300 rounded-lg focus:ring-northway-red focus:border-northway-red text-sm">
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('manualChargeModal')"
                        class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg text-sm font-bold">Cancelar</button>
                    <button type="submit"
                        class="px-4 py-2 bg-northway-red text-white rounded-lg text-sm font-bold shadow-md hover:bg-red-700">Gerar
                        Cobrança</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    async function handleManualCharge(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const btn = form.querySelector('button[type="submit"]');

        try {
            btn.disabled = true;
            btn.innerHTML = 'Gerando...';

            const res = await fetch(`/clients/{{ client.id }}/charges/new`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (err) {
            alert('Erro ao conectar com servidor.');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Gerar Cobrança';
        }
    }
</script>
</div>

<!-- Termination Modal -->
<!-- Termination Modal -->
<div id="termination-modal"
    class="hidden fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                <h3 class="text-lg font-bold text-gray-900">Rescindir Contrato</h3>
            </div>
            <button type="button" onclick="closeTerminationModal()"
                class="text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form onsubmit="submitTermination(event)" class="space-y-4">
            <input type="hidden" id="term-contract-id">

            <div class="bg-red-50 p-3 rounded-lg border border-red-100 mb-4">
                <p class="text-sm text-red-800">
                    Você está prestes a rescindir o contrato de <strong id="term-contract-title"></strong>.
                    <br>
                    <span class="text-xs opacity-75">Cobranças futuras e agendamentos serão cancelados.</span>
                </p>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Motivo da Rescisão <span
                        class="text-red-500">*</span></label>
                <textarea id="term-reason" rows="3"
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm"
                    placeholder="Descreva o motivo do cancelamento..." required></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Multa (Opcional)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500 text-sm">R$</span>
                        <input type="text" id="term-penalty" oninput="formatCurrency(this)"
                            class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent font-bold text-gray-900"
                            placeholder="0,00">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Vencimento</label>
                    <input type="date" id="term-due-date"
                        class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm font-medium text-gray-700">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeTerminationModal()"
                    class="flex-1 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">Cancelar</button>
                <button type="submit"
                    class="flex-1 py-2.5 bg-northway-red text-white font-bold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="ban" class="w-4 h-4"></i>
                    Confirmar Rescisão
                </button>
            </div>
        </form>
    </div>
</div>
</div>
</div>
</div>

<!-- Add Process Modal -->
<div id="addProcessModal" class="hidden fixed inset-0 bg-gray-900/50 z-50 items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-900">Iniciar Novo Processo</h3>
            <button onclick="toggleModal('addProcessModal')" class="text-gray-400 hover:text-gray-600"><i
                    data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <form action="{{ url_for('checklists.add_client_process', client_id=client.id) }}" method="POST">
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Selecione o
                    Modelo</label>
                <select name="template_id" required
                    class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                    <option value="">Escolha um fluxo...</option>
                    {% for tpl in process_templates %}
                    <option value="{{ tpl.id }}">{{ tpl.name }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-2">Você pode criar novos modelos em Configurações.</p>
            </div>

            <button type="submit"
                class="w-full bg-northway-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-500/20">
                Iniciar Processo
            </button>
        </form>
    </div>
</div>

<script>
    function startEditMode() {
        const form = document.getElementById('clientForm');
        const inputs = form.querySelectorAll('input, select, textarea');

        // Buttons
        const topEditBtn = document.getElementById('topEditBtn');
        const saveCancelBtns = document.getElementById('saveCancelBtns');

        // Enable inputs
        inputs.forEach(input => {
            input.disabled = false;
            input.classList.remove('disabled:border-none');
            input.classList.add('border-gray-300');
        });

        // Toggle Buttons
        topEditBtn.classList.add('hidden');
        saveCancelBtns.classList.remove('hidden');
    }

    function cancelEditMode() {
        // Simple reload to discard changes or just disable? 
        // Reload is safer to revert data.
        if (confirm("Deseja cancelar a edição? As alterações não salvas serão perdidas.")) {
            location.reload();
        }
    }

    function saveClientForm() {
        document.getElementById('clientForm').submit();
    }

    // Termination Functions
    function openTerminationModal(id, title) {
        document.getElementById('term-contract-id').value = id;
        document.getElementById('term-contract-title').textContent = title;
        document.getElementById('term-due-date').valueAsDate = new Date(); // Default to today
        document.getElementById('termination-modal').classList.remove('hidden');
        document.getElementById('termination-modal').classList.add('flex');
    }

    function closeTerminationModal() {
        document.getElementById('termination-modal').classList.add('hidden');
        document.getElementById('termination-modal').classList.remove('flex');
    }

    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2) + '';
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        input.value = "R$ " + value;
    }

    async function submitTermination(e) {
        e.preventDefault();
        if (!confirm("Tem certeza que deseja rescindir este contrato? Esta ação não pode ser desfeita.")) return;

        const id = document.getElementById('term-contract-id').value;
        const reason = document.getElementById('term-reason').value;
        // Parse currency string: "R$ 1.234,56" -> 1234.56
        const penaltyStr = document.getElementById('term-penalty').value;
        const penalty = penaltyStr ? parseFloat(penaltyStr.replace(/[^\d,]/g, '').replace(',', '.')) : 0;
        const dueDate = document.getElementById('term-due-date').value;

        try {
            const res = await fetch(`/contracts/${id}/terminate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason, penalty, due_date: dueDate })
            });
            const data = await res.json();

            if (res.ok) {
                window.location.reload();
            } else {
                alert("Erro: " + (data.message || "Erro desconhecido"));
            }
        } catch (e) {
            console.error(e);
            alert("Erro de conexão.");
        }
    }

    // Process Checklist Logic
    function toggleProcess(id) {
        const content = document.getElementById(`process-content-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            arrow.classList.add('rotate-180');
            // Re-calculate progress visual on open
            updateProgressVisual(id);
        } else {
            content.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    async function toggleChecklistItem(checklistId, itemIndex, stepIndex, checkbox) {
        const textSpan = checkbox.nextElementSibling;

        // Optimistic UI
        if (checkbox.checked) {
            textSpan.classList.add('line-through', 'text-gray-400');
        } else {
            textSpan.classList.remove('line-through', 'text-gray-400');
        }

        try {
            const res = await fetch(`/api/checklists/${checklistId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step_index: stepIndex,
                    item_index: itemIndex,
                    done: checkbox.checked
                })
            });
            const data = await res.json();
            if (data.success) {
                // Update specific ring
                const ring = document.getElementById(`ring-${checklistId}`);
                ring.setAttribute('stroke-dasharray', `${data.percent}, 100`);
            } else {
                throw new Error(data.error || "Erro no servidor ao salvar.");
            }
        } catch (e) {
            console.error(e);
            alert("Erro ao salvar progresso: " + e.message);
            checkbox.checked = !checkbox.checked; // Revert
        }
    }

    // Initial load progress bars
    document.addEventListener("DOMContentLoaded", () => {
        // Loop through all checklists and set initial progress if needed
        // But actually the backend sends the full object, I just need to compute percentages initialy if I want
        // Simpler: Just rely on toggle updates or pre-calculate in Jinja loop if possible. 
        // For now, let's just calc on load.
        document.querySelectorAll('.process-card').forEach(card => {
            const checkboxes = card.querySelectorAll('input[type="checkbox"]');
            const total = checkboxes.length;
            const checked = Array.from(checkboxes).filter(c => c.checked).length;
            const percent = total === 0 ? 0 : (checked / total * 100);
            const ring = card.querySelector('.progress-ring');
            if (ring) ring.setAttribute('stroke-dasharray', `${percent}, 100`);
        });
    });

    function deleteChecklist(id) {
        if (confirm("Tem certeza que deseja remover este processo? Todo o histórico será perdido.")) {
            fetch(`/api/checklists/${id}/delete`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) window.location.reload();
                });
        }
    }
</script>

<!-- New Interaction Modal and Task Modal -->
{% include "macros_modals.html" ignore missing %}
<!-- Fallback if macros not split, keeping original modals inline if needed. 
     Since I cannot check macros_modals, I will paste the original modals back to be safe. 
-->

<!-- New Interaction Modal (Original) -->
<div id="interactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Interação</h3>
            <button onclick="toggleModal('interactionModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('clients.add_client_interaction', id=client.id) }}" method="POST"
            class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select name="type"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                    <option value="nota">Nota</option>
                    <option value="reuniao">Reunião</option>
                    <option value="ajuste">Ajuste / Suporte</option>
                    <option value="feedback">Feedback</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Conteúdo</label>
                <textarea name="content" rows="4" placeholder="Descreva o que houve..." required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red"></textarea>
            </div>

            <div class="pt-2 flex gap-3">
                <button type="button" onclick="toggleModal('interactionModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Registrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Task Modal (Original) -->
<div id="taskModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Tarefa</h3>
            <button onclick="toggleModal('taskModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('clients.add_client_task', id=client.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                <input type="text" name="title" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data/Hora</label>
                    <input type="datetime-local" name="due_date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                    <select name="responsible_id"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if current_user.id==user.id %}selected{% endif %}>{{ user.name
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" name="is_recurring" id="is_recurring" value="1"
                    class="w-4 h-4 text-northway-red border-gray-300 rounded focus:ring-northway-red">
                <label for="is_recurring" class="text-sm text-gray-700 flex items-center gap-1">
                    <i data-lucide="repeat" class="w-4 h-4 text-gray-500"></i>
                    Repetir mensalmente
                </label>
            </div>

            <div class="pt-2 flex gap-3">
                <button type="button" onclick="toggleModal('taskModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Criar Tarefa
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

<!-- Service Order Modal -->
<div id="serviceOrderModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Ordem de Serviço</h3>
            <button onclick="toggleModal('serviceOrderModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form id="createServiceOrderForm" onsubmit="submitServiceOrder(event)" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Título do Serviço</label>
                <input type="text" name="title" required placeholder="Ex: Criação de Landing Page Extra"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                <input type="number" name="value" step="0.01" min="0" required placeholder="0,00"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição Detalhada</label>
                <textarea name="description" rows="3" placeholder="Detalhes do que será entregue..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red"></textarea>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-700 flex gap-2">
                <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5"></i>
                <p>Ao criar, uma solicitação será registrada. Para gerar a cobrança no Asaas, utilize o módulo
                    financeiro posteriormente ou integre na próxima etapa.</p>
            </div>

            <div class="pt-2 flex gap-3">
                <button type="button" onclick="toggleModal('serviceOrderModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Criar OS
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Cancel OS Modal -->
<div id="cancelOSModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Cancelar OS</h3>
            <button onclick="closeCancelOSModal()" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form id="cancelOSForm" onsubmit="submitCancelOS(event)" class="p-6 space-y-4">
            <input type="hidden" id="cancelOSId" name="id">
            <p class="text-sm text-gray-600">Cancelando: <strong id="cancelOSTitle" class="text-gray-900"></strong></p>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria do Motivo</label>
                <select name="category" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                    <option value="DESISTENCIA_CLIENTE">Desistência do Cliente</option>
                    <option value="ERRO_CADASTRO">Erro de Cadastro</option>
                    <option value="ALTERACAO_ESCOPO">Alteração de Escopo</option>
                    <option value="INADIMPLENCIA">Inadimplência</option>
                    <option value="OUTROS">Outros</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Justificativa</label>
                <textarea name="reason" required rows="3" placeholder="Por que está cancelando?"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red"></textarea>
            </div>

            <div class="flex items-start gap-2 pt-2">
                <div class="flex items-center h-5">
                    <input id="cancel_asaas" name="cancel_asaas" type="checkbox" checked
                        class="focus:ring-northway-red h-4 w-4 text-northway-red border-gray-300 rounded">
                </div>
                <div class="ml-2 text-sm">
                    <label for="cancel_asaas" class="font-medium text-gray-700">Cancelar cobrança no Asaas?</label>
                    <p class="text-gray-500 text-xs">Se houver boleto pendente, ele será removido.</p>
                </div>
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button" onclick="closeCancelOSModal()"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Voltar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Confirmar Cancelamento
                </button>
            </div>
        </form>
    </div>
</div>

{% block scripts %}
<script>
    // Existing Scripts Block...
    async function submitServiceOrder(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.client_id = Number("{{ client.id }}");

        try {
            const res = await fetch('/api/service-orders/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (json.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + json.error);
            }
        } catch (err) {
            alert('Erro de conexão.');
        }
    }

    function openCancelOSModal(id, title) {
        document.getElementById('cancelOSId').value = id;
        document.getElementById('cancelOSTitle').textContent = title;
        const modal = document.getElementById('cancelOSModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeCancelOSModal() {
        const modal = document.getElementById('cancelOSModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    async function submitCancelOS(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.cancel_asaas = form.cancel_asaas.checked;
        const id = document.getElementById('cancelOSId').value;

        if (!confirm("Confirma o cancelamento?")) return;

        try {
            const res = await fetch(`/api/service-orders/${id}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();

            if (json.warnings && json.warnings.length > 0) {
                alert('Aviso: ' + json.warnings.join('\n'));
            }

            if (json.success) {
                window.location.reload();
            } else {
                alert('Erro: ' + json.error);
            }
        } catch (err) {
            alert('Erro de conexão.');
        }
    }
</script>
<script>
    function toggleModal(id) {
        const modal = document.getElementById(id);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    async function signContract(id) {
        if (!confirm("Confirmar que o contrato foi assinado? Isso irá gerar as parcelas financeiras automaticamente.")) return;

        try {
            const res = await fetch(`/contracts/${id}/sign`, { method: 'POST' });
            let data;
            try {
                data = await res.json();
            } catch (err) {
                const text = await res.text();
                console.error("Failed to parse JSON response:", text);
                alert("Erro no servidor (Resposta inválida). Detalhes no console.");
                return;
            }

            if (data.success) {
                window.location.reload();
            } else {
                alert("Erro: " + (data.error || "Desconhecido"));
            }
        } catch (e) {
            alert("Erro de conexão ou execução. Verifique o console.");
            console.error(e);
        }
    }

    // --- WhatsApp Logic (Client) ---
    const pageClientId = parseInt("{{ client.id }}");

    function switchClientTab(tabName) {
        console.log("Switching to tab:", tabName);
        try {
            const tabs = ['details', 'whatsapp', 'financial', 'contracts', 'tasks', 'service-orders', 'diagnostic'];

            // Hide all contents
            tabs.forEach(t => {
                const content = document.getElementById(`content-client-${t}`);
                if (content) {
                    content.classList.add('hidden');
                    content.classList.remove('flex'); // Clear flex if it was there
                }
            });

            // Show selected content
            const selectedContent = document.getElementById(`content-client-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                if (tabName === 'whatsapp') selectedContent.classList.add('flex');
            }

            // Update Tab Styles
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-client-${t}`);
                if (btn) {
                    if (t === tabName) {
                        btn.className = "px-5 py-2.5 text-xs font-bold text-gray-700 bg-white shadow-sm rounded-xl transition-all flex items-center gap-2 border border-gray-100/50 transform scale-105 shadow-md";
                    } else {
                        btn.className = "px-5 py-2.5 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-xl transition-all flex items-center gap-2 hover:bg-white/60";
                    }
                }
            });

            // Load logic
            if (tabName === 'whatsapp') {
                loadClientWhatsAppMessages();
            }

            // Re-run Lucide to ensure icons in new tab are rendered
            if (window.lucide) lucide.createIcons();

        } catch (e) {
            console.error("Error switching tab:", e);
        }
    }

    // Initialize state on load
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Client details JS initialized");
        if (window.lucide) lucide.createIcons();

        // Ensure default tab is processed correctly
        switchClientTab('details');
    });

    async function loadClientWhatsAppMessages(silent = false) {
        const container = document.getElementById('client-chat-messages');
        if (!silent) {
            container.innerHTML = `<div class="flex justify-center">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
</div>`;
        }

        try {
            const response = await fetch(`/api/whatsapp/client/${pageClientId}/messages`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            if (data.messages.length === 0) {
                container.innerHTML = `
<div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
    <i data-lucide="message-square" class="w-10 h-10 mb-2 opacity-50"></i>
    <p class="text-sm">Nenhuma mensagem ainda.</p>
    <p class="text-xs">Inicie a conversa abaixo.</p>
</div>
`;
            } else {
                let lastDate = null;
                const messagesHtml = data.messages.map(msg => {
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = msgDate.toLocaleDateString('pt-BR');
                    let dateHeader = '';

                    if (dateStr !== lastDate) {
                        lastDate = dateStr;
                        dateHeader = `
<div class="flex justify-center my-4">
    <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded shadow-sm font-medium">
        ${dateStr}
    </span>
</div>`;
                    }

                    return `
${dateHeader}
<div class="flex ${msg.direction === 'out' ? 'justify-end' : 'justify-start'} mb-1 group">
    <div class="max-w-[75%] rounded-lg px-3 py-1.5 text-sm shadow-sm relative leading-relaxed ${msg.direction === 'out'
                            ? 'bg-northway-red text-white rounded-tr-none shadow-md'
                            : 'bg-white text-gray-900 rounded-tl-none'
                        }">
        <p>${msg.content}</p>
        <div class="flex justify-end items-center gap-1 -mt-0.5">
            <span class="text-[10px] text-gray-500">${msgDate.toLocaleTimeString([], {
                            hour: '2-digit', minute:
                                '2-digit'
                        })}</span>
            ${msg.direction === 'out' ?
                            (msg.status === 'read' ? '<i data-lucide="check-check" class="w-3 h-3 text-[#53bdeb]"></i>' :
                                msg.status === 'delivered' ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>' :
                                    '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>')
                            : ''}
        </div>

    </div>
</div>
`}).join('');
                container.innerHTML = messagesHtml;
                container.scrollTop = container.scrollHeight;
            }
            if (window.lucide) lucide.createIcons();
        } catch (e) {
            container.innerHTML = `<p class="text-center text-red-500 text-xs">Erro ao carregar: ${e.message}</p>`;
        }
    }

    // --- MEDIA & PORTED LOGIC (Client) ---
    const activeChat = { type: 'client', id: pageClientId };

    function loadMessages(type, id) {
        // Wrapper for existing loader
        return loadClientWhatsAppMessages(true);
    }

    // Media Vars
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let selectedFile = null;

    // UI Toggles
    const inputArea = document.getElementById('message-input');
    const btnMic = document.getElementById('btn-mic');
    const btnSend = document.getElementById('btn-send');

    // Auto-switch Mic/Send icon
    if (inputArea) {
        inputArea.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                btnMic.classList.add('hidden');
                btnSend.classList.remove('hidden');
            } else {
                btnMic.classList.remove('hidden');
                btnSend.classList.add('hidden');
            }
        });

        // Handle Enter
        inputArea.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // Toggle Attach Menu
    function toggleAttachMenu() {
        const menu = document.getElementById('attach-menu');
        menu.classList.toggle('hidden');
    }

    // Recording Logic
    async function toggleRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert('Seu navegador não suporta gravação de áudio.');
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.start();

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex'); // Important for flex layout
            document.getElementById('toolbar-recording').classList.remove('hidden');
            document.getElementById('toolbar-recording').classList.add('flex');

            // Timer
            let seconds = 0;
            const timerEl = document.getElementById('recording-time');
            timerEl.textContent = "0:00";
            if (recordingTimer) clearInterval(recordingTimer);
            recordingTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);

        } catch (err) {
            console.error(err);
            alert('Permissão de microfone negada ou erro ao iniciar.');
        }
    }

    function cancelRecording() {
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
        clearInterval(recordingTimer);
        resetToolbar();
    }

    function stopAndSendRecording() {
        if (!mediaRecorder) return;

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await uploadMedia(audioBlob, 'audio.webm', 'audio');
            resetToolbar();
        };

        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        clearInterval(recordingTimer);
    }

    // File Logic
    function triggerFile(accept) {
        const input = document.getElementById('file-input');
        input.accept = accept;
        input.click();
        document.getElementById('attach-menu').classList.add('hidden');
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            selectedFile = input.files[0];

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex');
            document.getElementById('toolbar-file').classList.remove('hidden');
            document.getElementById('toolbar-file').classList.add('flex');
            document.getElementById('file-name').textContent = selectedFile.name;
        }
    }

    function cancelFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        resetToolbar();
    }

    async function sendFile() {
        if (!selectedFile) return;
        await uploadMedia(selectedFile, selectedFile.name, 'file');
        cancelFile();
    }

    function resetToolbar() {
        document.getElementById('toolbar-default').classList.remove('hidden');
        document.getElementById('toolbar-default').classList.add('flex');

        document.getElementById('toolbar-recording').classList.add('hidden');
        document.getElementById('toolbar-recording').classList.remove('flex');

        document.getElementById('toolbar-file').classList.add('hidden');
        document.getElementById('toolbar-file').classList.remove('flex');
    }

    async function uploadMedia(file, filename, type) {
        // Optimistic Loading? Maybe later.
        const btn = document.getElementById('btn-attach'); // just a visual anchor
        const originalHtml = btn.innerHTML;
        btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-gray-500 rounded-full border-t-transparent"></div>`;

        try {
            const formData = new FormData();
            formData.append('file', file, filename);
            formData.append('client_id', pageClientId); // Explicitly use pageClientId
            formData.append('type', type);

            const res = await fetch('/api/whatsapp/send-media', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            loadClientWhatsAppMessages();
        } catch (e) {
            alert('Erro ao enviar mídia: ' + e.message);
        } finally {
            btn.innerHTML = originalHtml;
        }
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;

        input.value = '';
        input.focus();

        // Reset toggle
        btnMic.classList.remove('hidden');
        btnSend.classList.add('hidden');

        try {
            const response = await fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_id: pageClientId, content: content })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            loadClientWhatsAppMessages();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    }

    // Rich Text Helper (Standardized)
    function insertFormat(char) {
        const input = document.getElementById('message-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const txt = input.value;

        if (start === end) {
            input.value = txt.substring(0, start) + char + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + char.length;
        } else {
            const wrapped = char + txt.substring(start, end) + char;
            input.value = txt.substring(0, start) + wrapped + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = end + (char.length * 2);
        }

        // Trigger input event to update mic/send
        input.dispatchEvent(new Event('input'));
    }

    function copyDiagnosticLink(url) {
        if (!url) return;
        navigator.clipboard.writeText(url).then(() => {
            // Create a temporary toast or alert
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm font-medium transition-opacity duration-300';
            toast.textContent = 'Link copiado com sucesso!';
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            prompt("Copie o link manualmente:", url);
        });
    }
</script>
<!-- Delegate Process Modal -->
<div id="delegateProcessModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Delegar Processo</h3>
            <button data-close-modal="delegateProcessModal" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
            </button>
        </div>
        <form id="delegateProcessForm" method="POST" class="p-6 space-y-4">
            <p class="text-sm text-gray-600 mb-4">
                Delegar o processo <strong id="delegateProcessName"></strong> para outro colaborador.
                Isso também transferirá todas as tarefas pendentes para o novo responsável.
            </p>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Novo Responsável</label>
                <!-- We need a list of users. Assuming 'users' might NOT be in context here (client_details often has it?) 
                     Lets check context. client_details usually has current_user. We might need to pass users via route or fetch via AJAX.
                     However, tasks.html had users. Let's assume we need to inject users into client_details route or use account_manager/company.users relationship if available in template. 
                     Wait, company.users is available via current_user.company.users usually. -->
                <select name="assigned_to_id"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                    <option value="">Selecione...</option>
                    {% for user in current_user.company.users %}
                    <option value="{{ user.id }}">{{ user.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="pt-4 flex gap-3">
                <button type="button" data-close-modal="delegateProcessModal"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                    Confirmar Delegação
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function openDelegateModal(id, name, assignedToId) {
        const modal = document.getElementById('delegateProcessModal');
        const form = document.getElementById('delegateProcessForm');
        const nameSpan = document.getElementById('delegateProcessName');

        nameSpan.textContent = name;
        form.action = `/checklists/${id}/reassign`;

        // Pre-select if possible
        if (assignedToId) {
            const select = form.querySelector('select[name="assigned_to_id"]');
            if (select) select.value = assignedToId;
        }

        if (typeof toggleModal === 'function') {
            toggleModal('delegateProcessModal');
        } else {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }
</script>

<!-- Create Drive Folders Modal -->
<div id="createDriveFoldersModal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Criar Pastas no Drive</h3>
            <button onclick="toggleModal('createDriveFoldersModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form action="{{ url_for('clients.create_drive_folder', id=client.id) }}" method="POST" class="p-6 space-y-4">
            <p class="text-sm text-gray-600 mb-4">
                Selecione um modelo para criar a estrutura de pastas no Google Drive para este cliente.
                Isso criará a pasta principal (se não existir) e as subpastas definidas no modelo.
            </p>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Modelo de Pastas</label>
                <select name="drive_template_id" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                    <option value="">Selecione...</option>
                    {% if drive_templates %}
                    {% for t in drive_templates %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="pt-4 flex gap-3">
                <button type="button" onclick="toggleModal('createDriveFoldersModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                    Criar Pastas
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}