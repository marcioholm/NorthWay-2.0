{% extends "base.html" %}

{% block content %}
<div class="flex-1 h-screen overflow-y-auto bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Configurações</h1>

        <!-- Settings Navigation -->
        <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg mb-8 w-fit overflow-x-auto">
            <a href="{{ url_for('main.company_settings') }}"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-900 whitespace-nowrap">
                Dados da Empresa
            </a>
            <a href="{{ url_for('main.settings_templates') }}"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-900 whitespace-nowrap">
                Modelos de Contrato
            </a>
            <a href="{{ url_for('main.settings_integrations') }}"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm whitespace-nowrap">
                Integrações (API)
            </a>
            <!-- Placeholder for Permissions/Users if needed -->
            <!-- <a href="#" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900">Usuários</a> -->
        </div>

        <!-- Google Maps Integration Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center">
                        <i data-lucide="map-pin" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">Google Maps Platform</h2>
                        <p class="text-xs text-gray-500">Places API para prospecção de leads</p>
                    </div>
                </div>
                <div>
                    {% if integrations_map.get('google_maps') and integrations_map.get('google_maps').is_active %}
                    <span
                        class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wide">Ativo</span>
                    {% else %}
                    <span
                        class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wide">Inativo</span>
                    {% endif %}
                </div>
            </div>

            <div class="p-6">
                {% if integrations_map.get('google_maps') and integrations_map.get('google_maps').is_active %}
                <!-- Active State -->
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="truncate mr-4">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">API Key Configurada</p>
                        <p class="text-sm font-mono text-gray-700 truncate max-w-md">
                            {{ integrations_map.get('google_maps').api_key[:8] }}*************************
                        </p>
                    </div>
                    <form action="{{ url_for('main.delete_integration', service='google_maps') }}" method="POST"
                        onsubmit="return confirm('Tem certeza? A busca de empresas vai parar de funcionar.')">
                        <button type="submit"
                            class="text-red-600 hover:text-red-700 text-sm font-medium flex items-center gap-2 hover:bg-red-50 px-3 py-2 rounded transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Remover
                        </button>
                    </form>
                </div>
                <p class="text-xs text-gray-400 mt-2">Para alterar a chave, remova a atual e adicione uma nova.</p>

                {% else %}
                <!-- Setup Form -->
                <form action="{{ url_for('main.settings_integrations') }}" method="POST">
                    <input type="hidden" name="service" value="google_maps">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">API Key</label>
                            <input type="password" name="api_key" required placeholder="AIzaSy..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-mono text-sm">
                            <p class="text-xs text-gray-500 mt-1">
                                É necessário habilitar a <strong>Places API (New)</strong> no seu Google Cloud Console.
                            </p>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="bg-gray-900 text-white px-6 py-2 rounded-lg font-bold hover:bg-black transition-colors shadow-sm">
                                Salvar Integração
                            </button>
                        </div>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- WhatsApp Z-API Integration Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 relative overflow-hidden">

            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-50 text-green-600 rounded-full flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">WhatsApp (Z-API)</h2>
                        <p class="text-xs text-gray-500">Envio e recebimento de mensagens</p>
                    </div>
                </div>
                <div>
                    {% set zapi = integrations_map.get('z_api') %}
                    {% if zapi and zapi.is_active %}
                    <span
                        class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wide">Conectado</span>
                    {% else %}
                    <span
                        class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wide">Desconectado</span>
                    {% endif %}
                </div>
            </div>

            <div class="p-6">
                {% if zapi and zapi.is_active %}
                <!-- Active State -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Instance ID</p>
                        <p class="text-sm font-mono text-gray-700 text-ellipsis overflow-hidden">{{ zapi.config_json |
                            from_json | attr('instance_id') }}</p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">Token</p>
                        <p
                            class="text-sm font-mono text-gray-700 blur-sm hover:blur-none transition-all cursor-pointer truncate">
                            {{ zapi.api_key }}</p>
                    </div>
                </div>

                <div class="mt-6 flex items-center gap-4 bg-gray-50 p-4 rounded-lg">
                    <div class="flex-1">
                        <h3 class="text-sm font-bold text-gray-900">Webhook URL</h3>
                        <p class="text-xs text-gray-500 mb-2">Configure esta URL na Z-API para receber mensagens.</p>
                        <div class="flex items-center gap-2">
                            <code
                                class="bg-white px-2 py-1 rounded border border-gray-200 text-xs font-mono text-gray-600 w-full truncate"
                                id="webhookUrl">
                                     {{ request.url_root }}api/webhooks/zapi/{{ company.id }}
                                 </code>
                            <button
                                onclick="navigator.clipboard.writeText(document.getElementById('webhookUrl').innerText.trim())"
                                class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-2">
                    <form action="{{ url_for('whatsapp.test_connection') }}" method="POST" target="_blank">
                        <button type="submit"
                            class="text-gray-600 hover:text-gray-900 text-sm font-medium px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Testar Conexão / QR Code
                        </button>
                    </form>

                    <form action="{{ url_for('main.delete_integration', service='z_api') }}" method="POST"
                        onsubmit="return confirm('Isso irá interromper o funcionamento do WhatsApp. Tem certeza?')">
                        <button type="submit"
                            class="text-red-600 hover:text-red-700 text-sm font-medium px-4 py-2 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
                            Desconectar
                        </button>
                    </form>
                </div>

                {% else %}
                <!-- Setup Form -->
                <form action="{{ url_for('whatsapp.configure') }}" method="POST" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Link da API (Opcional)</label>
                        <input type="text" name="api_url" value="{{ zapi_config.api_url or 'https://api.z-api.io' }}"
                            placeholder="https://api.z-api.io"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500 text-sm">
                        <p class="text-xs text-gray-500 mt-1">Deixe padrão ou altere se utilizar uma instância privada.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Instance ID</label>
                            <input type="text" name="instance_id" value="{{ zapi_config.instance_id or '' }}" required
                                placeholder="3B2D..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Z-API Token (Security
                                Token)</label>
                            <input type="password" name="token" required placeholder="Security Token da URL"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-mono text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Client Token (Opcional)</label>
                            <input type="password" name="client_token" value="{{ zapi_config.client_token or '' }}"
                                placeholder="Client Token (Header)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-mono text-sm">
                            <p class="text-[10px] text-gray-500 mt-1">Preencha apenas se "Client Token" estiver ativado
                                na Z-API.</p>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors shadow-sm flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Salvar e Conectar
                        </button>
                    </div>
                </form>
                <div class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-lg text-xs">
                    <p class="font-bold mb-1">Passo a passo:</p>
                    <ol class="list-decimal pl-4 space-y-1">
                        <li>Crie uma conta na Z-API.</li>
                        <li>Crie uma instância e copie o ID e Token.</li>
                        <li>Cole acima e salve.</li>
                        <li>Use o botão "Testar Conexão" para ler o QR Code se necessário.</li>
                    </ol>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endblock %}