{% extends "base.html" %}

{% block content %}
<div id="layout-wrapper" class="flex h-screen bg-gray-100 overflow-hidden">
    <!-- Top Bar actions -->
    <div
        class="fixed top-0 left-0 w-full h-16 bg-white border-b border-gray-200 z-40 flex items-center justify-between px-8 print:hidden">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('clients.client_details', id=contract.client_id) }}"
                class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-black hover:bg-gray-100 transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold text-gray-900">
                    Visualizar Contrato
                    <span class="font-mono text-gray-600 ml-2 bg-gray-100 px-2 py-0.5 rounded text-lg">{{ contract.code
                        if contract.code else ('#' ~ contract.id) }}</span>
                </h1>
                <p class="text-xs text-gray-500">Emitido em {{ contract.created_at.strftime('%d/%m/%Y') }}</p>
            </div>
        </div>
        <div class="flex gap-2">
            {% if contract.status != 'cancelled' %}
            <a href="{{ url_for('contracts.edit_contract', id=contract.id) }}"
                class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="edit-3" class="w-4 h-4"></i>
                Editar
            </a>

            <button onclick="document.getElementById('cancelModal').classList.remove('hidden')"
                class="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="x-circle" class="w-4 h-4"></i>
                Cancelar Contrato
            </button>
            {% else %}
            <span
                class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide flex items-center gap-1">
                <i data-lucide="x-circle" class="w-3 h-3"></i> Cancelado
            </span>
            {% endif %}

            <button onclick="window.print()"
                class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-black transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                <i data-lucide="printer" class="w-4 h-4"></i>
                Imprimir / Salvar PDF
            </button>
        </div>
    </div>

    <!-- Cancellation Modal -->
    <div id="cancelModal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-red-600 mb-2 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i> Cancelar Contrato
            </h3>
            <p class="text-sm text-gray-600 mb-4">
                Tem certeza que deseja cancelar este contrato? <br>
                <strong class="text-gray-900">Cobranças pendentes no ASAAS serão removidas.</strong>
            </p>

            <form action="{{ url_for('contracts.terminate_contract', id=contract.id) }}" method="POST">
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <label class="flex items-center gap-2 cursor-pointer mb-2">
                        <input type="checkbox" name="charge_fee" id="chargeFeeCheck"
                            class="rounded text-red-600 focus:ring-red-500 border-gray-300"
                            onchange="toggleFeeInputs(this)">
                        <span class="text-sm font-bold text-gray-800">Cobrar Multa Rescisória?</span>
                    </label>
                    <div id="feeInputs" class="hidden space-y-3 mt-2 pl-6 border-l-2 border-gray-200">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor da Multa</label>
                            <input type="text" name="fee_amount" placeholder="R$ 0,00"
                                class="w-full text-sm border-gray-300 rounded focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data de
                                Vencimento</label>
                            <input type="date" name="fee_due_date"
                                class="w-full text-sm border-gray-300 rounded focus:ring-red-500 focus:border-red-500"
                                value="{{ today }}">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="document.getElementById('cancelModal').classList.add('hidden')"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">
                        Voltar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold shadow-sm">
                        Confirmar Cancelamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function toggleFeeInputs(checkbox) {
            const container = document.getElementById('feeInputs');
            if (checkbox.checked) {
                container.classList.remove('hidden');
                container.querySelector('input[name="fee_amount"]').setAttribute('required', 'true');
                container.querySelector('input[name="fee_due_date"]').setAttribute('required', 'true');
            } else {
                container.classList.add('hidden');
                container.querySelector('input[name="fee_amount"]').removeAttribute('required');
                container.querySelector('input[name="fee_due_date"]').removeAttribute('required');
            }
        }
    </script>


    <!-- Main Content Area (Scrollable) -->
    <div id="scroll-container"
        class="flex-1 h-full overflow-y-auto bg-slate-200 relative pt-24 pb-20 flex flex-col items-center justify-start min-h-screen custom-scrollbar">

        <!-- Source Content (Hidden) -->
        <div id="source-content" class="hidden">
            {{ contract.generated_content | safe }}
        </div>

        <!-- Pages Container -->
        <div id="pages-container" class="flex flex-col gap-8 items-center">
            <!-- JS will render pages here -->
            <div
                class="w-[210mm] h-[297mm] bg-white shadow-2xl relative flex flex-col items-center justify-center text-gray-300 animate-pulse">
                <i data-lucide="file-text" class="w-16 h-16 mb-4 opacity-20"></i>
                <p class="font-sans text-sm font-medium">Renderizando...</p>
            </div>
        </div>

        <p
            class="text-slate-400 text-xs font-medium fixed bottom-4 right-8 bg-slate-200/80 px-2 py-1 rounded print:hidden">
            Visualização de Impressão (A4)
        </p>
    </div>
</div>

<style>
    /* Force Print configuration */
    @page {
        size: A4;
        margin: 0;
    }

    /* Document Stylings - MATCHES new_contract.html */
    .a4-page {
        width: 210mm;
        height: 297mm;
        background: white;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        position: relative;
        padding-top: 30mm;
        padding-bottom: 20mm;
        padding-left: 30mm;
        padding-right: 20mm;
        overflow: hidden;
        flex-shrink: 0;
    }

    /* Mobile Scale */
    @media (max-width: 768px) {
        .a4-page {
            transform: scale(0.6);
            transform-origin: top center;
            margin-bottom: -100mm;
            /* Compensate for empty space after scale */
        }

        #pages-container {
            width: 100%;
            overflow-x: hidden;
        }
    }

    @media (max-width: 480px) {
        .a4-page {
            transform: scale(0.45);
            margin-bottom: -150mm;
        }
    }

    .a4-content {
        font-family: Arial, Helvetica, sans-serif !important;
        font-size: 12pt;
        line-height: 1.5;
        color: #000;
        height: 100%;
    }

    /* Standard Elements */
    .a4-content p {
        margin-bottom: 6pt;
        text-align: justify;
        text-align-last: left;
        text-indent: 0;
    }

    .a4-content h1,
    .a4-content h2,
    .a4-content h3,
    .a4-content strong,
    .a4-content b {
        font-family: Arial, Helvetica, sans-serif !important;
        font-size: 12pt;
        font-weight: bold;
        text-align: justify;
        margin-bottom: 6pt;
        text-indent: 0;
    }

    .a4-content h1 {
        text-transform: uppercase;
        text-align: center;
        margin-bottom: 24pt;
    }

    .a4-content ul {
        list-style-type: disc;
        padding-left: 2cm;
        margin-bottom: 6pt;
    }

    .a4-content ol {
        list-style-type: decimal;
        padding-left: 2cm;
        margin-bottom: 6pt;
    }

    @media print {

        /* 1. Reset Global Page/Body */
        @page {
            size: A4;
            margin: 0;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 210mm !important;
            height: auto !important;
            background: white !important;
            overflow: visible !important;
        }

        /* Hide UI */
        aside,
        header,
        nav,
        footer,
        #splash-screen,
        #mobile-sidebar-overlay,
        #toast-container,
        .no-print,
        .print\:hidden,
        #layout-wrapper>*:not(#scroll-container),
        #layout-wrapper>.fixed,
        /* Target the local top bar specifics */
        .fixed,
        /* Generic fixed elements */
        .z-40,
        /* Header z-index */
        .z-50

        /* Mobile header z-index */
            {
            display: none !important;
        }

        /* Unwrap Structure */
        #layout-wrapper,
        #scroll-container,
        #pages-container {
            width: 100% !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            overflow: visible !important;
            position: static !important;
            background: white !important;
        }

        /* 4. Strict A4 Page Definition */
        .a4-page {
            width: 210mm !important;
            height: 296mm !important;
            /* Slightly less than 297mm to prevent blank pages */
            margin: 0 !important;
            padding: 30mm 20mm 20mm 30mm !important;
            /* Top Right Bottom Left */

            page-break-after: always;
            break-after: page;

            overflow: hidden !important;
            position: relative !important;
            border: none !important;
            box-shadow: none !important;
            box-sizing: border-box !important;

            /* Ensure colors print correctly */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Remove break from last page */
        .a4-page:last-child {
            page-break-after: auto;
            break-after: auto;
        }

        /* 5. Ensure Content */
        .a4-content {
            width: 100% !important;
            height: auto !important;
            color: black !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const source = document.getElementById('source-content').innerHTML;
        renderPaginatedContent(source);

        if (window.lucide) window.lucide.createIcons();
    });

    function createA4Page(pageNum) {
        const page = document.createElement('div');
        page.className = 'a4-page';
        page.id = 'page-' + pageNum;

        const content = document.createElement('div');
        content.className = 'a4-content ql-editor'; // ql-editor class keeps Quill styles if needed
        page.appendChild(content);

        return page;
    }

    function hasOverflow(element) {
        return element.scrollHeight > element.clientHeight + 1;
    }

    function renderPaginatedContent(htmlContent) {
        const container = document.getElementById('pages-container');
        if (!container) return;

        container.innerHTML = '';

        const sourceDiv = document.createElement('div');
        sourceDiv.innerHTML = htmlContent;

        let nodes = Array.from(sourceDiv.childNodes);

        let pageNum = 1;
        let currentPage = createA4Page(pageNum);
        container.appendChild(currentPage);
        let currentContentArea = currentPage.querySelector('.a4-content');

        nodes.forEach(node => {
            if (node.nodeType === 3 && node.textContent.trim() === '') return;

            const clone = node.cloneNode(true);
            currentContentArea.appendChild(clone);

            if (hasOverflow(currentContentArea)) {
                currentContentArea.removeChild(clone);

                if (node.nodeType === 1 && node.tagName === 'P') {
                    const words = node.innerText.split(' ');
                    let currentWordIndex = 0;

                    while (currentWordIndex < words.length) {
                        const pChunk = document.createElement('p');

                        // Copy attributes (styles etc)
                        for (let attr of node.attributes) {
                            pChunk.setAttribute(attr.name, attr.value);
                        }

                        // Fix indent on split parts
                        if (currentWordIndex > 0) pChunk.style.textIndent = '0';

                        currentContentArea.appendChild(pChunk);

                        let chunkWords = [];
                        let overflowDetected = false;

                        for (let i = currentWordIndex; i < words.length; i++) {
                            chunkWords.push(words[i]);
                            pChunk.innerText = chunkWords.join(' ');

                            if (hasOverflow(currentContentArea)) {
                                chunkWords.pop();
                                pChunk.innerText = chunkWords.join(' ');

                                if (chunkWords.length === 0) {
                                    currentContentArea.removeChild(pChunk);

                                    pageNum++;
                                    currentPage = createA4Page(pageNum);
                                    container.appendChild(currentPage);
                                    currentContentArea = currentPage.querySelector('.a4-content');

                                    overflowDetected = true;
                                    break;
                                }

                                currentWordIndex = i;
                                overflowDetected = true;
                                break;
                            }
                        }

                        if (!overflowDetected) {
                            currentWordIndex = words.length;
                        }

                        else {
                            if (chunkWords.length > 0) {
                                pageNum++;
                                currentPage = createA4Page(pageNum);
                                container.appendChild(currentPage);
                                currentContentArea = currentPage.querySelector('.a4-content');
                            }
                        }
                    }
                }

                else {
                    // Non-splittable block (e.g. Header div, Table, or Image)
                    // Move entire block to next page
                    pageNum++;
                    currentPage = createA4Page(pageNum);
                    container.appendChild(currentPage);
                    currentContentArea = currentPage.querySelector('.a4-content');
                    currentContentArea.appendChild(clone);
                }
            }
        });
    }

</script>
{% endblock %}