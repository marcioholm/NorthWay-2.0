{% extends "base.html" %}

{% block content %}
<div class="flex-1 h-screen overflow-x-auto bg-gray-100 p-8">
    <header class="mb-8 flex justify-between items-center">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-3xl font-bold text-gray-900">Funil:</h1>

                <!-- Pipeline Switcher -->
                <div class="relative group">
                    <button class="flex items-center gap-1 text-3xl font-bold text-northway-red hover:opacity-80">
                        {{ active_pipeline.name }}
                        <i data-lucide="chevron-down" class="w-6 h-6"></i>
                    </button>

                    <!-- Dropdown -->
                    <div
                        class="absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-100 hidden group-hover:block z-50 before:block before:absolute before:-top-2 before:left-0 before:w-full before:h-2 before:bg-transparent">
                        <div class="p-2 space-y-1">
                            {% for p in pipelines %}
                            <a href="{{ url_for('leads.pipeline', pipeline_id=p.id) }}"
                                class="block px-3 py-2 rounded-md hover:bg-gray-50 text-gray-700 {{ 'bg-red-50 text-northway-red font-medium' if p.id == active_pipeline.id else '' }}">
                                {{ p.name }}
                            </a>
                            {% endfor %}

                            {% if current_user.role == 'admin' %}
                            <div class="border-t border-gray-100 my-1"></div>
                            <button onclick="toggleModal('createPipelineModal')"
                                class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50 text-northway-red font-bold flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                Criar Novo Funil
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-gray-500 mt-1">Gerencie suas oportunidades</p>
        </div>
    </header>

    <div class="flex gap-6 h-[calc(100vh-12rem)] pb-4">
        {% for stage in stages %}
        <div class="flex-shrink-0 w-80 flex flex-col bg-gray-50 rounded-lg border border-gray-200 shadow-sm max-h-full">
            <!-- Column Header -->
            <div class="p-4 border-b border-gray-100 flex items-center justify-between group/header relative">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-gray-700" id="stage-name-{{ stage.id }}">{{ stage.name }}</h3>

                    {% if current_user.role == 'admin' %}
                    <!-- Edit Button -->
                    <button onclick="editStage('{{ stage.id }}', '{{ stage.name }}')"
                        class="text-gray-400 hover:text-blue-500 opacity-0 group-hover/header:opacity-100 transition-opacity">
                        <i data-lucide="pencil" class="w-3 h-3"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="flex items-center gap-2">
                    <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-medium">
                        {{ leads|selectattr("pipeline_stage_id", "equalto", stage.id)|list|length }}
                    </span>

                    {% if current_user.role == 'admin' %}
                    <!-- Delete Button -->
                    <form action="{{ url_for('leads.delete_stage', id=stage.id) }}" method="POST"
                        onsubmit="return confirm('Excluir esta etapa? (Somente se estiver vazia)')" class="inline-flex">
                        <button type="submit"
                            class="text-gray-400 hover:text-red-500 opacity-0 group-hover/header:opacity-100 transition-opacity">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>

                <!-- Rename Form (Hidden by default) -->
                <form id="edit-form-{{ stage.id }}" action="{{ url_for('leads.update_stage', id=stage.id) }}"
                    method="POST"
                    class="hidden absolute bg-white shadow-lg p-2 rounded-lg border border-gray-200 z-10 top-2 left-2 right-2">
                    <input type="text" name="name" value="{{ stage.name }}"
                        class="w-full text-sm border-gray-300 rounded focus:ring-northway-red focus:border-northway-red mb-2">
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="cancelEdit('{{ stage.id }}')"
                            class="text-xs text-gray-500">Cancelar</button>
                        <button type="submit"
                            class="text-xs bg-northway-red text-white px-2 py-1 rounded">Salvar</button>
                    </div>
                </form>
            </div>

            <!-- Cards Container -->
            <div class="flex-1 overflow-y-auto p-3 space-y-3">
                {% for lead in leads if lead.pipeline_stage_id == stage.id %}
                <div onclick="openLeadModal(this)" data-id="{{ lead.id }}" data-name="{{ lead.name }}"
                    data-phone="{{ lead.phone or '' }}" data-email="{{ lead.email or '' }}"
                    data-website="{{ lead.website or '' }}" data-address="{{ lead.address or '' }}"
                    data-interest="{{ lead.interest or '' }}" data-bant-budget="{{ lead.bant_budget or '' }}"
                    data-bant-authority="{{ lead.bant_authority or '' }}" data-bant-need="{{ lead.bant_need or '' }}"
                    data-bant-timeline="{{ lead.bant_timeline or '' }}"
                    class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-l-[6px] transition-all duration-200 cursor-pointer relative group {{ 'border-l-4 border-l-red-500 animate-pulse' if lead.days_inactive > 5 else 'border-l-4 border-l-northway-red' }} active:scale-[0.98]">

                    {% if lead.days_inactive > 5 %}
                    <div class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-md z-10"
                        title="Sem interação há {{ lead.days_inactive }} dias!">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    </div>
                    {% endif %}
                    <h4 class="font-medium text-gray-900 group-hover:text-northway-red transition-colors">{{ lead.name
                        }}</h4>
                    <p class="text-xs text-gray-500 mt-1">{{ lead.phone or 'Sem telefone' }}</p>

                    <div class="mt-2 flex gap-2 text-xs text-gray-400">
                        {% if lead.website %}
                        <i data-lucide="globe" class="w-3 h-3 text-blue-400" title="Possui Site"></i>
                        {% endif %}
                        {% if lead.address %}
                        <i data-lucide="map-pin" class="w-3 h-3 text-red-400" title="Possui Endereço"></i>
                        {% endif %}
                    </div>

                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-400 font-medium group-hover:text-gray-600 transition-colors">{{
                            lead.created_at.strftime('%d/%m') }}</span>
                        <!-- Move actions -->
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                            <!-- Move Back -->
                            <form action="{{ url_for('leads.move_lead', id=lead.id, direction='prev') }}" method="POST"
                                class="inline">
                                <button type="submit"
                                    class="w-6 h-6 rounded hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-northway-red transition-colors"
                                    title="Voltar Etapa" onclick="event.stopPropagation()">
                                    <i data-lucide="arrow-left" class="w-3 h-3"></i>
                                </button>
                            </form>

                            <!-- Move Next -->
                            <form action="{{ url_for('leads.move_lead', id=lead.id, direction='next') }}" method="POST"
                                class="inline">
                                <button type="submit"
                                    class="w-6 h-6 rounded hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-northway-red transition-colors"
                                    title="Avançar Etapa" onclick="event.stopPropagation()">
                                    <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div
                    class="h-32 flex flex-col items-center justify-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50/50">
                    <i data-lucide="target" class="w-6 h-6 text-gray-300 mb-2"></i>
                    <p class="text-xs font-semibold text-gray-400 text-center px-4">Funil vazio</p>
                    <p class="text-[10px] text-gray-300 text-center mt-0.5">Hora de prospectar!</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Add New Stage Column -->
        {% if current_user.role == 'admin' %}
        <div class="flex-shrink-0 w-80 flex flex-col items-center justify-center bg-transparent rounded-lg border-2 border-dashed border-gray-300 hover:border-northway-red hover:bg-red-50 transition-colors cursor-pointer group"
            onclick="toggleModal('createStageModal')">
            <div class="text-center">
                <div
                    class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-gray-400 group-hover:text-northway-red shadow-sm mb-3 mx-auto">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </div>
                <h3 class="font-bold text-gray-500 group-hover:text-northway-red">Nova Etapa</h3>
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>

<!-- Create Pipeline Modal -->
<div id="createPipelineModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Novo Funil de Vendas</h3>
            <button onclick="toggleModal('createPipelineModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('leads.create_pipeline') }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Funil *</label>
                <input type="text" name="name" required placeholder="Ex: Pós-Venda, Marketing, Parcerias"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button" onclick="toggleModal('createPipelineModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                    Criar Funil
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lead Details/BANT Modal -->
<div id="leadModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[60]">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div>
                <h3 class="text-xl font-bold text-gray-900" id="modalLeadName">Lead Name</h3>
                <p class="text-sm text-gray-500" id="modalLeadPhone">Phone</p>
            </div>
            <button onclick="toggleModal('leadModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="px-6 border-b border-gray-100 flex gap-4">
            <button onclick="switchTab('details')" id="tab-details"
                class="py-2 px-1 text-sm font-bold text-northway-red border-b-2 border-northway-red transition-colors">Detalhes</button>
            <button onclick="switchTab('whatsapp')" id="tab-whatsapp"
                class="py-2 px-1 text-sm font-bold text-gray-500 hover:text-gray-900 border-b-2 border-transparent transition-colors flex items-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
            </button>
        </div>

        <div class="p-6">
            <!-- Details Tab -->
            <div id="content-details">
                <!-- Contact Info Form -->
                <form id="infoForm" method="POST" class="mb-6 border-b border-gray-100 pb-6">
                    <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                        Informações de Contato
                    </h4>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">E-mail</label>
                            <input type="email" name="email" id="modalInputEmail"
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Telefone</label>
                            <input type="text" name="phone" id="modalInputPhone"
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Website</label>
                            <input type="text" name="website" id="modalInputWebsite" placeholder="https://..."
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Origem</label>
                            <input type="text" name="source" id="modalInputSource"
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Endereço</label>
                            <input type="text" name="address" id="modalInputAddress"
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Interesse</label>
                            <input type="text" name="interest" id="modalInputInterest"
                                class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                        </div>
                    </div>

                    <div class="flex justify-end mt-3">
                        <button type="submit"
                            class="text-xs bg-gray-600 text-white px-3 py-1.5 rounded hover:bg-gray-700 font-bold uppercase tracking-wider">
                            Salvar Info
                        </button>
                    </div>
                </form>

                <form id="bantForm" method="POST">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- BANT Fields -->
                        <div class="col-span-2">
                            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <span class="bg-northway-red text-white text-xs px-2 py-1 rounded">BANT</span>
                                Qualificação
                            </h4>
                        </div>

                        <!-- Budget -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Budget (Orçamento)</label>
                            <input type="text" name="bant_budget" id="bantBudget" placeholder="Ex: R$ 5k - 10k"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                        </div>

                        <!-- Authority -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Authority (Autoridade)</label>
                            <select name="bant_authority" id="bantAuthority"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                                <option value="">Selecione...</option>
                                <option value="Decisor">Decisor</option>
                                <option value="Influenciador">Influenciador</option>
                                <option value="Usuário">Usuário</option>
                                <option value="Sem poder">Sem poder de decisão</option>
                            </select>
                        </div>

                        <!-- Timeline -->
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Timeline (Prazo)</label>
                            <select name="bant_timeline" id="bantTimeline"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                                <option value="">Selecione...</option>
                                <option value="Imediato">Imediato (Essa semana)</option>
                                <option value="Curto Prazo">Curto Prazo (1 mês)</option>
                                <option value="Médio Prazo">Médio Prazo (3 meses)</option>
                                <option value="Longo Prazo">Longo Prazo (+6 meses)</option>
                            </select>
                        </div>

                        <!-- Need -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Need (Necessidade)</label>
                            <textarea name="bant_need" id="bantNeed" rows="3"
                                placeholder="Descreva a dor ou necessidade específica do cliente..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                        <a href="#" id="viewFullDetails"
                            class="px-4 py-2 text-northway-red hover:bg-red-50 rounded-lg transition-colors font-medium flex items-center gap-2">
                            Ver Detalhes Completos <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </a>
                        <button type="submit"
                            class="px-6 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-sm">
                            Salvar BANT
                        </button>
                    </div>
                </form>
            </div>

            <!-- WhatsApp Tab -->
            <div id="content-whatsapp" class="hidden h-[500px] flex flex-col">
                <!-- Chat Area -->
                <div id="chat-messages"
                    class="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4 mb-4 border border-gray-100 space-y-3">
                    <div class="flex justify-center">
                        <span class="bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded-full">Carregando
                            histórico...</span>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex gap-2 items-end">
                    <div
                        class="flex-1 bg-white rounded-lg border border-gray-300 overflow-hidden focus-within:ring-2 focus-within:ring-green-500/20 focus-within:border-green-500">
                        <textarea id="whatsappInput" rows="2" class="w-full p-3 focus:outline-none resize-none text-sm"
                            placeholder="Digite sua mensagem via WhatsApp..."></textarea>
                    </div>
                    <button onclick="sendWhatsAppMessage()" id="btnSendWhatsapp"
                        class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition-colors shadow-sm flex-shrink-0">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
                    <i data-lucide="lock" class="w-3 h-3"></i> Mensagens protegidas e criptografadas.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    let currentLeadId = null;

    function toggleModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Reset to default tab
            switchTab('details');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            // Clear chat on close
            document.getElementById('chat-messages').innerHTML = '';
        }
    }

    function switchTab(tabName) {
        const detailsTab = document.getElementById('tab-details');
        const whatsappTab = document.getElementById('tab-whatsapp');
        const contentDetails = document.getElementById('content-details');
        const contentWhatsapp = document.getElementById('content-whatsapp');

        if (tabName === 'details') {
            detailsTab.classList.add('text-northway-red', 'border-northway-red');
            detailsTab.classList.remove('text-gray-500', 'border-transparent');

            whatsappTab.classList.remove('text-green-600', 'border-green-600');
            whatsappTab.classList.add('text-gray-500', 'border-transparent');

            contentDetails.classList.remove('hidden');
            contentWhatsapp.classList.add('hidden');
        } else if (tabName === 'whatsapp') {
            detailsTab.classList.remove('text-northway-red', 'border-northway-red');
            detailsTab.classList.add('text-gray-500', 'border-transparent');

            whatsappTab.classList.add('text-green-600', 'border-green-600');
            whatsappTab.classList.remove('text-gray-500', 'border-transparent');

            contentDetails.classList.add('hidden');
            contentWhatsapp.classList.remove('hidden');
            contentWhatsapp.classList.add('flex'); // Because it's flex-col

            loadWhatsAppMessages(currentLeadId);
        }
    }

    async function loadWhatsAppMessages(leadId) {
        if (!leadId) return;

        const container = document.getElementById('chat-messages');
        container.innerHTML = `<div class="flex justify-center">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
</div>`;

        try {
            const response = await fetch(`/api/whatsapp/lead/${leadId}/messages`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            if (data.messages.length === 0) {
                container.innerHTML = `
<div class="flex flex-col items-center justify-center h-full text-gray-400">
    <i data-lucide="message-square" class="w-10 h-10 mb-2 opacity-50"></i>
    <p class="text-sm">Nenhuma mensagem ainda.</p>
    <p class="text-xs">Inicie a conversa abaixo.</p>
</div>
`;
            } else {
                container.innerHTML = data.messages.map(msg => `
<div class="flex ${msg.direction === 'out' ? 'justify-end' : 'justify-start'}">
    <div class="max-w-[80%] rounded-lg p-2 text-sm ${msg.direction === 'out'
                        ? 'bg-green-100 text-green-900 rounded-tr-none'
                        : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none'
                    }">
        <p>${msg.content}</p>
        <div class="flex justify-end items-center gap-1 mt-1">
            <span class="text-[10px] opacity-60">${new Date(msg.timestamp).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</span>
            ${msg.direction === 'out' ?
                        (msg.status === 'read' ? '<i data-lucide="check-check" class="w-3 h-3 text-blue-500"></i>' :
                            msg.status === 'delivered' ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>' :
                                '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>')
                        : ''}
        </div>
    </div>
</div>
`).join('');

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            if (window.lucide) lucide.createIcons();

        } catch (e) {
            container.innerHTML = `<p class="text-center text-red-500 text-xs">Erro ao carregar: ${e.message}</p>`;
        }
    }

    async function sendWhatsAppMessage() {
        const input = document.getElementById('whatsappInput');
        const content = input.value.trim();
        const btn = document.getElementById('btnSendWhatsapp');

        if (!content || !currentLeadId) return;

        // Disable UI
        input.disabled = true;
        btn.disabled = true;
        btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>`;

        try {
            const response = await fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_id: currentLeadId, content: content })
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Append message directly (Classic optimist UI)
            input.value = '';
            loadWhatsAppMessages(currentLeadId);

        } catch (e) {
            alert('Erro ao enviar: ' + e.message);
        } finally {
            input.disabled = false;
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i>`;
            input.focus();
        }
    }

    function editStage(id, name) {
        document.getElementById(`edit-form-${id}`).classList.remove('hidden');
    }

    function cancelEdit(id) {
        document.getElementById(`edit-form-${id}`).classList.add('hidden');
    }

    function openLeadModal(input) {
        let lead = input;

        // Check if input is a DOM element (has dataset)
        if (input.dataset) {
            lead = {
                name: input.dataset.name,
                phone: input.dataset.phone,
                email: input.dataset.email,
                website: input.dataset.website,
                address: input.dataset.address,
                interest: input.dataset.interest,
                source: input.dataset.source || 'Importado', // Add Source support
                bant_budget: input.dataset.bantBudget,
                bant_authority: input.dataset.bantAuthority,
                bant_need: input.dataset.bantNeed,
                bant_timeline: input.dataset.bantTimeline,
                id: input.dataset.id
            };
        }

        currentLeadId = lead.id; // Store globally for chat

        // Populate Modal Fields (Display)
        document.getElementById('modalLeadName').textContent = lead.name;
        document.getElementById('modalLeadPhone').textContent = lead.phone || 'Sem telefone';

        // Populate Inputs (New)
        document.getElementById('modalInputEmail').value = lead.email || '';
        document.getElementById('modalInputPhone').value = lead.phone || '';
        document.getElementById('modalInputWebsite').value = lead.website || '';
        document.getElementById('modalInputAddress').value = lead.address || '';
        document.getElementById('modalInputSource').value = lead.source || '';
        document.getElementById('modalInputInterest').value = lead.interest || '';

        // BANT Fields
        document.getElementById('bantBudget').value = lead.bant_budget || '';
        document.getElementById('bantAuthority').value = lead.bant_authority || '';
        document.getElementById('bantTimeline').value = lead.bant_timeline || '';
        document.getElementById('bantNeed').value = lead.bant_need || '';

        // Update Form Actions
        document.getElementById('infoForm').action = `/leads/${lead.id}/update_info`;
        document.getElementById('bantForm').action = `/leads/${lead.id}/bant`;

        // Update Full Details Link
        document.getElementById('viewFullDetails').href = `/leads/${lead.id}`;

        toggleModal('leadModal');

        // Clear previous chat to prevent leak
        document.getElementById('chat-messages').innerHTML = '';
    }
</script>

<!-- Create Stage Modal -->
<div id="createStageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Nova Etapa</h3>
            <button onclick="toggleModal('createStageModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('leads.create_stage', id=active_pipeline.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Etapa *</label>
                <input type="text" name="name" required placeholder="Ex: Triagem, Follow-up"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button" onclick="toggleModal('createStageModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                    Adicionar Etapa
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}