<!DOCTYPE html>
<html lang="pt-br" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Crescimento | NorthWay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0A0A0A;
            color: white;
        }

        [x-cloak] {
            display: none !important;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#E11D48',
                        brand: { black: '#050505', dark: '#0A0A0A', gray: '#141414' }
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8 flex items-center justify-center">

    <div x-data="diagnosticForm()" x-cloak
        class="w-full max-w-3xl bg-brand-gray border border-white/10 rounded-xl shadow-2xl overflow-hidden relative min-h-[600px] flex flex-col">

        <!-- Header -->
        <div class="px-8 py-6 border-b border-white/10 flex justify-between items-center bg-brand-black/50">
            <div class="flex items-center gap-3">
                <img src="{{ company_logo }}" alt="Company Logo" class="h-8">
                <span class="text-sm text-gray-400 border-l border-gray-700 pl-3">Diagnóstico de Crescimento</span>
            </div>
            <div class="text-xs text-gray-500 font-mono" x-text="'Etapa ' + step + '/6'"></div>
        </div>

        <!-- Progress -->
        <div class="w-full bg-gray-800 h-1">
            <div class="bg-primary h-1 transition-all duration-500 ease-out" :style="'width: ' + ((step/6)*100) + '%'">
            </div>
        </div>

        <!-- Form Content -->
        <form @submit.prevent="submit" class="flex-1 p-8 flex flex-col relative"
            :class="{'opacity-50 pointer-events-none': loading}">

            <!-- STEP 1: Identification -->
            <div x-show="step === 1" class="slide-in flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">Vamos começar</h2>
                <p class="text-gray-400 mb-8">Para gerar seu diagnóstico personalizado, precisamos saber quem é você.
                </p>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Nome Completo</label>
                        <input type="text" x-model="contact.full_name" required
                            class="w-full bg-brand-dark border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition"
                            placeholder="Seu nome">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">WhatsApp</label>
                        <input type="tel" x-model="contact.whatsapp" required
                            class="w-full bg-brand-dark border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition"
                            placeholder="(00) 00000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Nome da Empresa</label>
                        <input type="text" x-model="contact.business_name" required
                            class="w-full bg-brand-dark border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition"
                            placeholder="Sua empresa">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Segmento</label>
                        <select x-model="contact.segment" required
                            class="w-full bg-brand-dark border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                            <option value="">Selecione...</option>
                            <option value="Serviços">Serviços</option>
                            <option value="Varejo">Varejo</option>
                            <option value="Indústria">Indústria</option>
                            <option value="Tecnologia">Tecnologia/SaaS</option>
                            <option value="Infoproduto">Infoproduto</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Atrair -->
            <div x-show="step === 2" class="slide-in flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">Pilar 1: Atrair</h2>
                <p class="text-gray-400 mb-6">Como sua empresa gera novas oportunidades?</p>
                <div class="space-y-6">
                    {% for q in schema.questions if q.pilar == 'Atrair' %}
                    <div>
                        <p class="text-sm font-medium text-gray-200 mb-3">{{loop.index}}. {{ q.text }}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
                            {% for opt in schema.options %}
                            <label
                                class="cursor-pointer border border-gray-700 rounded-lg p-3 hover:border-primary/50 hover:bg-white/5 transition flex items-center gap-2"
                                :class="{'bg-primary/20 border-primary': answers['{{q.id}}'] == {{opt.value}}}">
                                <input type="radio" value="{{opt.value}}" x-model.number="answers['{{q.id}}']"
                                    class="hidden">
                                <div class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center"
                                    :class="{'border-primary bg-primary': answers['{{q.id}}'] == {{opt.value}}}"></div>
                                <span class="text-xs text-gray-300">{{ opt.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- STEP 3: Engajar -->
            <div x-show="step === 3" class="slide-in flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">Pilar 2: Engajar</h2>
                <p class="text-gray-400 mb-6">Como você se relaciona com quem chega?</p>
                <div class="space-y-6">
                    {% for q in schema.questions if q.pilar == 'Engajar' %}
                    <div>
                        <p class="text-sm font-medium text-gray-200 mb-3">{{loop.index}}. {{ q.text }}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
                            {% for opt in schema.options %}
                            <label
                                class="cursor-pointer border border-gray-700 rounded-lg p-3 hover:border-primary/50 hover:bg-white/5 transition flex items-center gap-2"
                                :class="{'bg-primary/20 border-primary': answers['{{q.id}}'] == {{opt.value}}}">
                                <input type="radio" value="{{opt.value}}" x-model.number="answers['{{q.id}}']"
                                    class="hidden">
                                <div class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center"
                                    :class="{'border-primary bg-primary': answers['{{q.id}}'] == {{opt.value}}}"></div>
                                <span class="text-xs text-gray-300">{{ opt.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- STEP 4: Vender -->
            <div x-show="step === 4" class="slide-in flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">Pilar 3: Vender</h2>
                <p class="text-gray-400 mb-6">Como você converte oportunidades em clientes?</p>
                <div class="space-y-6">
                    {% for q in schema.questions if q.pilar == 'Vender' %}
                    <div>
                        <p class="text-sm font-medium text-gray-200 mb-3">{{loop.index}}. {{ q.text }}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
                            {% for opt in schema.options %}
                            <label
                                class="cursor-pointer border border-gray-700 rounded-lg p-3 hover:border-primary/50 hover:bg-white/5 transition flex items-center gap-2"
                                :class="{'bg-primary/20 border-primary': answers['{{q.id}}'] == {{opt.value}}}">
                                <input type="radio" value="{{opt.value}}" x-model.number="answers['{{q.id}}']"
                                    class="hidden">
                                <div class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center"
                                    :class="{'border-primary bg-primary': answers['{{q.id}}'] == {{opt.value}}}"></div>
                                <span class="text-xs text-gray-300">{{ opt.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- STEP 5: Reter -->
            <div x-show="step === 5" class="slide-in flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">Pilar 4: Vender de Novo</h2>
                <p class="text-gray-400 mb-6">Você maximiza o valor de cada cliente?</p>
                <div class="space-y-6">
                    {% for q in schema.questions if q.pilar == 'Reter' %}
                    <div>
                        <p class="text-sm font-medium text-gray-200 mb-3">{{loop.index}}. {{ q.text }}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
                            {% for opt in schema.options %}
                            <label
                                class="cursor-pointer border border-gray-700 rounded-lg p-3 hover:border-primary/50 hover:bg-white/5 transition flex items-center gap-2"
                                :class="{'bg-primary/20 border-primary': answers['{{q.id}}'] == {{opt.value}}}">
                                <input type="radio" value="{{opt.value}}" x-model.number="answers['{{q.id}}']"
                                    class="hidden">
                                <div class="w-4 h-4 rounded-full border border-gray-500 flex items-center justify-center"
                                    :class="{'border-primary bg-primary': answers['{{q.id}}'] == {{opt.value}}}"></div>
                                <span class="text-xs text-gray-300">{{ opt.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- STEP 6: Results -->
            <div x-show="step === 6" class="slide-in flex-1 text-center" x-ref="results">
                <template x-if="result">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Seu Diagnóstico</h2>
                        <div class="text-primary text-lg font-medium mb-8" x-text="result.classification"></div>

                        <!-- Stars -->
                        <div class="flex justify-center items-center gap-2 mb-8">
                            <span class="text-6xl text-yellow-500 font-bold" x-text="result.stars"></span>
                            <div class="flex flex-col items-start">
                                <div class="flex text-yellow-500 text-2xl">
                                    <template x-for="i in 5">
                                        <span x-text="i <= Math.round(result.stars) ? '★' : '☆'"></span>
                                    </template>
                                </div>
                                <span class="text-xs text-gray-400">de 5.0</span>
                            </div>
                        </div>

                        <!-- Pillars Chart -->
                        <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-10">
                            <template x-for="(score, name) in result.pillars">
                                <div class="bg-brand-black p-4 rounded-lg border border-white/5">
                                    <div class="text-xs text-gray-400 uppercase tracking-widest mb-1" x-text="name">
                                    </div>
                                    <div class="text-xl font-bold text-white mb-2" x-text="score + '/15'"></div>
                                    <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                                        <div class="bg-primary h-full" :style="'width: ' + ((score/15)*100) + '%'">
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="bg-primary/10 border border-primary/20 rounded-lg p-6 max-w-lg mx-auto">
                            <h3 class="text-lg font-bold text-white mb-2">Próximo Passo</h3>
                            <p class="text-gray-300 text-sm mb-4">
                                Com base na sua nota <span x-text="result.stars"></span>, preparamos um plano de ação
                                para você.
                            </p>
                            <!-- Fake CTA that would link to owner -->
                            {% if instance.owner.phone %}
                            <a href="https://wa.me/{{ instance.owner.phone|replace(' ','')|replace('-','')|replace('(','')|replace(')','') }}?text=Ol%C3%A1%2C%20fiz%20o%20diagn%C3%B3stico%20e%20tive%20nota%20"
                                class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full transition shadow-lg shadow-green-900/20">
                                Falar com um Especialista
                            </a>
                            {% else %}
                            <button disabled
                                class="bg-gray-700 text-gray-400 py-3 px-8 rounded-full cursor-not-allowed">
                                Aguarde nosso contato
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </template>
            </div>

            <!-- Footer / Navigation -->
            <div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-center" x-show="step < 6">

                <button type="button" @click="prev()" x-show="step > 1"
                    class="text-gray-400 hover:text-white transition flex items-center gap-2">
                    ← Voltar
                </button>
                <div x-show="step === 1"></div> <!-- Spacer -->

                <button type="button" @click="next()" x-show="step < 5"
                    class="bg-white text-black hover:bg-gray-200 font-medium py-2 px-6 rounded-lg transition ml-auto">
                    Próximo →
                </button>

                <button type="submit" x-show="step === 5"
                    class="bg-primary hover:bg-red-600 text-white font-medium py-2 px-6 rounded-lg transition ml-auto flex items-center gap-2"
                    :disabled="loading">
                    <span x-show="!loading">Ver Resultado</span>
                    <span x-show="loading">Analisando...</span>
                </button>
            </div>

        </form>
    </div>

    <!-- Data Injection -->
    <script>
        function diagnosticForm() {
            return {
                step: 1,
                loading: false,
                token: "{{ token }}",
                slug: "{{ instance.public_slug }}",
                contact: {
                    full_name: '',
                    whatsapp: '',
                    business_name: '',
                    segment: ''
                },
                answers: {},
                target_id: "{{ target_id or '' }}",
                target_type: "{{ target_type or '' }}",
                result: null,

                init() {
                    if (this.target_id) {
                        this.step = 2;
                    }
                },

                validateStep() {
                    if (this.step === 1) {
                        return this.contact.full_name && this.contact.whatsapp && this.contact.business_name && this.contact.segment;
                    }
                    // For steps 2-5, check if all questions on this page are answered
                    // Ideally we'd map pilar to questions, but simple check:
                    // Just check if we have enough keys? No.
                    // Let's just allow proceeding for MVP, or strict check?
                    // Strict check:
                    // Need to know which Q IDs are in this step.
                    // Doing a loose check for now to avoid JS complexity with Jinja loop extraction.
                    return true;
                },

                next() {
                    if (!this.validateStep()) {
                        alert("Por favor, preencha todos os campos obrigatórios.");
                        return;
                    }
                    this.step++;
                    window.scrollTo(0, 0);
                },

                prev() {
                    this.step--;
                    window.scrollTo(0, 0);
                },

                async submit() {
                    if (this.loading) return;
                    this.loading = true;

                    try {
                        const res = await fetch('/forms/public/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + this.token
                            },
                            body: JSON.stringify({
                                slug: this.slug,
                                contact: this.contact,
                                answers: this.answers,
                                target_id: this.target_id,
                                target_type: this.target_type
                            })
                        });

                        const data = await res.json();

                        if (res.ok && data.status === 'success') {
                            this.result = data.results;
                            this.step = 6;
                        } else {
                            alert(data.error || "Erro ao processar diagnóstico.");
                        }

                    } catch (e) {
                        alert("Erro de conexão.");
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>

</html>