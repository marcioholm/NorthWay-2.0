{% extends "base.html" %}

{% block content %}
<div class="flex-1 h-screen overflow-y-auto bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('main.leads') }}"
                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-500 hover:text-northway-red hover:bg-red-50 transition-colors shadow-sm">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ lead.name }}</h1>
                    <p class="text-gray-500 mt-1">{{ lead.email }} &bull; {{ lead.phone }}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium text-sm">
                    {{ lead.status }}
                </span>

                {% if not lead.client_id %}
                <button onclick="toggleModal('convertModal')"
                    class="bg-[#fa0102] text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Converter em Cliente
                </button>
                {% else %}
                <a href="#"
                    class="text-green-600 font-bold text-sm flex items-center gap-1 bg-green-50 px-3 py-1 rounded-lg border border-green-200">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Cliente Ativo
                </a>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Feed / Interactions -->
            <div class="md:col-span-2">
                <!-- Tabs -->
                <div class="bg-gray-50 border-b border-gray-200 rounded-t-lg flex gap-4 px-6 pt-2">
                    <button onclick="switchPageTab('details')" id="tab-page-details"
                        class="py-3 px-1 text-sm font-bold text-northway-red border-b-2 border-northway-red transition-colors">
                        <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i> Detalhes & Notas
                    </button>
                    <button onclick="switchPageTab('whatsapp')" id="tab-page-whatsapp"
                        class="py-3 px-1 text-sm font-bold text-gray-500 hover:text-gray-900 border-b-2 border-transparent transition-colors flex items-center gap-2">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                    </button>
                </div>

                <!-- Tab: Details (Existing Feed) -->
                <div id="content-page-details" class="space-y-6 pt-6">
                    <!-- Add Note -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="message-square" class="w-4 h-4"></i>
                            Nova Nota
                        </h3>
                        <form action="{{ url_for('main.lead_details', id=lead.id) }}" method="POST">
                            <textarea name="content" rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red resize-none text-sm"
                                placeholder="Escreva uma observação sobre este lead..."></textarea>
                            <div class="mt-3 flex justify-end">
                                <button type="submit"
                                    class="bg-northway-dark text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">
                                    Adicionar Nota
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Timeline -->
                    <div class="space-y-4">
                        {% for interaction in lead.interactions|sort(attribute='created_at', reverse=True) %}
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex gap-4">
                            <div class="flex-shrink-0 mt-1">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-bold text-gray-900">Nota</span>
                                    <span class="text-xs text-gray-400">{{ interaction.created_at.strftime('%d/%m/%Y
                                        %H:%M')
                                        }}</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">{{ interaction.content }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-400">
                            <p>Nenhuma interação registrada.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tab: WhatsApp -->
                <div id="content-page-whatsapp" class="hidden h-[600px] flex flex-col pt-6">
                    <!-- Chat Area -->
                    <div id="page-chat-messages"
                        class="flex-1 overflow-y-auto space-y-4 p-4 bg-[#e5ddd5] rounded-t-lg border border-gray-200 border-b-0">
                        <!-- Messages will load here -->
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-3 border border-gray-200 rounded-b-lg flex gap-2 items-end">
                        <div
                            class="flex-1 bg-gray-50 rounded-lg border border-gray-200 focus-within:border-green-500 focus-within:ring-1 focus-within:ring-green-500/20 transition-all">
                            <textarea id="pageWhatsappInput" rows="2"
                                class="w-full p-3 bg-transparent border-none focus:outline-none resize-none text-sm"
                                placeholder="Digite sua mensagem via WhatsApp..."></textarea>
                        </div>
                        <button onclick="sendPageWhatsAppMessage()" id="btnSendPageWhatsapp"
                            class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg transition-colors shadow-sm flex-shrink-0 h-[46px] w-[46px] flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 flex items-center gap-1 justify-center">
                        <i data-lucide="lock" class="w-3 h-3"></i> Mensagens protegidas e criptografadas de ponta a
                        ponta.
                    </p>
                </div>

                <!-- Sidebar Info -->
                <div class="space-y-6">
                    <!-- Info Card -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3
                            class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">
                            Informações</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Origem</label>
                                <div class="text-sm font-medium text-gray-900">{{ lead.source or 'Não informado' }}
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Interesse</label>
                                <div class="text-sm font-medium text-gray-900">{{ lead.interest or '-' }}</div>
                            </div>
                            {% if lead.notes %}
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Observações Iniciais</label>
                                <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">{{
                                    lead.notes }}</div>
                            </div>
                            {% endif %}
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Criado em</label>
                                <div class="text-sm font-medium text-gray-900">{{ lead.created_at.strftime('%d/%m/%Y')
                                    }}
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Responsável</label>
                                <div class="flex items-center gap-2">
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs">
                                        {{ lead.assigned_user.name[:2].upper() }}
                                    </div>
                                    <span class="text-sm text-gray-900">{{ lead.assigned_user.name }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BANT Qualification Card -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3
                            class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                            <span class="bg-northway-red text-white text-[10px] px-1.5 py-0.5 rounded">BANT</span>
                            Qualificação
                        </h3>

                        <form action="{{ url_for('main.update_bant', id=lead.id) }}" method="POST" class="space-y-4">
                            <!-- Budget -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Budget</label>
                                <input type="text" name="bant_budget" value="{{ lead.bant_budget or '' }}"
                                    placeholder="R$..."
                                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red transition-colors">
                            </div>

                            <!-- Authority -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Authority</label>
                                <select name="bant_authority"
                                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red bg-white transition-colors">
                                    <option value="" {{ 'selected' if not lead.bant_authority }}>Selecione...</option>
                                    <option value="Decisor" {{ 'selected' if lead.bant_authority=='Decisor' }}>Decisor
                                    </option>
                                    <option value="Influenciador" {{ 'selected' if lead.bant_authority=='Influenciador'
                                        }}>
                                        Influenciador</option>
                                    <option value="Usuário" {{ 'selected' if lead.bant_authority=='Usuário' }}>Usuário
                                    </option>
                                    <option value="Sem poder" {{ 'selected' if lead.bant_authority=='Sem poder' }}>Sem
                                        poder
                                    </option>
                                </select>
                            </div>

                            <!-- Timeline -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Timeline</label>
                                <select name="bant_timeline"
                                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red bg-white transition-colors">
                                    <option value="" {{ 'selected' if not lead.bant_timeline }}>Selecione...</option>
                                    <option value="Imediato" {{ 'selected' if lead.bant_timeline=='Imediato' }}>Imediato
                                    </option>
                                    <option value="Curto Prazo" {{ 'selected' if lead.bant_timeline=='Curto Prazo' }}>
                                        Curto
                                        Prazo</option>
                                    <option value="Médio Prazo" {{ 'selected' if lead.bant_timeline=='Médio Prazo' }}>
                                        Médio
                                        Prazo</option>
                                    <option value="Longo Prazo" {{ 'selected' if lead.bant_timeline=='Longo Prazo' }}>
                                        Longo
                                        Prazo</option>
                                </select>
                            </div>

                            <!-- Need -->
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Need</label>
                                <textarea name="bant_need" rows="3" placeholder="Necessidade..."
                                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red resize-none transition-colors">{{ lead.bant_need or '' }}</textarea>
                            </div>

                            <button type="submit"
                                class="w-full bg-gray-50 text-gray-700 font-bold py-2 rounded hover:bg-northway-red hover:text-white transition-colors text-sm border border-gray-200 hover:border-northway-red">
                                Salvar Qualificação
                            </button>
                        </form>
                    </div>

                    <!-- Related Tasks -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider">Tarefas Pendentes
                                </h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-24 bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                        <div id="task-progress-bar" class="bg-green-500 h-1.5 rounded-full"
                                            data-width="{{ lead.task_progress.percent }}"></div>
                                        <script>
                                            document.addEventListener("DOMContentLoaded", function () {
                                                const bar = document.getElementById('task-progress-bar');
                                                if (bar) bar.style.width = bar.dataset.width + '%';
                                            });
                                        </script>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">{{ lead.task_progress.completed
                                        }}/{{ lead.task_progress.total }}</span>
                                </div>
                            </div>
                            <button onclick="toggleModal('createTaskModal')"
                                class="text-northway-red hover:text-red-700 text-xs font-bold flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> Nova
                            </button>
                        </div>
                        <ul class="divide-y divide-gray-100">
                            {% for task in lead.tasks %}
                            <li class="py-3 flex items-center gap-3 group">
                                <form action="{{ url_for('main.toggle_task', id=task.id) }}" method="POST">
                                    <button type="submit"
                                        class="w-4 h-4 border-2 border-gray-300 rounded hover:border-northway-red transition-colors flex items-center justify-center">
                                        {% if task.status == 'concluida' %}
                                        <span class="block w-2.5 h-2.5 bg-northway-red rounded-sm"></span>
                                        {% endif %}
                                    </button>
                                </form>

                                <span
                                    class="text-sm flex-1 {{ 'line-through text-gray-400' if task.status == 'concluida' else 'text-gray-700' }}">
                                    {{ task.title }}
                                </span>

                                <span class="text-xs text-gray-400">
                                    {{ task.due_date.strftime('%d/%m') if task.due_date else '' }}
                                </span>

                                {% if current_user.role == 'admin' %}
                                <form action="{{ url_for('main.delete_task', id=task.id) }}" method="POST"
                                    onsubmit="return confirm('Excluir tarefa?');">
                                    <button type="submit"
                                        class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </li>
                            {% else %}
                            <li class="text-xs text-gray-400 italic py-2">Nenhuma tarefa.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-900">Nova Tarefa</h3>
                <button onclick="toggleModal('createTaskModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form action="{{ url_for('main.tasks') }}" method="POST" class="p-6 space-y-4">
                <input type="hidden" name="lead_id" value="{{ lead.id }}">
                <input type="hidden" name="next" value="{{ url_for('main.lead_details', id=lead.id) }}">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" name="title" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data e Hora de Vencimento</label>
                    <input type="datetime-local" name="due_date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleModal('createTaskModal')"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        Salvar Tarefa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Convert Lead Modal -->
<div id="convertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Converter Lead em Cliente</h3>
            <button onclick="toggleModal('convertModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('main.convert_lead', id=lead.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Serviço Contratado</label>
                <input type="text" name="service" placeholder="Ex: Consultoria mensal, Projeto Website"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Mensal (R$)</label>
                    <input type="text" name="monthly_value" placeholder="R$ 0,00" oninput="formatCurrency(this)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Contrato</label>
                    <select name="contract_type"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                        <option value="mensal">Mensal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                        <option value="pontual">Pontual</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label>
                <input type="date" name="start_date" value="{{ today_date }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button" onclick="toggleModal('convertModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Confirmar Conversão
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2) + '';
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        input.value = "R$ " + value;
    }

    // --- Tab Logic ---
    const pageLeadId = parseInt("{{ lead.id }}");

    function switchPageTab(tabName) {
        const detailsTab = document.getElementById('tab-page-details');
        const whatsappTab = document.getElementById('tab-page-whatsapp');
        const contentDetails = document.getElementById('content-page-details');
        const contentWhatsapp = document.getElementById('content-page-whatsapp');

        if (tabName === 'details') {
            detailsTab.classList.add('text-northway-red', 'border-northway-red');
            detailsTab.classList.remove('text-gray-500', 'border-transparent');

            whatsappTab.classList.remove('text-green-600', 'border-green-600');
            whatsappTab.classList.add('text-gray-500', 'border-transparent');

            contentDetails.classList.remove('hidden');
            contentWhatsapp.classList.add('hidden');
        } else if (tabName === 'whatsapp') {
            detailsTab.classList.remove('text-northway-red', 'border-northway-red');
            detailsTab.classList.add('text-gray-500', 'border-transparent');

            whatsappTab.classList.add('text-green-600', 'border-green-600');
            whatsappTab.classList.remove('text-gray-500', 'border-transparent');

            contentDetails.classList.add('hidden');
            contentWhatsapp.classList.remove('hidden');

            loadPageWhatsAppMessages();
        }
    }

    async function loadPageWhatsAppMessages() {
        const container = document.getElementById('page-chat-messages');
        container.innerHTML = `<div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div></div>`;

        try {
            const response = await fetch(`/api/whatsapp/lead/${pageLeadId}/messages`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            if (data.messages.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <i data-lucide="message-square" class="w-10 h-10 mb-2 opacity-50"></i>
                        <p class="text-sm">Nenhuma mensagem ainda.</p>
                        <p class="text-xs">Inicie a conversa abaixo.</p>
                    </div>
                 `;
            } else {
                let lastDate = null;
                const messagesHtml = data.messages.map(msg => {
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = msgDate.toLocaleDateString('pt-BR');
                    let dateHeader = '';

                    if (dateStr !== lastDate) {
                        lastDate = dateStr;
                        dateHeader = `
                            <div class="flex justify-center my-4">
                                <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded shadow-sm font-medium">
                                    ${dateStr}
                                </span>
                            </div>`;
                    }

                    return `
                    ${dateHeader}
                    <div class="flex ${msg.direction === 'out' ? 'justify-end' : 'justify-start'} mb-2 group px-2">
                        <div class="max-w-[75%] rounded-2xl px-4 py-2 text-sm shadow-sm relative leading-relaxed ${msg.direction === 'out'
                            ? 'bg-[#d9fdd3] text-gray-900 rounded-tr-none shadow-md'
                            : 'bg-white text-gray-900 rounded-tl-none shadow-md'
                        }">
                            <p class="mb-1">${msg.content}</p>
                            <div class="flex justify-end items-center gap-1 -mt-0.5">
                                <span class="text-[10px] text-gray-500">${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                ${msg.direction === 'out' ?
                            (msg.status === 'read' ? '<i data-lucide="check-check" class="w-3 h-3 text-[#53bdeb]"></i>' :
                                msg.status === 'delivered' ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>' :
                                    '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>')
                            : ''}
                            </div>
                            
                        </div>
                    </div>
                `}).join('');
                container.innerHTML = messagesHtml;

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            if (window.lucide) lucide.createIcons();

        } catch (e) {
            container.innerHTML = `<p class="text-center text-red-500 text-xs">Erro ao carregar: ${e.message}</p>`;
        }
    }

    async function sendPageWhatsAppMessage() {
        const input = document.getElementById('pageWhatsappInput');
        const content = input.value.trim();
        const btn = document.getElementById('btnSendPageWhatsapp');

        if (!content) return;

        // Disable UI
        input.disabled = true;
        btn.disabled = true;
        btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>`;

        try {
            const response = await fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_id: pageLeadId, content: content })
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Append message directly (Classic optimist UI)
            input.value = '';
            loadPageWhatsAppMessages();

        } catch (e) {
            alert('Erro ao enviar: ' + e.message);
        } finally {
            input.disabled = false;
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i>`;
            input.focus();
        }
    }
</script>
{% endblock %}