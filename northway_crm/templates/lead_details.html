{% extends "base.html" %}

{% block content %}
<div class="flex-1 h-screen overflow-y-auto bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('leads.leads') }}"
                    class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-500 hover:text-northway-red hover:bg-red-50 transition-colors shadow-sm">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ lead.name }}</h1>
                    <p class="text-gray-500 mt-1">{{ lead.email }} &bull; {{ lead.phone }}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium text-sm">
                    {{ lead.status }}
                </span>

                {% if not lead.client_id %}
                <button onclick="toggleModal('convertModal')"
                    class="bg-[#fa0102] text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors font-bold text-sm shadow-sm flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    Converter em Cliente
                </button>
                {% else %}
                <a href="#"
                    class="text-green-600 font-bold text-sm flex items-center gap-1 bg-green-50 px-3 py-1 rounded-lg border border-green-200">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Cliente Ativo
                </a>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Feed / Interactions -->
            <div class="md:col-span-2">
                <!-- Tabs -->
                <div class="bg-gray-50 border-b border-gray-200 rounded-t-lg flex gap-4 px-6 pt-2">
                    <button onclick="switchPageTab('details')" id="tab-page-details"
                        class="py-3 px-1 text-sm font-bold text-northway-red border-b-2 border-northway-red transition-colors">
                        <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i> Detalhes & Notas
                    </button>
                    <button onclick="switchPageTab('whatsapp')" id="tab-page-whatsapp"
                        class="py-3 px-1 text-sm font-bold text-gray-500 hover:text-gray-900 border-b-2 border-transparent transition-colors flex items-center gap-2">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                    </button>
                    <button onclick="switchPageTab('enrichment')" id="tab-page-enrichment"
                        class="py-3 px-1 text-sm font-bold text-gray-500 hover:text-gray-900 border-b-2 border-transparent transition-colors flex items-center gap-2">
                        <i data-lucide="building-2" class="w-4 h-4"></i> Empresa & CNPJ
                    </button>
                </div>

                <!-- Tab: Details (Existing Feed) -->
                <div id="content-page-details" class="space-y-6 pt-6">
                    <!-- Add Note -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="message-square" class="w-4 h-4"></i>
                            Nova Nota
                        </h3>
                        <form action="{{ url_for('leads.add_lead_interaction', id=lead.id) }}" method="POST">
                            <textarea name="content" rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red resize-none text-sm"
                                placeholder="Escreva uma observação sobre este lead..."></textarea>
                            <div class="mt-3 flex justify-end">
                                <button type="submit"
                                    class="bg-northway-dark text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium">
                                    Adicionar Nota
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Timeline -->
                    <div class="space-y-4">
                        {% for interaction in lead.interactions|sort(attribute='created_at', reverse=True) %}
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex gap-4">
                            <div class="flex-shrink-0 mt-1">
                                <div
                                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-bold text-gray-900">Nota</span>
                                    <span class="text-xs text-gray-400">{{ interaction.created_at.strftime('%d/%m/%Y
                                        %H:%M')
                                        }}</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">{{ interaction.content }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-400">
                            <p>Nenhuma interação registrada.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tab: WhatsApp -->
                <div id="content-page-whatsapp" class="hidden h-[600px] flex flex-col pt-6">
                    <!-- Chat Area -->
                    <div id="page-chat-messages"
                        class="flex-1 overflow-y-auto space-y-4 p-4 bg-[#e5ddd5] rounded-t-lg border border-gray-200 border-b-0">
                        <!-- Messages will load here -->
                    </div>

                    <!-- Input Area -->
                    <!-- Input Area (Standardized) -->
                    <div
                        class="bg-gray-50 p-3 border border-gray-200 border-t-0 rounded-b-lg flex flex-col gap-2 relative">
                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">

                        <!-- Attachment Menu (Absolute) -->
                        <div id="attach-menu"
                            class="hidden absolute bottom-20 left-4 bg-white shadow-xl rounded-lg flex flex-col w-40 overflow-hidden z-20 border border-gray-100">
                            <button onclick="triggerFile('image/*')"
                                class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700 border-b border-gray-50">
                                <i data-lucide="image" class="w-4 h-4 text-purple-500"></i> Fotos
                            </button>
                            <button onclick="triggerFile('*/*')"
                                class="flex items-center gap-3 p-3 hover:bg-gray-50 transition-colors text-sm text-gray-700">
                                <i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i> Documento
                            </button>
                        </div>

                        <div class="flex items-end gap-2">
                            <!-- Default Toolbar -->
                            <div id="toolbar-default" class="flex-1 flex items-center gap-2">
                                <button id="btn-attach" onclick="toggleAttachMenu()"
                                    class="p-2 text-gray-500 hover:text-gray-700 transition-colors rounded-full hover:bg-gray-200">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>

                                <!-- Rich Text Toolbar (Mini) -->
                                <div class="hidden md:flex items-center gap-0.5 border-r border-gray-300 pr-2 mr-1">
                                    <button onclick="insertFormat('*')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="bold" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="insertFormat('_')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="italic" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="insertFormat('- ')"
                                        class="p-1 text-gray-400 hover:text-gray-600 rounded">
                                        <i data-lucide="list" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <div
                                    class="flex-1 bg-white rounded-lg border border-gray-300 focus-within:border-northway-red focus-within:ring-1 focus-within:ring-northway-red/20 transition-all overflow-hidden flex items-center px-4 py-2">
                                    <input type="text" id="message-input" placeholder="Mensagem"
                                        class="w-full bg-transparent border-none focus:outline-none text-sm text-gray-800 placeholder-gray-400"
                                        autocomplete="off">
                                </div>

                                <!-- Mic / Send Toggle -->
                                <button id="btn-mic" onclick="toggleRecording()"
                                    class="p-3 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors shadow-sm">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                                <button id="btn-send" onclick="sendMessage()"
                                    class="hidden p-3 bg-northway-red text-white rounded-full hover:bg-red-700 transition-colors shadow-sm">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- Recording UI -->
                            <div id="toolbar-recording"
                                class="flex-1 items-center gap-4 hidden px-4 py-2 bg-white rounded-lg border border-red-100">
                                <button onclick="cancelRecording()" class="text-gray-500 hover:text-red-500 p-2">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                                <div class="flex-1 flex items-center gap-3 justify-center">
                                    <span class="animate-pulse w-3 h-3 bg-red-500 rounded-full"></span>
                                    <span id="recording-time"
                                        class="text-gray-700 font-mono text-sm font-bold">0:00</span>
                                </div>
                                <button onclick="stopAndSendRecording()"
                                    class="text-green-500 hover:text-green-600 p-2">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- File Preview UI -->
                            <div id="toolbar-file"
                                class="flex-1 items-center gap-4 hidden bg-white rounded-lg px-4 py-2 border border-green-200">
                                <span class="text-gray-500"><i data-lucide="file" class="w-5 h-5 inline"></i></span>
                                <span id="file-name"
                                    class="flex-1 text-sm text-gray-700 truncate font-medium">arquivo.pdf</span>
                                <button onclick="cancelFile()" class="text-gray-400 hover:text-red-500 p-2">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                                <button onclick="sendFile()"
                                    class="text-green-600 hover:text-green-700 font-bold text-sm px-3">
                                    Enviar
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1 justify-center">
                            <i data-lucide="lock" class="w-3 h-3"></i> Mensagens protegidas e criptografadas de ponta a
                            ponta.
                        </p>
                    </div>

                    <!-- Tab: Enrichment -->
                    <div id="content-page-enrichment" class="hidden space-y-6 pt-6">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 text-center">
                            <div
                                class="w-16 h-16 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="building-2" class="w-8 h-8"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 mb-2">Enriquecimento de Dados</h2>
                            <p class="text-gray-500 text-sm mb-6">Busque informações corporativas detalhadas para este
                                lead diretamente da base da Receita Federal.</p>

                            <button onclick="openEnrichmentSearch()"
                                class="bg-purple-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-purple-700 transition-colors shadow-sm flex items-center gap-2 mx-auto">
                                <i data-lucide="search" class="w-4 h-4"></i>
                                Buscar Empresa / CNPJ
                            </button>
                        </div>

                        {% if lead.legal_name %}
                        <!-- Corporate Data Card -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    <i data-lucide="info" class="w-4 h-4"></i> Dados Cadastrais
                                </h3>
                                <span
                                    class="text-xs font-bold px-2 py-0.5 rounded-full {% if lead.registration_status == 'ATIVA' %}bg-green-100 text-green-700{% else %}bg-amber-100 text-amber-700{% endif %}">
                                    {{ lead.registration_status or 'N/A' }}
                                </span>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs text-gray-400 block uppercase font-bold mb-1">Razão
                                        Social</label>
                                    <p class="text-sm font-medium text-gray-900">{{ lead.legal_name }}</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 block uppercase font-bold mb-1">CNPJ</label>
                                    <p class="text-sm font-mono text-gray-900">{{ lead.cnpj }}</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 block uppercase font-bold mb-1">Porte</label>
                                    <p class="text-sm text-gray-900">{{ lead.company_size or 'N/A' }}</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 block uppercase font-bold mb-1">CNAE
                                        Principal</label>
                                    <p class="text-sm text-gray-900">{{ lead.cnae or 'N/A' }}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="text-xs text-gray-400 block uppercase font-bold mb-1">Sócios /
                                        Administradores</label>
                                    <div class="mt-2 flex flex-wrap gap-2">
                                        {% set partners = lead.partners_json | from_json %}
                                        {% for partner in partners %}
                                        <span
                                            class="bg-purple-50 text-purple-700 text-xs px-3 py-1 rounded-full border border-purple-100 font-medium">
                                            {{ partner.get('name') }} ({{ (partner.get('role', {})).get('text') or
                                            'Sócio' }})
                                        </span>
                                        {% else %}
                                        <span class="text-gray-400 italic text-sm">Nenhum sócio listado.</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- History -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4 text-gray-400"></i>
                                Histórico de Atualizações
                            </h3>
                            <div class="space-y-4">
                                {% set history = lead.enrichment_history | from_json %}
                                {% for item in history|reverse %}
                                <div class="flex items-start gap-3 text-sm">
                                    <div class="w-2 h-2 rounded-full bg-purple-400 mt-1.5"></div>
                                    <div>
                                        <p class="text-gray-900">Enriquecido por <strong>{{ item.user }}</strong> via
                                            <strong>{{ item.source }}</strong>
                                        </p>
                                        <p class="text-xs text-gray-500">{{ item.date | replace('T', ' ') | truncate(16,
                                            True, '') }} - CNPJ: {{ item.cnpj }}</p>
                                    </div>
                                </div>
                                {% else %}
                                <p class="text-center text-gray-400 text-sm py-4 italic">Nenhuma atualização registrada
                                    ainda.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="space-y-6">
                <!-- Info Card -->
                <!-- Info Card (Editable) -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3
                        class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">
                        Informações do Lead
                    </h3>

                    <form action="{{ url_for('leads.update_lead_info', id=lead.id) }}" method="POST" class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">E-mail</label>
                                <input type="email" name="email" value="{{ lead.email or '' }}"
                                    placeholder="email@exemplo.com"
                                    class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                            </div>

                            <!-- Phone with DDI -->
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Telefone</label>
                                <div class="flex gap-2 min-w-0">
                                    <select name="phone_ddi" id="inputDDI"
                                        class="w-20 px-1 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none bg-white">
                                        <option value="+55">+55</option>
                                        <option value="+1">+1</option>
                                        <option value="+351">+351</option>
                                        <option value="+44">+44</option>
                                        <option value="+34">+34</option>
                                        <option value="+33">+33</option>
                                        <option value="+49">+49</option>
                                        <option value="+39">+39</option>
                                    </select>
                                    <input type="text" name="phone_number" id="inputPhoneNumber"
                                        placeholder="(00) 00000-0000" oninput="maskPhone(this)"
                                        class="flex-1 min-w-0 px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                                </div>
                                <input type="hidden" id="rawPhone" value="{{ lead.phone or '' }}">
                            </div>

                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Website</label>
                                <input type="text" name="website" value="{{ lead.website or '' }}"
                                    placeholder="www.site.com"
                                    class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                            </div>

                            <!-- Source Select -->
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Origem</label>
                                <select name="source"
                                    class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none bg-white">
                                    {% set sources = ['Google', 'Facebook', 'Instagram', 'WhatsApp', 'Indicação',
                                    'Linkedin', 'Email', 'Site', 'Feira/Evento', 'Outros'] %}
                                    <option value="">Selecione...</option>
                                    {% for s in sources %}
                                    <option value="{{ s }}" {{ 'selected' if lead.source==s else '' }}>{{ s }}</option>
                                    {% endfor %}
                                    {% if lead.source and lead.source not in sources %}
                                    <option value="{{ lead.source }}" selected>{{ lead.source }} (Atual)</option>
                                    {% endif %}
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Endereço</label>
                                <input type="text" name="address" value="{{ lead.address or '' }}"
                                    placeholder="Endereço completo"
                                    class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Interesse</label>
                                <input type="text" name="interest" value="{{ lead.interest or '' }}"
                                    placeholder="Interesse principal"
                                    class="w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:border-northway-red focus:ring-1 focus:ring-northway-red/20 outline-none">
                            </div>
                        </div>

                        <script>
                            function maskPhone(input) {
                                let value = input.value.replace(/\D/g, '');
                                if (value.length > 11) value = value.substring(0, 11);

                                if (value.length > 10) {
                                    value = value.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                                } else if (value.length > 5) {
                                    value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                                } else if (value.length > 2) {
                                    value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
                                } else {
                                    value = value.replace(/^(\d*)/, '($1');
                                }
                                input.value = value;
                            }

                            document.addEventListener("DOMContentLoaded", function () {
                                const raw = document.getElementById('rawPhone').value;
                                const ddiSelect = document.getElementById('inputDDI');
                                const phoneInput = document.getElementById('inputPhoneNumber');

                                if (raw) {
                                    let matchedDDI = false;
                                    for (let opt of ddiSelect.options) {
                                        if (raw.startsWith(opt.value)) {
                                            ddiSelect.value = opt.value;
                                            let num = raw.substring(opt.value.length);
                                            phoneInput.value = num;
                                            maskPhone(phoneInput);
                                            matchedDDI = true;
                                            break;
                                        }
                                    }
                                    if (!matchedDDI) {
                                        phoneInput.value = raw;
                                        maskPhone(phoneInput);
                                    }
                                }
                            });
                        </script>

                        <!-- Read-only / System Fields -->
                        <div class="pt-2 border-t border-gray-100 grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Criado em</label>
                                <div class="text-sm font-medium text-gray-900">{{ lead.created_at.strftime('%d/%m/%Y')
                                    }}</div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Responsável</label>
                                <select name="assigned_to_id"
                                    class="w-full bg-gray-50 border border-gray-200 rounded text-xs px-2 py-1 outline-none focus:border-northway-red text-gray-700">
                                    <option value="none">Não atribuído</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}" {{ 'selected' if lead.assigned_to_id==user.id else ''
                                        }}>
                                        {{ user.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="flex justify-end pt-2">
                            <button type="submit"
                                class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-northway-red hover:border-northway-red px-4 py-1.5 rounded text-xs font-bold transition-colors uppercase tracking-wide">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>

                <!-- BANT Qualification Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3
                        class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                        <span class="bg-northway-red text-white text-[10px] px-1.5 py-0.5 rounded">BANT</span>
                        Qualificação
                    </h3>

                    <form action="{{ url_for('leads.update_bant', id=lead.id) }}" method="POST" class="space-y-4">
                        <!-- Budget -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Budget</label>
                            <input type="text" name="bant_budget" value="{{ lead.bant_budget or '' }}"
                                placeholder="R$..."
                                class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red transition-colors">
                        </div>

                        <!-- Authority -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Authority</label>
                            <select name="bant_authority"
                                class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red bg-white transition-colors">
                                <option value="" {{ 'selected' if not lead.bant_authority }}>Selecione...
                                </option>
                                <option value="Decisor" {{ 'selected' if lead.bant_authority=='Decisor' }}>
                                    Decisor
                                </option>
                                <option value="Influenciador" {{ 'selected' if lead.bant_authority=='Influenciador' }}>
                                    Influenciador</option>
                                <option value="Usuário" {{ 'selected' if lead.bant_authority=='Usuário' }}>
                                    Usuário
                                </option>
                                <option value="Sem poder" {{ 'selected' if lead.bant_authority=='Sem poder' }}>
                                    Sem
                                    poder
                                </option>
                            </select>
                        </div>

                        <!-- Timeline -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Timeline</label>
                            <select name="bant_timeline"
                                class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red bg-white transition-colors">
                                <option value="" {{ 'selected' if not lead.bant_timeline }}>Selecione...
                                </option>
                                <option value="Imediato" {{ 'selected' if lead.bant_timeline=='Imediato' }}>
                                    Imediato
                                </option>
                                <option value="Curto Prazo" {{ 'selected' if lead.bant_timeline=='Curto Prazo' }}>
                                    Curto
                                    Prazo</option>
                                <option value="Médio Prazo" {{ 'selected' if lead.bant_timeline=='Médio Prazo' }}>
                                    Médio
                                    Prazo</option>
                                <option value="Longo Prazo" {{ 'selected' if lead.bant_timeline=='Longo Prazo' }}>
                                    Longo
                                    Prazo</option>
                            </select>
                        </div>

                        <!-- Need -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Need</label>
                            <textarea name="bant_need" rows="3" placeholder="Necessidade..."
                                class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none focus:border-northway-red resize-none transition-colors">{{ lead.bant_need or '' }}</textarea>
                        </div>

                        <button type="submit"
                            class="w-full bg-gray-50 text-gray-700 font-bold py-2 rounded hover:bg-northway-red hover:text-white transition-colors text-sm border border-gray-200 hover:border-northway-red">
                            Salvar Qualificação
                        </button>
                    </form>
                </div>

                <!-- Related Tasks -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wider">Tarefas
                                Pendentes
                            </h3>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="w-24 bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                    <div id="task-progress-bar" class="bg-green-500 h-1.5 rounded-full"
                                        data-width="{{ lead.task_progress.percent }}"></div>
                                    <script>
                                        document.addEventListener("DOMContentLoaded", function () {
                                            const bar = document.getElementById('task-progress-bar');
                                            if (bar) bar.style.width = bar.dataset.width + '%';
                                        });
                                    </script>
                                </div>
                                <span class="text-[10px] text-gray-500 font-medium">{{
                                    lead.task_progress.completed
                                    }}/{{ lead.task_progress.total }}</span>
                            </div>
                        </div>
                        <button onclick="toggleModal('createTaskModal')"
                            class="text-northway-red hover:text-red-700 text-xs font-bold flex items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> Nova
                        </button>
                    </div>
                    <ul class="divide-y divide-gray-100">
                        {% for task in lead.tasks %}
                        <li class="py-3 flex items-center gap-3 group">
                            <form action="{{ url_for('tasks.toggle_task', id=task.id) }}" method="POST">
                                <button type="submit"
                                    class="w-4 h-4 border-2 border-gray-300 rounded hover:border-northway-red transition-colors flex items-center justify-center">
                                    {% if task.status == 'concluida' %}
                                    <span class="block w-2.5 h-2.5 bg-northway-red rounded-sm"></span>
                                    {% endif %}
                                </button>
                            </form>

                            <span
                                class="text-sm flex-1 {{ 'line-through text-gray-400' if task.status == 'concluida' else 'text-gray-700' }}">
                                {{ task.title }}
                            </span>

                            <span class="text-xs text-gray-400">
                                {{ task.due_date.strftime('%d/%m') if task.due_date else '' }}
                            </span>

                            {% if current_user.role == 'admin' %}
                            <form action="{{ url_for('tasks.delete_task', id=task.id) }}" method="POST"
                                onsubmit="return confirm('Excluir tarefa?');">
                                <button type="submit"
                                    class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </form>
                            {% endif %}
                        </li>
                        {% else %}
                        <li class="text-xs text-gray-400 italic py-2">Nenhuma tarefa.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-900">Nova Tarefa</h3>
                <button onclick="toggleModal('createTaskModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form action="{{ url_for('tasks.tasks') }}" method="POST" class="p-6 space-y-4">
                <input type="hidden" name="lead_id" value="{{ lead.id }}">
                <input type="hidden" name="next" value="{{ url_for('leads.lead_details', id=lead.id) }}">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" name="title" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data e Hora de Vencimento</label>
                    <input type="datetime-local" name="due_date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleModal('createTaskModal')"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-northway-red text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        Salvar Tarefa
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Convert Lead Modal -->
<div id="convertModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Converter Lead em Cliente</h3>
            <button onclick="toggleModal('convertModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <form action="{{ url_for('leads.convert_lead', id=lead.id) }}" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Serviço Contratado</label>
                <input type="text" name="service" placeholder="Ex: Consultoria mensal, Projeto Website"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Mensal (R$)</label>
                    <input type="text" name="monthly_value" placeholder="R$ 0,00" oninput="formatCurrency(this)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Contrato</label>
                    <select name="contract_type"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red bg-white">
                        <option value="mensal">Mensal</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                        <option value="pontual">Pontual</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label>
                <input type="date" name="start_date" value="{{ today_date }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-northway-red/20 focus:border-northway-red">
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button" onclick="toggleModal('convertModal')"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-[#fa0102] text-white rounded-lg hover:bg-red-700 transition-colors font-bold shadow-md">
                    Confirmar Conversão
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Enrichment Search Modal -->
<div id="enrichmentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Buscar Empresa / CNPJ</h3>
            <button onclick="toggleModal('enrichmentModal')" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-6 space-y-4">
            <div class="flex gap-2">
                <input type="text" id="enrichmentSearchInput" placeholder="Nome da empresa ou CNPJ"
                    value="{{ lead.name }}"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-600">
                <button onclick="handleEnrichmentSearch()" id="btnDoEnrichmentSearch"
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 transition-colors">
                    Buscar
                </button>
            </div>

            <div id="enrichmentResults" class="max-h-64 overflow-y-auto space-y-2">
                <!-- Results will appear here -->
                <p class="text-center text-gray-400 text-sm py-8">Digite o nome da empresa ou CNPJ acima para buscar.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2) + '';
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        input.value = "R$ " + value;
    }

    // --- Tab Logic ---
    const pageLeadId = parseInt("{{ lead.id }}");
    let pagePollingInterval = null;

    function switchPageTab(tabName) {
        const detailsTab = document.getElementById('tab-page-details');
        const whatsappTab = document.getElementById('tab-page-whatsapp');
        const enrichmentTab = document.getElementById('tab-page-enrichment');

        const contentDetails = document.getElementById('content-page-details');
        const contentWhatsapp = document.getElementById('content-page-whatsapp');
        const contentEnrichment = document.getElementById('content-page-enrichment');

        // Reset tabs
        [detailsTab, whatsappTab, enrichmentTab].forEach(t => {
            if (t) {
                t.classList.remove('text-northway-red', 'border-northway-red', 'text-green-600', 'border-green-600', 'text-purple-600', 'border-purple-600');
                t.classList.add('text-gray-500', 'border-transparent');
            }
        });

        // Reset content
        [contentDetails, contentWhatsapp, contentEnrichment].forEach(c => {
            if (c) c.classList.add('hidden');
        });

        if (tabName === 'details') {
            detailsTab.classList.add('text-northway-red', 'border-northway-red');
            detailsTab.classList.remove('text-gray-500', 'border-transparent');
            contentDetails.classList.remove('hidden');
            if (pagePollingInterval) clearInterval(pagePollingInterval);
        } else if (tabName === 'whatsapp') {
            whatsappTab.classList.add('text-green-600', 'border-green-600');
            whatsappTab.classList.remove('text-gray-500', 'border-transparent');
            contentWhatsapp.classList.remove('hidden');
            loadPageWhatsAppMessages();
            if (pagePollingInterval) clearInterval(pagePollingInterval);
            pagePollingInterval = setInterval(() => loadPageWhatsAppMessages(true), 5000);
        } else if (tabName === 'enrichment') {
            enrichmentTab.classList.add('text-purple-600', 'border-purple-600');
            enrichmentTab.classList.remove('text-gray-500', 'border-transparent');
            contentEnrichment.classList.remove('hidden');
            if (pagePollingInterval) clearInterval(pagePollingInterval);
        }
    }

    // --- ENRICHMENT LOGIC ---
    function openEnrichmentSearch() {
        toggleModal('enrichmentModal');
    }

    async function handleEnrichmentSearch() {
        const query = document.getElementById('enrichmentSearchInput').value.trim();
        if (!query) return;

        const resultsContainer = document.getElementById('enrichmentResults');
        const btn = document.getElementById('btnDoEnrichmentSearch');

        resultsContainer.innerHTML = '<div class="flex justify-center py-8"><div class="animate-spin h-8 w-8 border-4 border-purple-600 rounded-full border-t-transparent"></div></div>';
        btn.disabled = true;

        try {
            const res = await fetch(`/api/leads/search-cnpj?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            if (!data.success) {
                resultsContainer.innerHTML = `<p class="text-center text-red-500 py-8">${data.error || 'Erro na busca'}</p>`;
                return;
            }

            const results = data.data; // CNPJA returns a list or direct object
            const companies = Array.isArray(results) ? results : (results.tax_id ? [results] : []);

            if (companies.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma empresa encontrada.</p>';
            } else {
                resultsContainer.innerHTML = companies.map(c => `
                    <div class="p-4 border border-gray-100 rounded-lg hover:bg-purple-50 transition-colors cursor-pointer group" onclick="confirmEnrichment('${c.tax_id}', '${c.name.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-gray-900 group-hover:text-purple-600">${c.name}</h4>
                                <p class="text-xs text-gray-500 mt-0.5">${c.tax_id} &bull; ${c.alias || ''}</p>
                                <p class="text-[10px] text-gray-400 mt-1">${c.address ? c.address.city + '/' + c.address.state : ''}</p>
                            </div>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500 uppercase">${(c.status || {}).text || c.status || 'N/A'}</span>
                        </div>
                    </div>
                `).join('');
            }
        } catch (e) {
            resultsContainer.innerHTML = `<p class="text-center text-red-500 py-8">Erro: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
        }
    }

    async function confirmEnrichment(cnpj, name) {
        if (!confirm(`Deseja enriquecer este lead com os dados de "${name}"?`)) return;

        const resultsContainer = document.getElementById('enrichmentResults');
        resultsContainer.innerHTML = '<div class="flex justify-center py-8"><div class="animate-spin h-8 w-8 border-4 border-purple-600 rounded-full border-t-transparent"></div></div>';

        try {
            const res = await fetch(`/api/leads/${pageLeadId}/enrich`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cnpj: cnpj })
            });
            const data = await res.json();

            if (data.success) {
                alert('Lead enriquecido com sucesso!');
                window.location.reload();
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        } catch (e) {
            alert('Erro ao enriquecer: ' + e.message);
            handleEnrichmentSearch(); // Refresh results
        }
    }

    async function loadPageWhatsAppMessages(silent = false) {
        const container = document.getElementById('page-chat-messages');
        if (!silent) container.innerHTML = `<div class="flex justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-northway-red"></div></div>`;

        try {
            const response = await fetch(`/api/whatsapp/lead/${pageLeadId}/messages`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            if (data.messages.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                        <i data-lucide="message-square" class="w-10 h-10 mb-2 opacity-50"></i>
                        <p class="text-sm">Nenhuma mensagem ainda.</p>
                        <p class="text-xs">Inicie a conversa abaixo.</p>
                    </div>
                 `;
            } else {
                let lastDate = null;
                const messagesHtml = data.messages.map(msg => {
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = msgDate.toLocaleDateString('pt-BR');
                    let dateHeader = '';

                    if (dateStr !== lastDate) {
                        lastDate = dateStr;
                        dateHeader = `
                            <div class="flex justify-center my-4">
                                <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-1 rounded shadow-sm font-medium">
                                    ${dateStr}
                                </span>
                            </div>`;
                    }

                    return `
                    ${dateHeader}
                    <div class="flex ${msg.direction === 'out' ? 'justify-end' : 'justify-start'} mb-2 group px-2">
                        <div class="max-w-[75%] rounded-2xl px-4 py-2 text-sm shadow-sm relative leading-relaxed ${msg.direction === 'out'
                            ? 'bg-northway-red text-white rounded-tr-none shadow-md'
                            : 'bg-white text-gray-900 rounded-tl-none shadow-md'
                        }">
                            <p class="mb-1">${msg.content}</p>
                            <div class="flex justify-end items-center gap-1 -mt-0.5">
                                <span class="text-[10px] text-gray-500">${msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                ${msg.direction === 'out' ?
                            (msg.status === 'read' ? '<i data-lucide="check-check" class="w-3 h-3 text-[#53bdeb]"></i>' :
                                msg.status === 'delivered' ? '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>' :
                                    '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>')
                            : ''}
                            </div>
                            
                        </div>
                    </div>
                `}).join('');
                container.innerHTML = messagesHtml;

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            if (window.lucide) lucide.createIcons();

        } catch (e) {
            container.innerHTML = `<p class="text-center text-red-500 text-xs">Erro ao carregar: ${e.message}</p>`;
        }
    }

    // --- MEDIA & PORTED LOGIC ---
    const activeChat = { type: 'lead', id: pageLeadId };

    function loadMessages(type, id) {
        // Wrapper for existing loader
        return loadPageWhatsAppMessages(true);
    }

    // Media Vars
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimer = null;
    let selectedFile = null;

    // UI Toggles
    const inputArea = document.getElementById('message-input');
    const btnMic = document.getElementById('btn-mic');
    const btnSend = document.getElementById('btn-send');

    // Auto-switch Mic/Send icon
    if (inputArea) {
        inputArea.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                btnMic.classList.add('hidden');
                btnSend.classList.remove('hidden');
            } else {
                btnMic.classList.remove('hidden');
                btnSend.classList.add('hidden');
            }
        });

        // Handle Enter
        inputArea.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // Toggle Attach Menu
    function toggleAttachMenu() {
        const menu = document.getElementById('attach-menu');
        menu.classList.toggle('hidden');
    }

    // Recording Logic
    async function toggleRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return alert('Seu navegador não suporta gravação de áudio.');
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.start();

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex'); // Important for flex layout
            document.getElementById('toolbar-recording').classList.remove('hidden');
            document.getElementById('toolbar-recording').classList.add('flex');

            // Timer
            let seconds = 0;
            const timerEl = document.getElementById('recording-time');
            timerEl.textContent = "0:00";
            if (recordingTimer) clearInterval(recordingTimer);
            recordingTimer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);

        } catch (err) {
            console.error(err);
            alert('Permissão de microfone negada ou erro ao iniciar.');
        }
    }

    function cancelRecording() {
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
        clearInterval(recordingTimer);
        resetToolbar();
    }

    function stopAndSendRecording() {
        if (!mediaRecorder) return;

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await uploadMedia(audioBlob, 'audio.webm', 'audio');
            resetToolbar();
        };

        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        clearInterval(recordingTimer);
    }

    // File Logic
    function triggerFile(accept) {
        const input = document.getElementById('file-input');
        input.accept = accept;
        input.click();
        document.getElementById('attach-menu').classList.add('hidden');
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            selectedFile = input.files[0];

            // UI Switch
            document.getElementById('toolbar-default').classList.add('hidden');
            document.getElementById('toolbar-default').classList.remove('flex');
            document.getElementById('toolbar-file').classList.remove('hidden');
            document.getElementById('toolbar-file').classList.add('flex');
            document.getElementById('file-name').textContent = selectedFile.name;
        }
    }

    function cancelFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        resetToolbar();
    }

    async function sendFile() {
        if (!selectedFile) return;
        await uploadMedia(selectedFile, selectedFile.name, 'file');
        cancelFile();
    }

    function resetToolbar() {
        document.getElementById('toolbar-default').classList.remove('hidden');
        document.getElementById('toolbar-default').classList.add('flex');

        document.getElementById('toolbar-recording').classList.add('hidden');
        document.getElementById('toolbar-recording').classList.remove('flex');

        document.getElementById('toolbar-file').classList.add('hidden');
        document.getElementById('toolbar-file').classList.remove('flex');
    }

    async function uploadMedia(file, filename, type) {
        // Optimistic Loading? Maybe later.
        const btn = document.getElementById('btn-attach'); // just a visual anchor
        const originalHtml = btn.innerHTML;
        btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-gray-500 rounded-full border-t-transparent"></div>`;

        try {
            const formData = new FormData();
            formData.append('file', file, filename);
            formData.append('lead_id', pageLeadId); // Explicitly use pageLeadId
            formData.append('type', type);

            const res = await fetch('/api/whatsapp/send-media', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            loadPageWhatsAppMessages();
        } catch (e) {
            alert('Erro ao enviar mídia: ' + e.message);
        } finally {
            btn.innerHTML = originalHtml;
        }
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;

        input.value = '';
        input.focus();

        // Reset toggle
        btnMic.classList.remove('hidden');
        btnSend.classList.add('hidden');

        try {
            const response = await fetch('/api/whatsapp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lead_id: pageLeadId, content: content })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            loadPageWhatsAppMessages();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    }

    // Rich Text Helper (Standardized)
    function insertFormat(char) {
        const input = document.getElementById('message-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const txt = input.value;

        if (start === end) {
            input.value = txt.substring(0, start) + char + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + char.length;
        } else {
            const wrapped = char + txt.substring(start, end) + char;
            input.value = txt.substring(0, start) + wrapped + txt.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = end + (char.length * 2);
        }

        // Trigger input event to update mic/send
        input.dispatchEvent(new Event('input'));
    }

    // Add enter key support (Shift+Enter for newline)
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById('pageWhatsappInput');
        if (input) {
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPageWhatsAppMessage();
                }
            });
        }
    });
</script>
{% endblock %}